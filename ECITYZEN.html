<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>e-cityzen Gabon - Version Compl√®te D√©finitive</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --gabon-green: #00A859;
            --gabon-yellow: #FCD116;
            --gabon-blue: #3E75C4;
            --primary: #00A859;
            --primary-dark: #008045;
            --secondary: #FCD116;
            --accent: #3E75C4;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --info: #3B82F6;
            --light: #F8FAFC;
            --dark: #1E293B;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .gabon-gradient {
            background: linear-gradient(135deg, var(--gabon-green) 0%, var(--gabon-yellow) 50%, var(--gabon-blue) 100%);
        }
        
        .btn-gabon {
            background: linear-gradient(135deg, var(--gabon-green), var(--gabon-yellow));
            color: white;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(0, 168, 89, 0.3);
        }
        
        .btn-gabon:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 168, 89, 0.4);
        }
        
        .btn-gabon:active {
            transform: translateY(-1px) scale(0.98);
        }
        
        .mobile-view {
            max-width: 100%;
            width: 100%;
            margin: 0;
        }
        
        .web-view {
            width: 100%;
            max-width: 100%;
            min-width: auto;
        }
        
        /* Responsive g√©n√©ral */
        @media (max-width: 1024px) {
            .web-view {
                padding: 15px;
            }
        }
        
        @media (max-width: 768px) {
            .mobile-view, .web-view {
                padding: 10px;
            }
        }
        
        @media (max-width: 640px) {
            .mobile-view, .web-view {
                padding: 8px;
            }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            font-size: 14px;
            transform: translateX(450px);
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            min-width: 300px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, var(--success), #059669);
        }
        
        .notification.error {
            background: linear-gradient(135deg, var(--danger), #DC2626);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, var(--warning), #D97706);
        }
        
        .notification.info {
            background: linear-gradient(135deg, var(--info), #2563EB);
        }
        
        .logo-container {
            width: 140px;
            height: 140px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
            box-shadow: 0 20px 60px rgba(0, 168, 89, 0.3), 0 0 0 4px rgba(255,255,255,0.5);
            padding: 20px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .logo-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            transform: rotate(45deg);
            transition: all 0.6s;
        }
        
        .logo-container:hover::before {
            left: 100%;
        }
        
        .logo-container:hover {
            transform: scale(1.08) rotate(5deg);
            box-shadow: 0 25px 70px rgba(0, 168, 89, 0.4), 0 0 0 6px rgba(255,255,255,0.6);
        }
        
        .logo-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 50%;
            position: relative;
            z-index: 1;
        }
        
        .logo-small {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            border: 3px solid white;
            transition: all 0.3s ease;
        }
        
        .logo-small:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        
        .fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(-20px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
        
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }
        
        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-20px);
            }
        }
        
        @keyframes glow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(0, 168, 89, 0.3);
            }
            50% {
                box-shadow: 0 0 40px rgba(0, 168, 89, 0.6);
            }
        }
        
        @keyframes gradient-shift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }
        
        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        
        @keyframes scale-in {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        @keyframes slide-in-right {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .animated-gradient {
            background: linear-gradient(-45deg, #00A859, #FCD116, #3E75C4, #00A859);
            background-size: 400% 400%;
            animation: gradient-shift 15s ease infinite;
        }
        
        .float-animation {
            animation: float 6s ease-in-out infinite;
        }
        
        .glow-effect {
            animation: glow 2s ease-in-out infinite;
        }
        
        .particle-bg {
            position: relative;
            overflow: hidden;
        }
        
        .particle-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(0, 168, 89, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(252, 209, 22, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(62, 117, 196, 0.1) 0%, transparent 50%);
            animation: float 20s ease-in-out infinite;
            pointer-events: none;
        }
        
        .card-3d {
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-3d:hover {
            transform: rotateY(5deg) rotateX(5deg) translateZ(20px);
        }
        
        .text-gradient-animated {
            background: linear-gradient(90deg, #00A859, #FCD116, #3E75C4, #00A859);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradient-shift 3s ease infinite;
        }
        
        .icon-bounce {
            display: inline-block;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }
        
        .ripple-effect {
            position: relative;
            overflow: hidden;
        }
        
        .ripple-effect::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .ripple-effect:active::after {
            width: 300px;
            height: 300px;
        }
        
        .skeleton-loader {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        .neon-glow {
            box-shadow: 
                0 0 10px rgba(0, 168, 89, 0.5),
                0 0 20px rgba(0, 168, 89, 0.3),
                0 0 30px rgba(0, 168, 89, 0.2);
        }
        
        .neon-glow:hover {
            box-shadow: 
                0 0 20px rgba(0, 168, 89, 0.8),
                0 0 40px rgba(0, 168, 89, 0.5),
                0 0 60px rgba(0, 168, 89, 0.3);
        }
        
        .magnetic-effect {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .magnetic-effect:hover {
            transform: scale(1.05);
        }
        
        .parallax-bg {
            background-attachment: fixed;
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
        }
        
        .glassmorphism-advanced {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .hover-lift {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .hover-lift:hover {
            transform: translateY(-12px) scale(1.03);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        }
        
        .pulse-ring {
            position: relative;
        }
        
        .pulse-ring::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid rgba(0, 168, 89, 0.5);
            transform: translate(-50%, -50%) scale(1);
            animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse-ring {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.5);
                opacity: 0;
            }
        }
        
        .text-shimmer {
            background: linear-gradient(90deg, #000 0%, #fff 50%, #000 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shimmer 3s linear infinite;
        }
        
        .morphing-blob {
            border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
            animation: morph 8s ease-in-out infinite;
        }
        
        @keyframes morph {
            0%, 100% {
                border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
            }
            50% {
                border-radius: 30% 60% 70% 40% / 50% 60% 30% 60%;
            }
        }
        
        .stagger-animation {
            animation: fadeInUp 0.6s ease forwards;
            opacity: 0;
        }
        
        .stagger-animation:nth-child(1) { animation-delay: 0.1s; }
        .stagger-animation:nth-child(2) { animation-delay: 0.2s; }
        .stagger-animation:nth-child(3) { animation-delay: 0.3s; }
        .stagger-animation:nth-child(4) { animation-delay: 0.4s; }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .glow-text {
            text-shadow: 
                0 0 10px rgba(0, 168, 89, 0.5),
                0 0 20px rgba(0, 168, 89, 0.3),
                0 0 30px rgba(0, 168, 89, 0.2);
        }
        
        .tilt-effect {
            transition: transform 0.3s ease;
        }
        
        .tilt-effect:hover {
            transform: perspective(1000px) rotateX(5deg) rotateY(5deg);
        }
        
        .loading-dots::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% {
                content: '.';
            }
            40% {
                content: '..';
            }
            60%, 100% {
                content: '...';
            }
        }
        
        .gradient-border {
            position: relative;
            background: white;
            border-radius: 16px;
        }
        
        .gradient-border::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 16px;
            padding: 2px;
            background: linear-gradient(135deg, #00A859, #FCD116, #3E75C4);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
        }
        
        .wave-animation {
            position: relative;
            overflow: hidden;
        }
        
        .wave-animation::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: wave 3s infinite;
        }
        
        @keyframes wave {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }
        
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(0, 168, 89, 0.5);
            border-radius: 50%;
            animation: particle-float 10s infinite;
        }
        
        @keyframes particle-float {
            0% {
                transform: translateY(0) translateX(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) translateX(100px);
                opacity: 0;
            }
        }
        
        .card-hover {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            border-radius: 16px;
            position: relative;
            overflow: hidden;
        }
        
        .card-hover::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }
        
        .card-hover:hover::before {
            left: 100%;
        }
        
        .card-hover:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12), 0 0 0 1px rgba(0, 168, 89, 0.1);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .btn-animated {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .btn-animated::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.4);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-animated:hover::before {
            width: 400px;
            height: 400px;
        }
        
        .btn-animated:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9));
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0, 168, 89, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, rgba(0, 168, 89, 0.1), transparent);
            border-radius: 50%;
            transform: translate(30%, -30%);
        }
        
        .stat-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 30px rgba(0, 168, 89, 0.15);
            border-color: rgba(0, 168, 89, 0.3);
        }
        
        .stat-card .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--gabon-green), var(--gabon-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
        }
        
        .action-btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 20px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(0, 168, 89, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .action-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .action-btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 168, 89, 0.4);
        }
        
        .action-btn:active {
            transform: translateY(-1px);
        }
        
        .action-btn i {
            font-size: 20px;
            margin-bottom: 8px;
            display: block;
        }
        
        .action-btn-modern {
            position: relative;
            overflow: visible;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 100px;
        }
        
        .action-btn-modern::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
            z-index: 0;
        }
        
        .action-btn-modern:hover::after {
            width: 300px;
            height: 300px;
        }
        
        .action-btn-modern > * {
            position: relative;
            z-index: 1;
        }
        
        .stat-card-modern {
            background: linear-gradient(135deg, rgba(255,255,255,0.98), rgba(255,255,255,0.95));
            border-radius: 20px;
            padding: 28px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0, 168, 89, 0.15);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card-modern::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0, 168, 89, 0.05), transparent);
            transition: all 0.6s;
        }
        
        .stat-card-modern:hover::before {
            top: -30%;
            right: -30%;
        }
        
        .stat-card-modern:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 40px rgba(0, 168, 89, 0.2);
            border-color: rgba(0, 168, 89, 0.3);
        }
        
        .stat-value-modern {
            font-size: 2.75rem;
            font-weight: 800;
            background: linear-gradient(135deg, #00A859, #3E75C4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.1;
            letter-spacing: -0.02em;
        }
        
        @media (max-width: 768px) {
            .stat-value-modern {
                font-size: 2rem;
            }
        }
        
        @media (max-width: 640px) {
            .stat-value-modern {
                font-size: 1.75rem;
            }
        }
        
        .stat-label-modern {
            font-size: 0.875rem;
            color: #6B7280;
            font-weight: 500;
            margin-top: 8px;
        }
        
        .card-modern {
            background: white;
            border-radius: 18px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        @media (max-width: 768px) {
            .card-modern {
                padding: 16px;
                border-radius: 12px;
            }
        }
        
        @media (max-width: 640px) {
            .card-modern {
                padding: 12px;
                border-radius: 10px;
            }
        }
        
        .card-modern:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
            border-color: rgba(0, 168, 89, 0.2);
        }
        
        .chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 380px;
            height: 550px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: none;
            flex-direction: column;
            z-index: 1000;
            overflow: hidden;
            animation: slideInUp 0.4s ease;
        }
        
        .modal-overlay {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            background: white;
            border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            animation: slideInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }
        
        .badge-warning {
            background: linear-gradient(135deg, var(--warning), #D97706);
            color: white;
        }
        
        .badge-danger {
            background: linear-gradient(135deg, var(--danger), #DC2626);
            color: white;
        }
        
        .badge-info {
            background: linear-gradient(135deg, var(--info), #2563EB);
            color: white;
        }
        
        .badge-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }
        
        .input-modern {
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            padding: 12px 16px;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .input-modern:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0, 168, 89, 0.1);
        }
        
        .select-modern {
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            padding: 12px 16px;
            transition: all 0.3s ease;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }
        
        .select-modern:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0, 168, 89, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 168, 89, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 168, 89, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--gray-500), var(--gray-600));
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        
        .header-gradient {
            background: linear-gradient(135deg, var(--gabon-green) 0%, var(--gabon-yellow) 50%, var(--gabon-blue) 100%);
            box-shadow: 0 4px 20px rgba(0, 168, 89, 0.3);
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--gabon-green), var(--gabon-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1.5rem;
        }
        
        .loading-spinner {
            border: 3px solid rgba(0, 168, 89, 0.1);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .chat-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gabon-green);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        .chat-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }
        
        .chat-toggle:active {
            transform: scale(0.95);
        }
        
        .map-container {
            height: 300px;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e5e7eb;
            position: relative;
            background-color: #f3f4f6;
        }
        
        .map-container:empty::before {
            content: 'Chargement de la carte...';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #6b7280;
            font-size: 14px;
        }
        
        .map-container-small {
            height: 250px;
        }
        
        #signalementModal {
            padding-top: 80px;
            align-items: flex-start;
        }
        
        #signalementModal > div {
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            margin-top: 0;
        }
        
        #signalementModal .map-container {
            height: 180px !important;
            min-height: 180px !important;
            width: 100% !important;
            display: block !important;
            visibility: visible !important;
        }
        
        @media (max-width: 640px) {
            #signalementModal {
                padding-top: 70px;
            }
            
            #signalementModal .map-container {
                height: 150px;
            }
            
            #signalementModal > div {
                max-width: 95vw;
                max-height: calc(100vh - 90px);
            }
        }
        
        .leaflet-container {
            height: 100%;
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .web-view {
                min-width: auto;
                padding: 10px;
            }
            
            .chat-container {
                width: 90%;
                right: 5%;
                bottom: 90px;
                height: 70%;
            }
            
            .logo-container {
                width: 100px;
                height: 100px;
            }
            
            .logo-small {
                width: 40px;
                height: 40px;
            }
            
            /* Grilles adaptatives */
            .grid-cols-2 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
            
            .grid-cols-3 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
            
            /* Actions rapides - 1 colonne sur mobile */
            #citoyenDashboard .grid-cols-2,
            #commercantDashboard .grid-cols-2,
            #hopitalDashboard .grid-cols-2 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
            
            /* Modales responsive */
            .max-w-4xl, .max-w-6xl, .max-w-2xl {
                max-width: 95vw;
                margin: 10px;
            }
            
            /* Statistiques en une colonne */
            .stat-card-modern {
                padding: 16px;
            }
        }
        
        @media (max-width: 640px) {
            /* Actions rapides - texte plus petit */
            .action-btn-modern {
                padding: 12px;
                font-size: 11px;
                min-height: 80px;
            }
            
            .action-btn-modern .text-2xl {
                font-size: 1.25rem;
            }
            
            /* Cartes plus compactes */
            .card-modern {
                padding: 12px;
            }
            
            /* Header plus compact */
            .bg-green-500, .bg-yellow-500, .bg-red-500, .bg-blue-500 {
                padding: 12px;
            }
            
            /* Modales full screen sur tr√®s petit √©cran */
            .max-w-4xl, .max-w-6xl, .max-w-2xl, .max-w-md {
                max-width: 100vw;
                max-height: 100vh;
                margin: 0;
                border-radius: 0;
            }
            
            /* Textes plus petits */
            h1 { font-size: 1.5rem; }
            h2 { font-size: 1.25rem; }
            .text-2xl { font-size: 1.5rem; }
            .text-xl { font-size: 1.125rem; }
            .text-lg { font-size: 1rem; }
            
            /* Tableaux scrollables */
            table {
                font-size: 0.875rem;
            }
            
            /* Espacements r√©duits */
            .space-y-4 > * + * {
                margin-top: 0.75rem;
            }
            
            .gap-4 {
                gap: 0.75rem;
            }
            
            .gap-6 {
                gap: 1rem;
            }
            
            /* Padding r√©duit */
            .p-6 {
                padding: 1rem;
            }
            
            .p-4 {
                padding: 0.75rem;
            }
        }
        
        /* Am√©lioration responsive pour tableaux */
        @media (max-width: 768px) {
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
            }
        }
        
        /* Viewport meta tag pour mobile */
        @media (max-width: 640px) {
            body {
                font-size: 14px;
            }
            
            /* Boutons plus grands pour le tactile */
            button, .btn-gabon, .action-btn-modern {
                min-height: 44px;
                min-width: 44px;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Page de Connexion/Inscription -->
    <div id="loginPage" class="min-h-screen gabon-gradient flex items-center justify-center py-8">
        <div class="bg-white rounded-3xl shadow-2xl p-6 md:p-10 max-w-md w-full mx-4 fade-in">
            <div class="text-center mb-8">
                <div class="logo-container mb-4">
                    <img src="https://res.cloudinary.com/dd64mwkl2/image/upload/v1764158267/OIP_1_nn6fy8.webp" alt="e-cityzen Logo" />
                </div>
                <h1 class="text-4xl font-extrabold mb-2" style="color: var(--gabon-green);">e-cityzen</h1>
                <p class="text-gray-600 font-medium">Plateforme de services municipaux du Gabon</p>
                <p class="text-xl font-semibold" style="color: var(--gabon-green);">GABON</p>
                <p class="text-gray-600 mt-2">Services Citoyens & Administration Num√©rique</p>
            </div>
            
            <!-- Onglets Connexion/Inscription -->
            <div class="flex border-b mb-6">
                <button id="tabLogin" onclick="switchTab('login')" class="flex-1 py-3 px-4 text-center font-semibold border-b-2 border-green-600 text-green-600">
                    <i class="fas fa-sign-in-alt mr-2"></i>Connexion
                </button>
                <button id="tabRegister" onclick="switchTab('register')" class="flex-1 py-3 px-4 text-center font-semibold text-gray-500 hover:text-green-600 transition-colors">
                    <i class="fas fa-user-plus mr-2"></i>Inscription
                </button>
            </div>
            
            <!-- Formulaire de Connexion -->
            <div id="loginFormContainer">
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-phone mr-2"></i>Num√©ro de t√©l√©phone
                        </label>
                        <input type="tel" id="loginTelephone" required class="input-modern w-full" placeholder="+241 06 12 34 56">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-lock mr-2"></i>Mot de passe
                        </label>
                        <input type="password" id="loginPassword" required class="input-modern w-full" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    
                    <button type="submit" class="w-full py-4 px-6 rounded-lg btn-gabon text-lg font-semibold btn-animated relative">
                        <i class="fas fa-sign-in-alt mr-2"></i> SE CONNECTER
                </button>
                </form>
                
                <!-- Bouton signalement sans connexion -->
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <p class="text-center text-sm text-gray-600 mb-3">Vous n'avez pas de compte ?</p>
                    <button onclick="showNewSignalement()" class="w-full py-3 px-6 rounded-lg text-white text-base font-semibold transition-all duration-300 hover:shadow-lg" style="background-color: var(--gabon-green);">
                        <i class="fas fa-exclamation-triangle mr-2"></i> Faire un signalement sans connexion
                    </button>
                </div>
            </div>
            
            <!-- Formulaire d'Inscription -->
            <div id="registerFormContainer" class="hidden">
                <form id="registerForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user mr-2"></i>Nom
                        </label>
                        <input type="text" id="registerNom" required class="input-modern w-full" placeholder="Votre nom">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user mr-2"></i>Pr√©nom
                        </label>
                        <input type="text" id="registerPrenom" required class="input-modern w-full" placeholder="Votre pr√©nom">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-phone mr-2"></i>Num√©ro de t√©l√©phone
                        </label>
                        <input type="tel" id="registerTelephone" required class="input-modern w-full" placeholder="+241 06 12 34 56">
                        <p class="text-xs text-gray-500 mt-1">Ce num√©ro servira √† vous connecter</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-lock mr-2"></i>Mot de passe
                        </label>
                        <input type="password" id="registerPassword" required minlength="6" class="input-modern w-full" placeholder="Minimum 6 caract√®res">
                        <p class="text-xs text-gray-500 mt-1">Le mot de passe doit contenir au moins 6 caract√®res</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user-tag mr-2"></i>Type de compte
                        </label>
                        <select id="registerRole" required class="input-modern w-full">
                            <option value="">S√©lectionner votre profil...</option>
                            <option value="citoyen">üë§ Citoyen</option>
                            <option value="commercant">üè™ Commer√ßant</option>
                            <option value="hopital">üè• H√¥pital (sur validation)</option>
                            <option value="agent">üõ°Ô∏è Agent (sur validation)</option>
                            <option value="manager">üìä Manager (sur validation)</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Les comptes H√¥pital, Agent et Manager n√©cessitent une validation administrative</p>
                    </div>
                    
                    <div id="registerLocalisationContainer" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-map-marker-alt mr-2"></i>Localisation
                        </label>
                        <div class="mb-2">
                            <div id="registerMap" class="map-container"></div>
                        </div>
                        <input type="text" id="registerLocalisation" readonly class="w-full border rounded-lg p-3 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Adresse compl√®te...">
                        <div id="registerLocationDetails" class="mt-2 space-y-2">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                                <div class="bg-gray-50 p-2 rounded">
                                    <span class="font-semibold text-gray-600">Quartier:</span>
                                    <span id="registerQuartier" class="text-gray-800 ml-1">-</span>
                                </div>
                                <div class="bg-gray-50 p-2 rounded">
                                    <span class="font-semibold text-gray-600">Ville:</span>
                                    <span id="registerVille" class="text-gray-800 ml-1">-</span>
                                </div>
                                <div class="bg-gray-50 p-2 rounded">
                                    <span class="font-semibold text-gray-600">Arrondissement:</span>
                                    <span id="registerArrondissement" class="text-gray-800 ml-1">-</span>
                                </div>
                                <div class="bg-gray-50 p-2 rounded">
                                    <span class="font-semibold text-gray-600">Coordonn√©es:</span>
                                    <span id="registerCoords" class="text-gray-800 ml-1">-</span>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="registerLatitude" value="">
                        <input type="hidden" id="registerLongitude" value="">
                        <p class="text-xs text-gray-500 mt-1">Cliquez sur la carte pour s√©lectionner votre localisation exacte</p>
                    </div>
                    
                    <div id="registerEntrepriseContainer" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-building mr-2"></i>Entreprise (optionnel)
                        </label>
                        <input type="text" id="registerEntreprise" class="input-modern w-full" placeholder="Nom de votre entreprise">
                    </div>
                    
                    <button type="submit" class="w-full py-4 px-6 rounded-lg btn-gabon text-lg font-semibold btn-animated relative">
                        <i class="fas fa-user-plus mr-2"></i> CR√âER MON COMPTE
                </button>
                </form>
            </div>
            
            <div class="mt-8 text-center text-sm text-gray-500">
                <p>üá¨üá¶ R√©publique Gabonaise</p>
                <p>Version 2025</p>
            </div>
        </div>
    </div>

    <!-- Ruban d'information en haut -->
    <div id="infoRibbon" class="hidden fixed top-0 left-0 right-0 bg-white border-b border-gray-200 shadow-sm z-40">
        <div class="container mx-auto px-4 py-2">
            <div class="flex flex-wrap items-center justify-center gap-6 text-sm">
                <div class="flex items-center gap-2 cursor-pointer hover:opacity-80 transition-opacity px-3 py-1 rounded hover:bg-gray-50" onclick="showTravauxPublics()">
                    <i class="fas fa-hard-hat" style="color: var(--gabon-green);"></i>
                    <span class="text-gray-700 font-medium">Travaux Publics</span>
                    <span id="travauxCount" class="bg-gray-100 text-gray-700 px-2 py-0.5 rounded-full text-xs font-semibold">0</span>
                </div>
                <div class="flex items-center gap-2 cursor-pointer hover:opacity-80 transition-opacity px-3 py-1 rounded hover:bg-gray-50" onclick="showNotifications()">
                    <i class="fas fa-bell" style="color: var(--gabon-yellow);"></i>
                    <span class="text-gray-700 font-medium">Notifications</span>
                    <span id="notificationsCount" class="bg-red-100 text-red-600 px-2 py-0.5 rounded-full text-xs font-semibold">0</span>
                </div>
                <div class="flex items-center gap-2 cursor-pointer hover:opacity-80 transition-opacity px-3 py-1 rounded hover:bg-gray-50" onclick="showFeedback()">
                    <i class="fas fa-comment-dots" style="color: var(--gabon-blue);"></i>
                    <span class="text-gray-700 font-medium">Feedback</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Citoyen -->
    <div id="citoyenDashboard" class="hidden mobile-view" style="padding-top: 60px;">
        <div class="gabon-gradient text-white p-3 md:p-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="https://res.cloudinary.com/dd64mwkl2/image/upload/v1764158267/OIP_1_nn6fy8.webp" alt="Logo" class="logo-small" />
                    <div>
                        <h1 class="text-xl font-bold" id="citoyenGreeting">Bonjour</h1>
                        <p class="text-sm opacity-90" id="citoyenInfo">Chargement...</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="showProfil()" class="text-white hover:opacity-80 transition-opacity" title="Mon profil">
                        <i class="fas fa-user-circle text-xl"></i>
                    </button>
                    <button onclick="showRecherche()" class="text-white hover:opacity-80 transition-opacity" title="Recherche">
                        <i class="fas fa-search text-xl"></i>
                    </button>
                    <button onclick="logout()" class="text-white hover:opacity-80 transition-opacity" title="D√©connexion">
                        <i class="fas fa-sign-out-alt text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="p-4 space-y-4">
            <!-- Statistiques -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="card-modern">
                    <div class="text-2xl font-bold text-green-600" id="citoyenDemandesActives">0</div>
                    <div class="text-sm text-gray-600">Demandes actives</div>
                </div>
                <div class="stat-card-modern">
                    <div class="stat-value-modern" id="citoyenSignalementsActifs">0</div>
                    <div class="stat-label-modern">Signalement suivi</div>
                </div>
            </div>
            
            <!-- Actions rapides -->
            <div class="card-modern">
                <h2 class="font-bold text-lg mb-4">Actions Rapides</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button onclick="showNewSignalement()" class="action-btn-modern text-white p-4 rounded-xl text-sm font-semibold shadow-md hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300" style="background-color: var(--gabon-green);">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i><br>
                        Nouveau Signalement
                    </button>
                    <button onclick="showNewDemande()" class="action-btn-modern text-white p-4 rounded-xl text-sm font-semibold shadow-md hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300" style="background-color: var(--gabon-blue);">
                        <i class="fas fa-file-alt text-2xl mb-2"></i><br>
                        Nouvelle Demande
                    </button>
                    <button onclick="showPaiements()" class="action-btn-modern text-white p-4 rounded-xl text-sm font-semibold shadow-md hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300" style="background-color: var(--gabon-green);">
                        <i class="fas fa-credit-card text-2xl mb-2"></i><br>
                        Mes Paiements
                    </button>
                    <button onclick="showMesDemandes()" class="action-btn-modern text-white p-4 rounded-xl text-sm font-semibold shadow-md hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300" style="background-color: var(--gabon-blue);">
                        <i class="fas fa-folder text-2xl mb-2"></i><br>
                        Mes Demandes
                    </button>
                    <button onclick="showBudgetMunicipal()" class="action-btn-modern text-white p-4 rounded-xl text-sm font-semibold shadow-md hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300" style="background-color: var(--gabon-yellow); color: #1E293B;">
                        <i class="fas fa-chart-pie text-2xl mb-2"></i><br>
                        Budget Municipal
                    </button>
                    <button onclick="showAssistance()" class="action-btn-modern text-white p-4 rounded-xl text-sm font-semibold shadow-md hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300" style="background-color: var(--gabon-green);">
                        <i class="fas fa-headset text-2xl mb-2"></i><br>
                        Assistance
                    </button>
                </div>
            </div>
            
            <!-- Demandes r√©centes -->
            <div class="card-modern">
                <h2 class="font-bold text-lg mb-4">Mes Demandes R√©centes</h2>
                <div class="space-y-3" id="citoyenDemandesListContainer">
                    <p class="text-sm text-gray-500 text-center py-4">Chargement...</p>
                </div>
            </div>
            
            <!-- Signalements -->
            <div class="card-modern">
                <h2 class="font-bold text-lg mb-4">Mes Signalements</h2>
                <div class="space-y-3" id="citoyenSignalementsListContainer">
                    <p class="text-sm text-gray-500 text-center py-4">Chargement...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Commer√ßant -->
    <div id="commercantDashboard" class="hidden mobile-view" style="padding-top: 60px;">
        <div class="bg-yellow-500 text-white p-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="https://res.cloudinary.com/dd64mwkl2/image/upload/v1764158267/OIP_1_nn6fy8.webp" alt="Logo" class="logo-small" />
                    <div>
                        <h1 class="text-xl font-bold">Business Center</h1>
                        <p class="text-sm opacity-90" id="commercantInfo">Chargement...</p>
                    </div>
                </div>
                <button onclick="logout()" class="text-white hover:opacity-80 transition-opacity">
                    <i class="fas fa-sign-out-alt text-xl"></i>
                </button>
            </div>
        </div>
        
        <div class="p-4 space-y-4">
            <!-- Statistiques Business -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white rounded-lg p-4 shadow">
                    <div class="text-2xl font-bold text-green-600" id="commercantPatente">-</div>
                    <div class="text-sm text-gray-600">Patente FCFA</div>
                </div>
                <div class="bg-white rounded-lg p-4 shadow">
                    <div class="text-2xl font-bold text-red-600" id="commercantEcheance">-</div>
                    <div class="text-sm text-gray-600">√âch√©ance restante</div>
                </div>
            </div>
            
            <!-- Gestion Licences -->
            <div class="bg-white rounded-lg p-4 shadow">
                <h2 class="font-bold text-lg mb-4">Mes Licences</h2>
                <div class="space-y-3" id="commercantLicencesList">
                    <p class="text-sm text-gray-500 text-center py-2">Chargement...</p>
                </div>
            </div>
            
            <!-- Paiements -->
            <div class="bg-white rounded-lg p-4 shadow">
                <h2 class="font-bold text-lg mb-4">Paiements √† Effectuer</h2>
                <div class="space-y-3" id="commercantPaiementsList">
                    <p class="text-sm text-gray-500 text-center py-2">Chargement...</p>
                </div>
            </div>
            
            <!-- March√©s -->
            <div class="bg-white rounded-lg p-4 shadow">
                <h2 class="font-bold text-lg mb-4">Mes Emplacements</h2>
                <div class="space-y-3" id="commercantEmplacementsList">
                    <p class="text-sm text-gray-500 text-center py-2">Chargement...</p>
                            </div>
            </div>
        </div>
    </div>

    <!-- Dashboard H√¥pital -->
    <div id="hopitalDashboard" class="hidden mobile-view" style="padding-top: 60px;">
        <div class="bg-red-500 text-white p-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="https://res.cloudinary.com/dd64mwkl2/image/upload/v1764158267/OIP_1_nn6fy8.webp" alt="Logo" class="logo-small" />
                    <div>
                        <h1 class="text-xl font-bold">Centre Hospitalier</h1>
                        <p class="text-sm opacity-90" id="hopitalInfo">Chargement...</p>
                    </div>
                </div>
                <button onclick="logout()" class="text-white hover:opacity-80 transition-opacity">
                    <i class="fas fa-sign-out-alt text-xl"></i>
                </button>
            </div>
        </div>
        
        <div class="p-4 space-y-4">
            <!-- Statistiques H√¥pital -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="card-modern">
                    <div class="text-2xl font-bold text-blue-600" id="hopitalNaissances">0</div>
                    <div class="text-sm text-gray-600">Naissances ce mois</div>
                </div>
                <div class="card-modern">
                    <div class="text-2xl font-bold text-gray-600" id="hopitalDeces">0</div>
                    <div class="text-sm text-gray-600">D√©c√®s ce mois</div>
                </div>
            </div>
            
            <!-- Actions rapides -->
            <div class="card-modern">
                <h2 class="font-bold text-lg mb-4">D√©clarations</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <button onclick="declarerNaissance()" class="bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-lg text-sm transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-baby mb-2"></i><br>
                        Acte de Naissance
                    </button>
                    <button onclick="declarerDeces()" class="bg-gray-600 hover:bg-gray-700 text-white p-3 rounded-lg text-sm transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-cross mb-2"></i><br>
                        Acte de D√©c√®s
                    </button>
                    <button onclick="declarerMariage()" class="bg-pink-500 hover:bg-pink-600 text-white p-3 rounded-lg text-sm transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-heart mb-2"></i><br>
                        Acte de Mariage
                    </button>
                    <button onclick="certificatNaissance()" class="bg-green-500 hover:bg-green-600 text-white p-3 rounded-lg text-sm transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-certificate mb-2"></i><br>
                        Certificat M√©dical
                    </button>
                </div>
            </div>
            
            <!-- D√©clarations r√©centes -->
            <div class="card-modern">
                <h2 class="font-bold text-lg mb-4">D√©clarations R√©centes</h2>
                <div class="space-y-3" id="hopitalDeclarationsList">
                    <p class="text-sm text-gray-500 text-center py-2">Chargement...</p>
                </div>
            </div>
            
            <!-- Statistiques mensuelles -->
            <div class="card-modern">
                <h2 class="font-bold text-lg mb-4">Statistiques Mensuelles</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 text-center" id="hopitalStatsMensuelles">
                    <div>
                        <div class="text-xl font-bold text-blue-600">0</div>
                        <div class="text-xs text-gray-600">Naissances</div>
                    </div>
                    <div>
                        <div class="text-xl font-bold text-gray-600">0</div>
                        <div class="text-xs text-gray-600">D√©c√®s</div>
                    </div>
                    <div>
                        <div class="text-xl font-bold text-green-600">0</div>
                        <div class="text-xs text-gray-600">Total</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Agent -->
    <div id="agentDashboard" class="hidden mobile-view" style="padding-top: 60px;">
        <div class="bg-blue-500 text-white p-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="https://res.cloudinary.com/dd64mwkl2/image/upload/v1764158267/OIP_1_nn6fy8.webp" alt="Logo" class="logo-small" />
                    <div>
                        <h1 class="text-xl font-bold">Agent Terrain</h1>
                        <p class="text-sm opacity-90" id="agentInfo">Chargement...</p>
                    </div>
                </div>
                <button onclick="logout()" class="text-white hover:opacity-80 transition-opacity">
                    <i class="fas fa-sign-out-alt text-xl"></i>
                </button>
            </div>
        </div>
        
        <div class="p-4 space-y-4">
            <!-- Statistiques Agent -->
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                <div class="bg-white rounded-lg p-3 shadow text-center">
                    <div class="text-xl font-bold text-blue-600">12</div>
                    <div class="text-xs text-gray-600">Demandes assign√©es</div>
                </div>
                <div class="bg-white rounded-lg p-3 shadow text-center">
                    <div class="text-xl font-bold text-green-600">8</div>
                    <div class="text-xs text-gray-600">Valid√©es aujourd'hui</div>
                </div>
                <div class="bg-white rounded-lg p-3 shadow text-center">
                    <div class="text-xl font-bold text-orange-600">3</div>
                    <div class="text-xs text-gray-600">Missions terrain</div>
                </div>
            </div>
            
            <!-- Actions Agent -->
            <div class="bg-white rounded-lg p-4 shadow">
                <h2 class="font-bold text-lg mb-4">Actions</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <button onclick="traiterDemandes()" class="bg-blue-500 text-white p-3 rounded-lg text-sm">
                        <i class="fas fa-tasks mb-2"></i><br>
                        Traiter Demandes
                    </button>
                    <button onclick="missionsTerrain()" class="bg-green-500 text-white p-3 rounded-lg text-sm">
                        <i class="fas fa-map-marker-alt mb-2"></i><br>
                        Missions Terrain
                    </button>
                    <button onclick="scannerQR()" class="bg-purple-500 text-white p-3 rounded-lg text-sm">
                        <i class="fas fa-qrcode mb-2"></i><br>
                        Scanner QR
                    </button>
                    <button onclick="redigerRapport()" class="bg-orange-500 text-white p-3 rounded-lg text-sm">
                        <i class="fas fa-file-alt mb-2"></i><br>
                        R√©diger Rapport
                    </button>
                </div>
            </div>
            
            <!-- Demandes en attente -->
            <div class="bg-white rounded-lg p-4 shadow" id="agentDemandesSection">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-lg">Demandes √† Traiter</h2>
                    <button onclick="loadAgentData()" class="text-blue-500 hover:text-blue-700 text-sm">
                        <i class="fas fa-sync-alt mr-1"></i>Actualiser
                            </button>
                        </div>
                <div class="space-y-3" id="agentDemandesList">
                    <p class="text-sm text-gray-500 text-center py-4">Chargement...</p>
                    </div>
                            </div>
            
            <!-- Signalements √† traiter -->
            <div class="bg-white rounded-lg p-4 shadow" id="agentSignalementsSection">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-lg">Signalements √† Traiter</h2>
                    <button onclick="loadAgentData()" class="text-blue-500 hover:text-blue-700 text-sm">
                        <i class="fas fa-sync-alt mr-1"></i>Actualiser
                            </button>
                        </div>
                <div class="space-y-3" id="agentSignalementsList">
                    <p class="text-sm text-gray-500 text-center py-4">Chargement...</p>
                </div>
            </div>
            
            <!-- Missions terrain -->
            <div class="bg-white rounded-lg p-4 shadow" id="agentMissionsSection">
                <h2 class="font-bold text-lg mb-4">Missions du Jour</h2>
                <div class="space-y-3" id="agentMissionsList">
                    <p class="text-sm text-gray-500 text-center py-4">Chargement...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Manager -->
    <div id="managerDashboard" class="hidden web-view" style="padding-top: 60px;">
        <div class="text-white p-6" style="background: linear-gradient(120deg, var(--gabon-green) 0%, var(--gabon-yellow) 45%, var(--gabon-blue) 100%);">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <img src="https://res.cloudinary.com/dd64mwkl2/image/upload/v1764158267/OIP_1_nn6fy8.webp" alt="Logo" class="logo-small" />
                    <div>
                        <h1 class="text-2xl font-bold">Tableau de Bord Manager</h1>
                        <p class="opacity-90" id="managerInfo">Chargement...</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="showProfil()" class="text-white hover:opacity-80 transition-opacity" title="Mon profil">
                        <i class="fas fa-user-circle text-xl"></i>
                    </button>
                    <button onclick="showStatistiques()" class="text-white hover:opacity-80 transition-opacity" title="Statistiques">
                        <i class="fas fa-chart-bar text-xl"></i>
                    </button>
                    <button onclick="showGestionUtilisateurs()" class="text-white hover:opacity-80 transition-opacity" title="Gestion utilisateurs">
                        <i class="fas fa-users-cog text-xl"></i>
                    </button>
                    <button onclick="showRecherche()" class="text-white hover:opacity-80 transition-opacity" title="Recherche">
                        <i class="fas fa-search text-xl"></i>
                    </button>
                    <button onclick="logout()" class="text-white text-xl hover:opacity-80 transition-opacity" title="D√©connexion">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="p-6">
            <!-- KPI -->
            <div class="grid grid-cols-4 gap-6 mb-6">
                <div class="bg-white rounded-lg p-6 shadow card-hover">
                    <div class="text-3xl font-bold text-blue-600">847</div>
                    <div class="text-gray-600">Demandes ce mois</div>
                    <div class="text-sm text-green-600">+12% vs mois dernier</div>
                </div>
                <div class="bg-white rounded-lg p-6 shadow card-hover">
                    <div class="text-3xl font-bold text-green-600">94%</div>
                    <div class="text-gray-600">Taux de satisfaction</div>
                    <div class="text-sm text-green-600">+3% vs objectif</div>
                </div>
                <div class="bg-white rounded-lg p-6 shadow card-hover">
                    <div class="text-3xl font-bold text-orange-600">2.3j</div>
                    <div class="text-gray-600">D√©lai moyen</div>
                    <div class="text-sm text-green-600">-0.7j vs objectif</div>
                </div>
                <div class="bg-white rounded-lg p-6 shadow card-hover">
                    <div class="text-3xl font-bold text-purple-600">15.2M</div>
                    <div class="text-gray-600">Recettes FCFA</div>
                    <div class="text-sm text-green-600">+8% vs pr√©vision</div>
                </div>
            </div>
            
            <!-- Alerte inscriptions agents -->
            <div id="managerAgentsAlert" class="mt-6 hidden bg-orange-50 border-l-4 border-orange-500 rounded-lg p-4 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
                <div>
                    <p class="text-orange-700 font-semibold text-lg flex items-center gap-2">
                        <i class="fas fa-user-clock"></i>
                        Inscriptions d'agents en attente
                    </p>
                    <p class="text-sm text-orange-700" id="managerAgentsAlertText">Aucun dossier en attente.</p>
                </div>
                <button onclick="validerInscriptionsAgents()" class="text-white px-4 py-2 rounded-lg font-semibold transition-transform hover:-translate-y-0.5 shadow-md" style="background: linear-gradient(90deg, #f97316, #ea580c);">
                    Examiner maintenant
                </button>
            </div>
            
            <!-- Services municipaux -->
            <div class="mt-6 bg-white rounded-lg p-6 shadow">
                <h2 class="text-xl font-bold mb-4">Services cl√©s de l'h√¥tel de ville</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="border-l-4 rounded-lg p-4 bg-gray-50" style="border-color: var(--gabon-green);">
                        <h3 class="font-semibold text-lg mb-2 text-green-700 flex items-center gap-2">
                            <i class="fas fa-id-card"></i>√âtat civil
                        </h3>
                        <ul class="text-sm text-gray-700 space-y-1">
                            <li>‚Ä¢ Actes de naissance et de d√©c√®s</li>
                            <li>‚Ä¢ Retraite, r√©sidence, attestations</li>
                            <li>‚Ä¢ L√©galisations et changements d'√©tat civil</li>
                        </ul>
                    </div>
                    <div class="border-l-4 rounded-lg p-4 bg-gray-50" style="border-color: var(--gabon-yellow);">
                        <h3 class="font-semibold text-lg mb-2 text-yellow-700 flex items-center gap-2">
                            <i class="fas fa-city"></i>Cadastre & Urbanisme
                        </h3>
                        <ul class="text-sm text-gray-700 space-y-1">
                            <li>‚Ä¢ Permis de construire</li>
                            <li>‚Ä¢ Permis de d√©molir</li>
                            <li>‚Ä¢ Occupation du domaine communal (ODDC)</li>
                        </ul>
                    </div>
                    <div class="border-l-4 rounded-lg p-4 bg-gray-50" style="border-color: var(--gabon-blue);">
                        <h3 class="font-semibold text-lg mb-2 text-blue-700 flex items-center gap-2">
                            <i class="fas fa-hands-helping"></i>Service social
                        </h3>
                        <ul class="text-sm text-gray-700 space-y-1">
                            <li>‚Ä¢ Aides solidaires individuelles</li>
                            <li>‚Ä¢ Programmes collectifs</li>
                            <li>‚Ä¢ Accompagnement d'urgence</li>
                        </ul>
                    </div>
                    <div class="border-l-4 rounded-lg p-4 bg-gray-50" style="border-color: var(--gabon-blue);">
                        <h3 class="font-semibold text-lg mb-2 text-blue-700 flex items-center gap-2">
                            <i class="fas fa-road"></i>Voiries
                        </h3>
                        <ul class="text-sm text-gray-700 space-y-1">
                            <li>‚Ä¢ Contr√¥les quotidiens</li>
                            <li>‚Ä¢ Actions ponctuelles planifi√©es</li>
                            <li>‚Ä¢ Interventions sur interpellation</li>
                        </ul>
                    </div>
                    <div class="border-l-4 rounded-lg p-4 bg-gray-50" style="border-color: var(--gabon-green);">
                        <h3 class="font-semibold text-lg mb-2 text-green-700 flex items-center gap-2">
                            <i class="fas fa-coins"></i>Finances municipales
                        </h3>
                        <ul class="text-sm text-gray-700 space-y-1">
                            <li>‚Ä¢ Transport et logistique municipale</li>
                            <li>‚Ä¢ Paie des agents & r√©gies</li>
                            <li>‚Ä¢ Ordres de recettes & fournisseurs</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Navigation -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                <!-- Assignation Demandes/Signalements -->
                <div class="bg-white rounded-lg p-6 shadow">
                    <h2 class="text-xl font-bold mb-4">Assignation</h2>
                    <div class="space-y-4">
                        <button onclick="assignerDemandes()" class="w-full bg-blue-500 text-white p-3 rounded hover:bg-blue-600 transition-colors">
                            <i class="fas fa-file-alt mr-2"></i>Assigner Demandes
                            <span id="managerDemandesNonAssignees" class="ml-2 bg-red-500 text-white px-2 py-1 rounded-full text-xs">0</span>
                        </button>
                        <button onclick="assignerSignalements()" class="w-full bg-green-500 text-white p-3 rounded hover:bg-green-600 transition-colors">
                            <i class="fas fa-exclamation-triangle mr-2"></i>Assigner Signalements
                            <span id="managerSignalementsNonAssignes" class="ml-2 bg-red-500 text-white px-2 py-1 rounded-full text-xs">0</span>
                        </button>
                        <button onclick="validerInscriptionsAgents()" class="w-full text-white p-3 rounded transition-transform hover:-translate-y-0.5 flex items-center justify-between gap-3 font-semibold shadow-lg" style="background: linear-gradient(90deg, #f97316, #ea580c);">
                            <span class="flex items-center gap-2">
                                <i class="fas fa-user-check"></i>
                                Valider Inscriptions Agents
                            </span>
                            <span id="managerAgentsEnAttente" class="bg-red-500 text-white px-3 py-1 rounded-full text-xs font-bold">0</span>
                        </button>
                        <button onclick="assignerTaches()" class="w-full p-3 rounded transition-transform hover:-translate-y-0.5 font-semibold shadow" style="background-color: var(--gabon-yellow); color: #1E293B;">
                            <i class="fas fa-tasks mr-2"></i>Assigner T√¢ches
                        </button>
                    </div>
                </div>
                
                <!-- Gestion √âquipes -->
                <div class="bg-white rounded-lg p-6 shadow">
                    <h2 class="text-xl font-bold mb-4">Gestion √âquipes</h2>
                    <div class="space-y-4">
                        <button onclick="evaluationEquipe()" class="w-full bg-green-500 text-white p-3 rounded">
                            <i class="fas fa-star mr-2"></i>√âvaluation Performance
                        </button>
                        <button onclick="planificationEquipe()" class="w-full bg-purple-500 text-white p-3 rounded">
                            <i class="fas fa-calendar mr-2"></i>Planning √âquipes
                        </button>
                    </div>
                    
                    <!-- √âquipe actuelle -->
                    <div class="mt-4" id="managerEquipeSection">
                        <h3 class="font-semibold mb-2" id="managerEquipeTitle">√âquipe Active (0 agents)</h3>
                        <div class="text-sm space-y-1" id="managerEquipeList">
                            <p class="text-gray-500 text-center py-2">Chargement...</p>
                            </div>
                    </div>
                </div>
                
                <!-- Analytics -->
                <div class="bg-white rounded-lg p-6 shadow">
                    <h2 class="text-xl font-bold mb-4">Analytics</h2>
                    <div class="space-y-4">
                        <button onclick="genererRapport()" class="w-full text-white p-3 rounded shadow" style="background-color: var(--gabon-blue);">
                            <i class="fas fa-chart-bar mr-2"></i>G√©n√©rer Rapport
                        </button>
                        <button onclick="analysePerformance()" class="w-full text-white p-3 rounded shadow" style="background-color: var(--gabon-green);">
                            <i class="fas fa-analytics mr-2"></i>Analyse Performance
                        </button>
                        <button onclick="previsionsTendances()" class="w-full p-3 rounded shadow transition-transform hover:-translate-y-0.5" style="background-color: var(--gabon-yellow); color: #1F2937;">
                            <i class="fas fa-crystal-ball mr-2"></i>Pr√©visions IA
                        </button>
                    </div>
                    
                    <!-- Graphique -->
                    <div class="mt-4">
                        <canvas id="managerChart" style="height: 200px;"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Gestion March√©s -->
            <div class="mt-6 bg-white rounded-lg p-6 shadow" id="managerMarchesSection">
                <h2 class="text-xl font-bold mb-4">Supervision March√©s</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4" id="managerMarchesStats">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600">0%</div>
                        <div class="text-sm text-gray-600">Taux occupation</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600">0</div>
                        <div class="text-sm text-gray-600">Emplacements occup√©s</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-purple-600">0</div>
                        <div class="text-sm text-gray-600">Recettes march√©s FCFA</div>
                    </div>
                </div>
                
                <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <button onclick="gestionMarches()" class="text-white p-3 rounded shadow" style="background-color: var(--gabon-green);">
                        <i class="fas fa-store mr-2"></i>Gestion March√©s
                    </button>
                    <button onclick="controleQualite()" class="text-white p-3 rounded shadow" style="background-color: var(--gabon-blue);">
                        <i class="fas fa-check-circle mr-2"></i>Contr√¥le Qualit√©
                    </button>
                    <button onclick="planificationTournees()" class="p-3 rounded shadow" style="background-color: var(--gabon-yellow); color: #1E293B;">
                        <i class="fas fa-route mr-2"></i>Planification Tourn√©es
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Super Admin -->
    <div id="superadminDashboard" class="hidden web-view">
        <div class="bg-red-600 text-white p-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <img src="https://res.cloudinary.com/dd64mwkl2/image/upload/v1764158267/OIP_1_nn6fy8.webp" alt="Logo" class="logo-small" />
                    <div>
                        <h1 class="text-2xl font-bold">Console Super Admin</h1>
                        <p class="opacity-90" id="superadminInfo">Chargement...</p>
                    </div>
                </div>
                <button onclick="logout()" class="text-white text-xl hover:opacity-80 transition-opacity">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
        
        <div class="p-6">
            <!-- M√©triques Syst√®me -->
            <div class="grid grid-cols-5 gap-4 mb-6">
                <div class="bg-white rounded-lg p-4 shadow text-center card-hover">
                    <div class="text-2xl font-bold text-green-600">1,247</div>
                    <div class="text-sm text-gray-600">Utilisateurs actifs</div>
                </div>
                <div class="bg-white rounded-lg p-4 shadow text-center card-hover">
                    <div class="text-2xl font-bold text-blue-600">99.97%</div>
                    <div class="text-sm text-gray-600">Uptime syst√®me</div>
                </div>
                <div class="bg-white rounded-lg p-4 shadow text-center card-hover">
                    <div class="text-2xl font-bold text-purple-600">187ms</div>
                    <div class="text-sm text-gray-600">Temps r√©ponse</div>
                </div>
                <div class="bg-white rounded-lg p-4 shadow text-center card-hover">
                    <div class="text-2xl font-bold text-orange-600">234M</div>
                    <div class="text-sm text-gray-600">√âconomies FCFA/an</div>
                </div>
                <div class="bg-white rounded-lg p-4 shadow text-center card-hover">
                    <div class="text-2xl font-bold text-red-600">8.7/10</div>
                    <div class="text-sm text-gray-600">NPS Global</div>
                </div>
            </div>
            
            <!-- Administration -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Gestion Utilisateurs -->
                <div class="bg-white rounded-lg p-6 shadow">
                    <h2 class="text-xl font-bold mb-4">Gestion Utilisateurs</h2>
                    <div class="space-y-3">
                        <button onclick="creerUtilisateur()" class="w-full bg-green-500 text-white p-3 rounded">
                            <i class="fas fa-user-plus mr-2"></i>Cr√©er Utilisateur
                        </button>
                        <button onclick="gererDroits()" class="w-full bg-blue-500 text-white p-3 rounded">
                            <i class="fas fa-key mr-2"></i>G√©rer Droits
                        </button>
                        <button onclick="auditConnexions()" class="w-full bg-purple-500 text-white p-3 rounded">
                            <i class="fas fa-history mr-2"></i>Audit Connexions
                        </button>
                    </div>
                    
                    <div class="mt-4 text-sm">
                        <div class="flex justify-between mb-2">
                            <span>Citoyens:</span>
                            <span class="font-semibold">973 (78%)</span>
                        </div>
                        <div class="flex justify-between mb-2">
                            <span>Commer√ßants:</span>
                            <span class="font-semibold">149 (12%)</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Agents:</span>
                            <span class="font-semibold">125 (10%)</span>
                        </div>
                    </div>
                </div>
                
                <!-- Configuration Syst√®me -->
                <div class="bg-white rounded-lg p-6 shadow">
                    <h2 class="text-xl font-bold mb-4">Configuration</h2>
                    <div class="space-y-3">
                        <button onclick="configurerTarifs()" class="w-full bg-yellow-500 text-white p-3 rounded">
                            <i class="fas fa-euro-sign mr-2"></i>Configurer Tarifs
                        </button>
                        <button onclick="parametresGeneraux()" class="w-full bg-indigo-500 text-white p-3 rounded">
                            <i class="fas fa-cogs mr-2"></i>Param√®tres G√©n√©raux
                        </button>
                        <button onclick="integrationsAPI()" class="w-full bg-teal-500 text-white p-3 rounded">
                            <i class="fas fa-plug mr-2"></i>Int√©grations API
                        </button>
                    </div>
                    
                    <div class="mt-4 text-sm">
                        <div class="flex justify-between mb-2">
                            <span>Services configur√©s:</span>
                            <span class="font-semibold">47/50</span>
                        </div>
                        <div class="flex justify-between mb-2">
                            <span>APIs connect√©es:</span>
                            <span class="font-semibold">8/8</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Derni√®re m√†j:</span>
                            <span class="font-semibold">13/01/2025</span>
                        </div>
                    </div>
                </div>
                
                <!-- Analytics Avanc√©es -->
                <div class="bg-white rounded-lg p-6 shadow">
                    <h2 class="text-xl font-bold mb-4">Analytics Avanc√©es</h2>
                    <div class="space-y-3">
                        <button onclick="roiDigitalisation()" class="w-full bg-green-600 text-white p-3 rounded">
                            <i class="fas fa-chart-line mr-2"></i>ROI Digitalisation
                        </button>
                        <button onclick="predictionsIA()" class="w-full bg-purple-600 text-white p-3 rounded">
                            <i class="fas fa-brain mr-2"></i>Pr√©dictions IA
                        </button>
                        <button onclick="reportingExecutif()" class="w-full bg-red-600 text-white p-3 rounded">
                            <i class="fas fa-file-pdf mr-2"></i>Reporting Ex√©cutif
                        </button>
                    </div>
                    
                    <!-- Graphique Syst√®me -->
                    <div class="mt-4">
                        <canvas id="adminChart" style="height: 150px;"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Maintenance et S√©curit√© -->
            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-lg p-6 shadow">
                    <h2 class="text-xl font-bold mb-4">Maintenance Syst√®me</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <button onclick="sauvegardes()" class="bg-blue-500 text-white p-3 rounded text-sm">
                            <i class="fas fa-database mr-2"></i>Sauvegardes
                        </button>
                        <button onclick="performance()" class="bg-green-500 text-white p-3 rounded text-sm">
                            <i class="fas fa-tachometer-alt mr-2"></i>Performance
                        </button>
                        <button onclick="logs()" class="bg-purple-500 text-white p-3 rounded text-sm">
                            <i class="fas fa-list mr-2"></i>Logs Syst√®me
                        </button>
                        <button onclick="monitoring()" class="bg-orange-500 text-white p-3 rounded text-sm">
                            <i class="fas fa-monitor mr-2"></i>Monitoring
                        </button>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg p-6 shadow">
                    <h2 class="text-xl font-bold mb-4">S√©curit√©</h2>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>Tentatives connexion √©chou√©es:</span>
                            <span class="text-red-600 font-semibold">47 (derni√®re heure)</span>
                        </div>
                        <div class="flex justify-between">
                            <span>IP bloqu√©es:</span>
                            <span class="text-yellow-600 font-semibold">3 actives</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Certificats SSL:</span>
                            <span class="text-green-600 font-semibold">Valides (89j restants)</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Derni√®re sauvegarde:</span>
                            <span class="text-green-600 font-semibold">13/01/2025 02:15</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modale Nouveau Signalement -->
    <div id="signalementModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-4 shadow w-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold">Nouveau Signalement</h2>
                <button onclick="closeModal('signalementModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="signalementForm" class="space-y-3">
                <div>
                    <label class="block text-sm font-medium mb-1">Type de signalement</label>
                    <select id="signalementType" class="w-full border rounded-lg p-2 text-sm">
                        <option value="">S√©lectionner...</option>
                        <option value="voirie">üõ£Ô∏è Voirie et Circulation</option>
                        <option value="assainissement">üö∞ Assainissement et Propret√©</option>
                        <option value="espaces-verts">üå≥ Espaces Verts</option>
                        <option value="constructions">üèóÔ∏è Constructions Anarchiques</option>
                        <option value="securite">üîí S√©curit√© Publique</option>
                        <option value="corruption">üí∞ Signalement Corruption (Anonyme)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Sous-cat√©gorie</label>
                    <select id="signalementSousType" class="w-full border rounded-lg p-2 text-sm">
                        <option value="">Choisir d'abord le type...</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Description</label>
                    <textarea id="signalementDescription" class="w-full border rounded-lg p-2 text-sm" rows="2" placeholder="D√©crivez le probl√®me..."></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">
                        <i class="fas fa-map-marker-alt mr-1"></i>Localisation
                    </label>
                    <div class="mb-1 border rounded-lg overflow-hidden">
                        <div id="signalementMap" class="map-container"></div>
                    </div>
                    <div id="signalementLocationDetails" class="mt-2 space-y-2">
                        <input type="text" id="signalementLocalisation" readonly class="w-full border rounded-lg p-2 bg-gray-50 text-sm" placeholder="Adresse compl√®te...">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                            <div class="bg-gray-50 p-2 rounded">
                                <span class="font-semibold text-gray-600">Quartier:</span>
                                <span id="signalementQuartier" class="text-gray-800 ml-1">-</span>
                            </div>
                            <div class="bg-gray-50 p-2 rounded">
                                <span class="font-semibold text-gray-600">Ville:</span>
                                <span id="signalementVille" class="text-gray-800 ml-1">-</span>
                            </div>
                            <div class="bg-gray-50 p-2 rounded">
                                <span class="font-semibold text-gray-600">Arrondissement:</span>
                                <span id="signalementArrondissement" class="text-gray-800 ml-1">-</span>
                            </div>
                            <div class="bg-gray-50 p-2 rounded">
                                <span class="font-semibold text-gray-600">Coordonn√©es:</span>
                                <span id="signalementCoords" class="text-gray-800 ml-1">-</span>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="signalementLatitude" value="">
                    <input type="hidden" id="signalementLongitude" value="">
                    <p class="text-xs text-gray-500 mt-1">
                        Cliquez sur la carte pour indiquer l'emplacement exact
                    </p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Photo (optionnel)</label>
                    <input type="file" id="signalementPhoto" class="w-full border rounded-lg p-2 text-sm" accept="image/*">
                </div>
                
                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="closeModal('signalementModal')" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white p-2 rounded-lg text-sm transition-colors">
                        Annuler
                    </button>
                    <button type="submit" class="flex-1 bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg text-sm transition-colors">
                        Signaler
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modale Nouvelle Demande -->
    <div id="demandeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="padding-top: 80px;">
        <div class="bg-white rounded-lg p-4 md:p-6 max-w-2xl w-full mx-2 md:mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Nouvelle Demande Administrative</h2>
                <button onclick="closeModal('demandeModal')" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="demandeForm" enctype="multipart/form-data">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Type de service</label>
                    <select id="demandeType" class="w-full border rounded p-2">
                        <option value="">S√©lectionner...</option>
                        <option value="etat-civil">üìÑ √âtat Civil</option>
                        <option value="cadastre-urbanisme">üèóÔ∏è Cadastre & Urbanisme</option>
                        <option value="service-social">ü§ù Service Social</option>
                        <option value="voiries">üöß Voiries & Interventions</option>
                        <option value="finances">üíº Finances Municipales</option>
                        <option value="hopital">üè• Services Hospitaliers</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Service sp√©cifique</label>
                    <select id="demandeService" class="w-full border rounded p-2">
                        <option value="">Choisir d'abord le type...</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Motif/Utilisation</label>
                    <textarea id="demandeMotif" class="w-full border rounded p-2" rows="2" placeholder="Pour quelle utilisation ?"></textarea>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Documents requis <span class="text-red-500">*</span></label>
                    <div id="documentsRequis" class="text-sm text-gray-600 bg-gray-50 p-3 rounded mb-2">
                        S√©lectionnez un service pour voir les documents requis
                    </div>
                    <div id="infoSpeciale" class="text-xs text-blue-600 mt-2 hidden">
                        <i class="fas fa-info-circle mr-1"></i>
                        <span id="infoSpecialeText"></span>
                    </div>
                    <div id="documentsUploadContainer" class="mt-3 space-y-2 hidden">
                        <p class="text-xs text-red-600 font-semibold mb-2">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            Tous les documents sont obligatoires
                        </p>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Co√ªt estim√©</label>
                    <div id="coutEstime" class="text-lg font-bold text-green-600">
                        - FCFA
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <button type="button" onclick="closeModal('demandeModal')" class="flex-1 bg-gray-500 text-white p-2 rounded">
                        Annuler
                    </button>
                    <button type="submit" class="flex-1 bg-blue-500 text-white p-2 rounded">
                        Soumettre
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modale Paiement -->
    <div id="paiementModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-4 md:p-6 max-w-md w-full mx-2 md:mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Effectuer un Paiement</h2>
                <button onclick="closeModal('paiementModal')" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="mb-4">
                <div class="text-lg font-semibold">Service: <span id="paiementService"></span></div>
                <div class="text-2xl font-bold text-green-600">Montant: <span id="paiementMontant"></span> FCFA</div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Moyen de paiement</label>
                <div class="space-y-2">
                    <button onclick="selectPaiement('clickpay')" class="w-full p-3 border rounded hover:bg-gray-50 text-left">
                        <i class="fas fa-credit-card mr-2 text-green-600"></i>ClickPay (Paiement s√©curis√©)
                    </button>
                    <button onclick="selectPaiement('airtel')" class="w-full p-3 border rounded hover:bg-gray-50 text-left">
                        <i class="fas fa-mobile-alt mr-2 text-red-600"></i>Airtel Money
                    </button>
                    <button onclick="selectPaiement('moov')" class="w-full p-3 border rounded hover:bg-gray-50 text-left">
                        <i class="fas fa-mobile-alt mr-2 text-blue-600"></i>Moov Money
                    </button>
                    <button onclick="selectPaiement('carte')" class="w-full p-3 border rounded hover:bg-gray-50 text-left">
                        <i class="fas fa-credit-card mr-2 text-purple-600"></i>Carte Bancaire
                    </button>
                    <button onclick="selectPaiement('especes')" class="w-full p-3 border rounded hover:bg-gray-50 text-left">
                        <i class="fas fa-money-bill mr-2 text-green-600"></i>Paiement Esp√®ces (Agent)
                    </button>
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="closeModal('paiementModal')" class="flex-1 bg-gray-500 text-white p-2 rounded">
                    Annuler
                </button>
            </div>
        </div>
    </div>

    <!-- Modale Mes Demandes -->
    <div id="mesDemandesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="padding-top: 80px;">
        <div class="bg-white rounded-lg p-4 md:p-6 max-w-4xl w-full mx-2 md:mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Mes Demandes</h2>
                <button onclick="closeModal('mesDemandesModal')" class="text-gray-500 hover:text-gray-700 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="mesDemandesStats" class="grid grid-cols-3 gap-4 mb-6">
                <div class="bg-blue-50 p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold text-blue-600" id="totalDemandes">0</div>
                    <div class="text-sm text-gray-600 mt-1">Total</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold text-green-600" id="valideesDemandes">0</div>
                    <div class="text-sm text-gray-600 mt-1">Valid√©es</div>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold text-yellow-600" id="enCoursDemandes">0</div>
                    <div class="text-sm text-gray-600 mt-1">En cours</div>
                </div>
            </div>
            
            <div id="mesDemandesList" class="space-y-3">
                <p class="text-center text-gray-500 py-8">Chargement...</p>
            </div>
        </div>
    </div>

    <!-- Modale Mes Paiements -->
    <div id="mesPaiementsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="padding-top: 80px;">
        <div class="bg-white rounded-lg p-4 md:p-6 max-w-4xl w-full mx-2 md:mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Mes Paiements</h2>
                <button onclick="closeModal('mesPaiementsModal')" class="text-gray-500 hover:text-gray-700 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="mesPaiementsStats" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <div class="bg-green-50 p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold text-green-600" id="totalPaiements">0</div>
                    <div class="text-sm text-gray-600 mt-1">Paiements effectu√©s</div>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold text-blue-600" id="montantTotalPaiements">0</div>
                    <div class="text-sm text-gray-600 mt-1">Montant total (FCFA)</div>
                </div>
            </div>
            
            <div id="mesPaiementsList" class="space-y-3">
                <p class="text-center text-gray-500 py-8">Chargement...</p>
            </div>
        </div>
    </div>

    <!-- Modal Budget Municipal -->
    <div id="budgetModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-4 md:p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto mx-2 md:mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Budget Municipal</h2>
                <button onclick="closeModal('budgetModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Exercice budg√©taire</label>
                <select id="budgetExercice" onchange="loadBudget()" class="w-full border rounded p-2">
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                </select>
            </div>
            
            <div id="budgetContent" class="space-y-4">
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-3xl text-gray-400"></i>
                    <p class="mt-2 text-gray-600">Chargement du budget...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Travaux Publics -->
    <div id="travauxModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" style="padding-top: 80px;">
        <div class="bg-white rounded-lg p-3 md:p-4 max-w-4xl w-full max-h-[85vh] flex flex-col mx-2 md:mx-4">
            <div class="flex justify-between items-center mb-3 flex-shrink-0">
                <h2 class="text-xl font-bold">Travaux Publics</h2>
                <button onclick="closeModal('travauxModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="mb-3 flex gap-2 flex-shrink-0">
                <select id="travauxStatut" onchange="loadChantiers()" class="border rounded p-1.5 text-sm flex-1">
                    <option value="">Tous les statuts</option>
                    <option value="a_venir">√Ä venir</option>
                    <option value="en_cours">En cours</option>
                    <option value="suspendu">Suspendu</option>
                    <option value="termine">Termin√©</option>
                </select>
                <select id="travauxType" onchange="loadChantiers()" class="border rounded p-1.5 text-sm flex-1">
                    <option value="">Tous les types</option>
                    <option value="voirie">Voirie</option>
                    <option value="assainissement">Assainissement</option>
                    <option value="eclairage">√âclairage</option>
                    <option value="batiment">B√¢timent</option>
                </select>
            </div>
            
            <div id="travauxMap" style="height: 250px; margin-bottom: 15px;" class="rounded-lg border flex-shrink-0"></div>
            
            <div id="chantiersList" class="space-y-2 overflow-y-auto flex-1" style="max-height: calc(85vh - 400px);">
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin text-xl text-gray-400"></i>
                    <p class="mt-2 text-gray-600 text-sm">Chargement des chantiers...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Notifications -->
    <div id="notificationsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-4 md:p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto mx-2 md:mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Notifications</h2>
                <div class="flex gap-2">
                    <button onclick="showPreferencesNotifications()" class="text-blue-600 hover:text-blue-800">
                        <i class="fas fa-cog"></i> Pr√©f√©rences
                    </button>
                    <button onclick="closeModal('notificationsModal')" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div id="notificationsList" class="space-y-3">
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-3xl text-gray-400"></i>
                    <p class="mt-2 text-gray-600">Chargement des notifications...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Pr√©f√©rences Notifications -->
    <div id="preferencesNotificationsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-4 md:p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto mx-2 md:mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Pr√©f√©rences de Notifications</h2>
                <button onclick="closeModal('preferencesNotificationsModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="preferencesForm" class="space-y-6">
                <div>
                    <h3 class="font-semibold mb-3">Types de notifications</h3>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" name="notifications_circulation" class="mr-2">
                            <span>Circulation et travaux</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="notifications_evenements" class="mr-2">
                            <span>√âv√©nements municipaux</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="notifications_alertes" class="mr-2">
                            <span>Alertes importantes</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="notifications_administratives" class="mr-2">
                            <span>Notifications administratives</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="notifications_commerciales" class="mr-2">
                            <span>Offres commerciales</span>
                        </label>
                    </div>
                </div>
                
                <div>
                    <h3 class="font-semibold mb-3">Canaux de diffusion</h3>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" name="canal_push" class="mr-2">
                            <span>Notifications push (application)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="canal_sms" class="mr-2">
                            <span>SMS</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="canal_email" class="mr-2">
                            <span>Email</span>
                        </label>
                    </div>
                </div>
                
                <div>
                    <h3 class="font-semibold mb-3">G√©olocalisation</h3>
                    <label class="flex items-center mb-2">
                        <input type="checkbox" name="geolocalisation_active" class="mr-2">
                        <span>Activer les notifications g√©olocalis√©es</span>
                    </label>
                    <div class="ml-6">
                        <label class="block text-sm mb-1">Rayon (km)</label>
                        <input type="number" name="rayon_km" min="1" max="50" value="5" class="w-full border rounded p-2">
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <button type="button" onclick="closeModal('preferencesNotificationsModal')" class="flex-1 bg-gray-500 text-white p-2 rounded">
                        Annuler
                    </button>
                    <button type="submit" class="flex-1 bg-green-600 text-white p-2 rounded">
                        Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Assistance -->
    <div id="assistanceModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Assistance en ligne</h2>
                <button onclick="closeModal('assistanceModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <div>
                    <h3 class="font-semibold mb-2">FAQ</h3>
                    <div id="faqList" class="space-y-2 max-h-64 overflow-y-auto">
                        <div class="text-center py-4">
                            <i class="fas fa-spinner fa-spin text-xl text-gray-400"></i>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">Poser une question</h3>
                    <form id="assistanceForm" class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium mb-1">Sujet</label>
                            <input type="text" name="sujet" class="w-full border rounded p-2" placeholder="Sujet de votre question">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Message</label>
                            <textarea name="message" rows="4" class="w-full border rounded p-2" placeholder="D√©crivez votre probl√®me..."></textarea>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded">
                            Envoyer
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Feedback -->
    <div id="feedbackModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-4 md:p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto mx-2 md:mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Votre Avis</h2>
                <button onclick="closeModal('feedbackModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="feedbackForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Note globale</label>
                    <div class="flex gap-2 justify-center" id="ratingStars">
                        <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400 transition-colors" data-rating="1"></i>
                        <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400 transition-colors" data-rating="2"></i>
                        <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400 transition-colors" data-rating="3"></i>
                        <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400 transition-colors" data-rating="4"></i>
                        <i class="fas fa-star text-3xl text-gray-300 cursor-pointer hover:text-yellow-400 transition-colors" data-rating="5"></i>
                    </div>
                    <input type="hidden" id="ratingValue" name="note" value="0">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Type de service</label>
                    <select name="type_service" class="w-full border rounded p-2">
                        <option value="">S√©lectionner...</option>
                        <option value="demande">Demande administrative</option>
                        <option value="signalement">Signalement</option>
                        <option value="paiement">Paiement</option>
                        <option value="licence">Licence commerciale</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Commentaire</label>
                    <textarea name="commentaire" rows="5" class="w-full border rounded p-2" placeholder="Partagez votre exp√©rience..."></textarea>
                </div>
                
                <div class="flex gap-3">
                    <button type="button" onclick="closeModal('feedbackModal')" class="flex-1 bg-gray-500 text-white p-2 rounded">
                        Annuler
                    </button>
                    <button type="submit" class="flex-1 bg-blue-600 text-white p-2 rounded">
                        Envoyer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Profil Utilisateur -->
    <div id="profilModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="text-white p-6 rounded-t-xl" style="background-color: var(--gabon-green);">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-user-circle mr-2"></i>Mon Profil
                    </h2>
                    <button onclick="closeModal('profilModal')" class="text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <form id="profilForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-user mr-2" style="color: var(--gabon-green);"></i>Nom complet
                            </label>
                            <input type="text" id="profilNom" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:border-transparent" style="--tw-ring-color: var(--gabon-green);" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-phone mr-2" style="color: var(--gabon-green);"></i>T√©l√©phone
                            </label>
                            <input type="tel" id="profilTelephone" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:border-transparent" style="--tw-ring-color: var(--gabon-green);" required>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-envelope mr-2" style="color: var(--gabon-green);"></i>Email (optionnel)
                        </label>
                        <input type="email" id="profilEmail" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:border-transparent" style="--tw-ring-color: var(--gabon-green);">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-map-marker-alt mr-2" style="color: var(--gabon-green);"></i>Localisation
                        </label>
                        <input type="text" id="profilLocalisation" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:border-transparent" style="--tw-ring-color: var(--gabon-green);">
                    </div>
                    
                    <div class="border-t pt-4">
                        <h3 class="font-semibold text-gray-700 mb-3">
                            <i class="fas fa-key mr-2" style="color: var(--gabon-yellow);"></i>Changer le mot de passe
                        </h3>
                        <div class="space-y-3">
                            <input type="password" id="profilPasswordOld" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:border-transparent" style="--tw-ring-color: var(--gabon-green);" placeholder="Ancien mot de passe">
                            <input type="password" id="profilPasswordNew" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:border-transparent" style="--tw-ring-color: var(--gabon-green);" placeholder="Nouveau mot de passe (min. 6 caract√®res)">
                            <input type="password" id="profilPasswordConfirm" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:border-transparent" style="--tw-ring-color: var(--gabon-green);" placeholder="Confirmer le nouveau mot de passe">
                        </div>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeModal('profilModal')" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white p-3 rounded-lg font-semibold transition-colors">
                            <i class="fas fa-times mr-2"></i>Annuler
                        </button>
                        <button type="submit" class="flex-1 text-white p-3 rounded-lg font-semibold transition-opacity hover:opacity-90" style="background-color: var(--gabon-green);">
                            <i class="fas fa-save mr-2"></i>Enregistrer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Statistiques D√©taill√©es -->
    <div id="statistiquesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
            <div class="text-white p-6 rounded-t-xl" style="background-color: var(--gabon-blue);">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-chart-bar mr-2"></i>Statistiques D√©taill√©es
                    </h2>
                    <button onclick="closeModal('statistiquesModal')" class="text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg border-l-4" style="border-color: var(--gabon-green);">
                        <div class="text-3xl font-bold" style="color: var(--gabon-green);" id="statTotalDemandes">0</div>
                        <div class="text-sm text-gray-600 mt-1">Total Demandes</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg border-l-4" style="border-color: var(--gabon-blue);">
                        <div class="text-3xl font-bold" style="color: var(--gabon-blue);" id="statTotalSignalements">0</div>
                        <div class="text-sm text-gray-600 mt-1">Total Signalements</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg border-l-4" style="border-color: var(--gabon-yellow);">
                        <div class="text-3xl font-bold" style="color: var(--gabon-yellow);" id="statEnCours">0</div>
                        <div class="text-sm text-gray-600 mt-1">En Cours</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg border-l-4" style="border-color: var(--gabon-green);">
                        <div class="text-3xl font-bold" style="color: var(--gabon-green);" id="statResolus">0</div>
                        <div class="text-sm text-gray-600 mt-1">R√©solus</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-700 mb-3">
                            <i class="fas fa-chart-pie mr-2 text-gray-600"></i>R√©partition par Type
                        </h3>
                        <canvas id="statChartType" height="200"></canvas>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-700 mb-3">
                            <i class="fas fa-chart-line mr-2 text-gray-600"></i>√âvolution Mensuelle
                        </h3>
                        <canvas id="statChartEvolution" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Gestion Utilisateurs (Admin) -->
    <div id="gestionUtilisateursModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
            <div class="text-white p-6 rounded-t-xl" style="background-color: var(--gabon-blue);">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-users-cog mr-2"></i>Gestion des Utilisateurs
                    </h2>
                    <button onclick="closeModal('gestionUtilisateursModal')" class="text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="mb-4 flex gap-3">
                    <input type="text" id="searchUsers" placeholder="Rechercher un utilisateur..." class="flex-1 border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-green-500">
                    <select id="filterUsersRole" class="border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-green-500">
                        <option value="">Tous les r√¥les</option>
                        <option value="citoyen">Citoyen</option>
                        <option value="commercant">Commer√ßant</option>
                        <option value="agent">Agent</option>
                        <option value="manager">Manager</option>
                        <option value="hopital">H√¥pital</option>
                        <option value="chef_quartier">Chef de Quartier</option>
                    </select>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border p-3 text-left font-semibold">Nom</th>
                                <th class="border p-3 text-left font-semibold">T√©l√©phone</th>
                                <th class="border p-3 text-left font-semibold">R√¥le</th>
                                <th class="border p-3 text-left font-semibold">Statut</th>
                                <th class="border p-3 text-left font-semibold">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="utilisateursList">
                            <tr>
                                <td colspan="5" class="text-center py-8 text-gray-500">
                                    <i class="fas fa-spinner fa-spin text-xl mb-2"></i>
                                    <p>Chargement...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal D√©tails Signalement Am√©lior√© -->
    <div id="signalementDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="text-white p-6 rounded-t-xl" style="background-color: var(--gabon-green);">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold">
                            <i class="fas fa-exclamation-triangle mr-2"></i>D√©tails du Signalement
                        </h2>
                        <p class="text-sm opacity-90 mt-1" id="signalementDetailId">#ID</p>
                    </div>
                    <button onclick="closeModal('signalementDetailModal')" class="text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <label class="text-sm font-medium text-gray-600">Type</label>
                        <p class="text-lg font-semibold" id="signalementDetailType">-</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <label class="text-sm font-medium text-gray-600">Statut</label>
                        <p class="text-lg font-semibold" id="signalementDetailStatut">-</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <label class="text-sm font-medium text-gray-600">Date</label>
                        <p class="text-lg font-semibold" id="signalementDetailDate">-</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <label class="text-sm font-medium text-gray-600">Localisation</label>
                        <p class="text-lg font-semibold" id="signalementDetailLocalisation">-</p>
                    </div>
                </div>
                
                <div>
                    <label class="text-sm font-medium text-gray-600">Description</label>
                    <p class="bg-gray-50 p-4 rounded-lg mt-2" id="signalementDetailDescription">-</p>
                </div>
                
                <div id="signalementDetailMapContainer" class="hidden">
                    <label class="text-sm font-medium text-gray-600 mb-2 block">Localisation GPS</label>
                    <div id="signalementDetailMap" class="map-container" style="height: 250px;"></div>
                </div>
                
                <div id="signalementDetailActions" class="flex gap-3 pt-4 border-t">
                    <!-- Actions dynamiques selon le r√¥le -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Suivi Demande -->
    <div id="suiviDemandeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="text-white p-6 rounded-t-xl" style="background-color: var(--gabon-blue);">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold">
                            <i class="fas fa-clipboard-list mr-2"></i>Suivi de Demande
                        </h2>
                        <p class="text-sm opacity-90 mt-1" id="suiviDemandeId">#ID</p>
                    </div>
                    <button onclick="closeModal('suiviDemandeModal')" class="text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-lg">Informations de la demande</h3>
                        <span class="px-3 py-1 rounded-full text-sm font-semibold" id="suiviDemandeStatut">-</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm font-medium text-gray-600">Type de service</label>
                            <p class="text-lg font-semibold" id="suiviDemandeType">-</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">Service sp√©cifique</label>
                            <p class="text-lg font-semibold" id="suiviDemandeService">-</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">Date de cr√©ation</label>
                            <p class="text-lg font-semibold" id="suiviDemandeDate">-</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">Montant</label>
                            <p class="text-lg font-semibold" id="suiviDemandeMontant">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="border-t pt-6">
                    <h3 class="font-semibold text-lg mb-4">
                        <i class="fas fa-history mr-2 text-gray-600"></i>Historique
                    </h3>
                    <div id="suiviDemandeHistorique" class="space-y-3">
                        <!-- Historique dynamique -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Recherche Avanc√©e -->
    <div id="rechercheModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="text-white p-6 rounded-t-xl" style="background-color: var(--gabon-green);">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-search mr-2"></i>Recherche Avanc√©e
                    </h2>
                    <button onclick="closeModal('rechercheModal')" class="text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Type de recherche</label>
                    <select id="rechercheType" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-purple-500">
                        <option value="demandes">Demandes</option>
                        <option value="signalements">Signalements</option>
                        <option value="paiements">Paiements</option>
                        <option value="utilisateurs">Utilisateurs</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date d√©but</label>
                        <input type="date" id="rechercheDateDebut" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date fin</label>
                        <input type="date" id="rechercheDateFin" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Statut</label>
                    <select id="rechercheStatut" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-purple-500">
                        <option value="">Tous les statuts</option>
                        <option value="en_attente">En attente</option>
                        <option value="en_cours">En cours</option>
                        <option value="valide">Valid√©</option>
                        <option value="rejete">Rejet√©</option>
                        <option value="resolu">R√©solu</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mots-cl√©s</label>
                    <input type="text" id="rechercheMotsCles" placeholder="Rechercher..." class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-purple-500">
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeModal('rechercheModal')" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white p-3 rounded-lg font-semibold transition-colors">
                        Annuler
                    </button>
                    <button type="button" onclick="executerRecherche()" class="flex-1 text-white p-3 rounded-lg font-semibold transition-opacity hover:opacity-90" style="background-color: var(--gabon-green);">
                        <i class="fas fa-search mr-2"></i>Rechercher
                    </button>
                </div>
                
                <div id="rechercheResultats" class="mt-6 hidden">
                    <h3 class="font-semibold text-lg mb-3">R√©sultats</h3>
                    <div class="space-y-2" id="rechercheResultatsList">
                        <!-- R√©sultats dynamiques -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Assigner T√¢ches (Manager) -->
    <div id="assignerTachesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="text-white p-6 rounded-t-xl" style="background-color: var(--gabon-blue);">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-tasks mr-2"></i>Assigner des T√¢ches
                    </h2>
                    <button onclick="closeModal('assignerTachesModal')" class="text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">S√©lectionner un agent</label>
                    <select id="tacheAgentSelect" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500">
                        <option value="">Choisir un agent...</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Titre de la t√¢che</label>
                    <input type="text" id="tacheTitre" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500" placeholder="Ex: V√©rifier l'√©tat de la route principale">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea id="tacheDescription" rows="4" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500" placeholder="D√©tails de la t√¢che..."></textarea>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date limite</label>
                    <input type="date" id="tacheDateLimite" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeModal('assignerTachesModal')" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white p-3 rounded-lg font-semibold transition-colors">
                        Annuler
                    </button>
                    <button type="button" onclick="creerTache()" class="flex-1 text-white p-3 rounded-lg font-semibold transition-opacity hover:opacity-90" style="background-color: var(--gabon-blue);">
                        <i class="fas fa-check mr-2"></i>Assigner
                    </button>
                </div>
                
                <div class="mt-6 border-t pt-4">
                    <h3 class="font-semibold text-lg mb-3">T√¢ches assign√©es r√©cemment</h3>
                    <div id="tachesList" class="space-y-2">
                        <p class="text-center text-gray-500 py-4">Aucune t√¢che assign√©e</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal √âvaluation √âquipe (Manager) -->
    <div id="evaluationEquipeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
            <div class="text-white p-6 rounded-t-xl" style="background-color: var(--gabon-green);">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-star mr-2"></i>√âvaluation Performance √âquipe
                    </h2>
                    <button onclick="closeModal('evaluationEquipeModal')" class="text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg text-center">
                        <div class="text-3xl font-bold text-blue-600" id="evalAgentsTotal">0</div>
                        <div class="text-sm text-gray-600 mt-1">Agents actifs</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg text-center">
                        <div class="text-3xl font-bold text-green-600" id="evalMoyenne">0</div>
                        <div class="text-sm text-gray-600 mt-1">Note moyenne</div>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg text-center">
                        <div class="text-3xl font-bold text-yellow-600" id="evalMissionsCompletees">0</div>
                        <div class="text-sm text-gray-600 mt-1">Missions compl√©t√©es</div>
                    </div>
                </div>
                
                <div id="evaluationAgentsList" class="space-y-3">
                    <p class="text-center text-gray-500 py-4">Chargement des agents...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Planification √âquipe (Manager) -->
    <div id="planificationEquipeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto relative">
            <button onclick="closeModal('planificationEquipeModal')" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl leading-none z-10">
                <i class="fas fa-times"></i>
            </button>
            <div class="text-white p-6 rounded-t-xl" style="background-color: var(--gabon-purple);">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-calendar mr-2"></i>Planning √âquipes
                    </h2>
                    <button onclick="closeModal('planificationEquipeModal')" class="text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="mb-4 flex gap-3">
                    <input type="date" id="planningDateDebut" class="border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-purple-500">
                    <span class="self-center">√†</span>
                    <input type="date" id="planningDateFin" class="border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-purple-500">
                    <button onclick="chargerPlanning()" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                        <i class="fas fa-search mr-2"></i>Charger
                    </button>
                </div>
                
                <div id="planningCalendrier" class="space-y-4">
                    <p class="text-center text-gray-500 py-8">S√©lectionnez une p√©riode pour voir le planning</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal G√©n√©rer Rapport (Manager) -->
    <div id="genererRapportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="text-white p-6 rounded-t-xl" style="background-color: var(--gabon-red);">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-chart-bar mr-2"></i>G√©n√©rer un Rapport
                    </h2>
                    <button onclick="closeModal('genererRapportModal')" class="text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Type de rapport</label>
                    <select id="rapportType" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-red-500">
                        <option value="mensuel">Rapport mensuel</option>
                        <option value="trimestriel">Rapport trimestriel</option>
                        <option value="annuel">Rapport annuel</option>
                        <option value="personnalise">Personnalis√©</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">P√©riode d√©but</label>
                        <input type="date" id="rapportDateDebut" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-red-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">P√©riode fin</label>
                        <input type="date" id="rapportDateFin" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-red-500">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sections √† inclure</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" name="rapportSections" value="demandes" class="mr-2" checked>
                            <span>Demandes administratives</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="rapportSections" value="signalements" class="mr-2" checked>
                            <span>Signalements</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="rapportSections" value="paiements" class="mr-2" checked>
                            <span>Paiements</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="rapportSections" value="performance" class="mr-2">
                            <span>Performance √©quipe</span>
                        </label>
                    </div>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeModal('genererRapportModal')" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white p-3 rounded-lg font-semibold transition-colors">
                        Annuler
                    </button>
                    <button type="button" onclick="genererRapportPDF()" class="flex-1 text-white p-3 rounded-lg font-semibold transition-opacity hover:opacity-90" style="background-color: var(--gabon-red);">
                        <i class="fas fa-file-pdf mr-2"></i>G√©n√©rer PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Analyse Performance (Manager) -->
    <div id="analysePerformanceModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
            <div class="text-white p-6 rounded-t-xl" style="background-color: var(--gabon-orange);">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-analytics mr-2"></i>Analyse Performance
                    </h2>
                    <button onclick="closeModal('analysePerformanceModal')" class="text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-700 mb-3">Temps de traitement moyen</h3>
                        <canvas id="performanceChartTemps" height="200"></canvas>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-700 mb-3">Taux de r√©solution</h3>
                        <canvas id="performanceChartResolution" height="200"></canvas>
                    </div>
                </div>
                
                <div id="performanceDetails" class="space-y-3">
                    <p class="text-center text-gray-500 py-4">Chargement des donn√©es...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Pr√©visions IA (Manager) -->
    <div id="previsionsTendancesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="text-white p-6 rounded-t-xl" style="background-color: var(--gabon-indigo);">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-crystal-ball mr-2"></i>Pr√©visions IA
                    </h2>
                    <button onclick="closeModal('previsionsTendancesModal')" class="text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="mb-6">
                    <h3 class="font-semibold text-lg mb-4">Pr√©visions pour les 3 prochains mois</h3>
                    <div id="previsionsList" class="space-y-4">
                        <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                            <div class="font-semibold text-blue-800">Mars 2025</div>
                            <div class="text-sm text-gray-600 mt-1">Pic de demandes pr√©vu: +34%</div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-gray-700 mb-3">Graphique des tendances</h3>
                    <canvas id="previsionsChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Gestion March√©s (Manager) -->
    <div id="gestionMarchesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
            <div class="text-white p-6 rounded-t-xl" style="background-color: var(--gabon-green);">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-store mr-2"></i>Gestion March√©s
                    </h2>
                    <button onclick="closeModal('gestionMarchesModal')" class="text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-green-50 p-4 rounded-lg text-center">
                        <div class="text-3xl font-bold text-green-600" id="marchesTotal">0</div>
                        <div class="text-sm text-gray-600 mt-1">March√©s actifs</div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg text-center">
                        <div class="text-3xl font-bold text-blue-600" id="marchesOccupation">0%</div>
                        <div class="text-sm text-gray-600 mt-1">Taux occupation</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg text-center">
                        <div class="text-3xl font-bold text-purple-600" id="marchesRecettes">0</div>
                        <div class="text-sm text-gray-600 mt-1">Recettes (FCFA)</div>
                    </div>
                </div>
                
                <div id="marchesList" class="space-y-3">
                    <p class="text-center text-gray-500 py-4">Chargement des march√©s...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Contr√¥le Qualit√© (Manager) -->
    <div id="controleQualiteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="text-white p-6 rounded-t-xl" style="background-color: var(--gabon-blue);">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-check-circle mr-2"></i>Contr√¥le Qualit√©
                    </h2>
                    <button onclick="closeModal('controleQualiteModal')" class="text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="mb-4">
                    <button onclick="programmerControle()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                        <i class="fas fa-plus mr-2"></i>Programmer un contr√¥le
                    </button>
                </div>
                
                <div id="controlesList" class="space-y-3">
                    <p class="text-center text-gray-500 py-4">Aucun contr√¥le programm√©</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Planification Tourn√©es (Manager) -->
    <div id="planificationTourneesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
            <div class="text-white p-6 rounded-t-xl" style="background-color: var(--gabon-purple);">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-route mr-2"></i>Planification Tourn√©es
                    </h2>
                    <button onclick="closeModal('planificationTourneesModal')" class="text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="mb-4">
                    <div id="tourneesMap" style="height: 300px; margin-bottom: 15px;" class="rounded-lg border"></div>
                </div>
                
                <div id="tourneesList" class="space-y-3">
                    <p class="text-center text-gray-500 py-4">Chargement des tourn√©es...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Traiter Demandes (Agent) -->
    <div id="traiterDemandesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" style="padding-top: 80px;">
        <div class="bg-white rounded-xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
            <div class="text-white p-6 rounded-t-xl" style="background-color: var(--gabon-blue);">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-tasks mr-2"></i>Traiter les Demandes
                    </h2>
                    <button onclick="closeModal('traiterDemandesModal')" class="text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div id="traiterDemandesList" class="space-y-3">
                    <p class="text-center text-gray-500 py-8">Chargement des demandes...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal D√©tails Demande Agent -->
    <div id="detailsDemandeAgentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" style="padding-top: 80px;">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="text-white p-6 rounded-t-xl" style="background-color: var(--gabon-blue);">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold">
                            <i class="fas fa-file-alt mr-2"></i>D√©tails de la Demande
                        </h2>
                        <p class="text-sm opacity-90 mt-1" id="detailsDemandeId">#ID</p>
                    </div>
                    <button onclick="closeModal('detailsDemandeAgentModal')" class="text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- Informations g√©n√©rales -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <label class="text-sm font-medium text-gray-600">Service</label>
                        <p class="text-lg font-semibold" id="detailsDemandeService">-</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <label class="text-sm font-medium text-gray-600">Utilisateur</label>
                        <p class="text-lg font-semibold" id="detailsDemandeUtilisateur">-</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <label class="text-sm font-medium text-gray-600">Date de cr√©ation</label>
                        <p class="text-lg font-semibold" id="detailsDemandeDate">-</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <label class="text-sm font-medium text-gray-600">Montant</label>
                        <p class="text-lg font-semibold" id="detailsDemandeMontant">-</p>
                    </div>
                </div>
                
                <!-- Motif -->
                <div>
                    <label class="text-sm font-medium text-gray-600">Motif / Utilisation</label>
                    <p class="bg-gray-50 p-3 rounded-lg mt-2" id="detailsDemandeMotif">-</p>
                </div>
                
                <!-- Documents requis -->
                <div id="detailsDemandeDocumentsRequis"></div>
                
                <!-- Documents fournis -->
                <div>
                    <label class="text-sm font-medium text-gray-700 mb-3 block">
                        <i class="fas fa-file-upload mr-2"></i>Documents fournis par l'utilisateur
                    </label>
                    <div id="detailsDemandeDocuments" class="space-y-3">
                        <p class="text-center text-gray-500 py-4">Chargement des documents...</p>
                    </div>
                </div>
                
                <!-- √âvaluation du dossier -->
                <div class="border-t pt-4">
                    <h3 class="font-semibold text-lg mb-4">√âvaluation du dossier</h3>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Statut</label>
                        <select id="detailsDemandeStatut" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500">
                            <option value="en_attente">En attente</option>
                            <option value="en_traitement">En traitement</option>
                            <option value="dossier_incomplet">Dossier incomplet</option>
                            <option value="valide">Dossier complet - Valider</option>
                            <option value="rejete">Rejet√©</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Commentaire / Ce qui manque (si dossier incomplet)
                        </label>
                        <textarea id="detailsDemandeCommentaire" rows="4" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500" placeholder="Indiquez ce qui manque ou vos observations..."></textarea>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeModal('detailsDemandeAgentModal')" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white p-3 rounded-lg font-semibold transition-colors">
                            Annuler
                        </button>
                        <button type="button" onclick="validerDossierDemande()" class="flex-1 text-white p-3 rounded-lg font-semibold transition-opacity hover:opacity-90" style="background-color: var(--gabon-blue);">
                            <i class="fas fa-check mr-2"></i>Enregistrer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Assigner Demandes (Manager) -->
    <div id="assignerDemandesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" style="padding-top: 80px;">
        <div class="bg-white rounded-xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
            <div class="text-white p-6 rounded-t-xl" style="background-color: var(--gabon-blue);">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-file-alt mr-2"></i>Assigner les Demandes
                    </h2>
                    <button onclick="closeModal('assignerDemandesModal')" class="text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div id="assignerDemandesList" class="space-y-3">
                    <p class="text-center text-gray-500 py-8">Chargement des demandes...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Assigner Signalements (Manager) -->
    <div id="assignerSignalementsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" style="padding-top: 80px;">
        <div class="bg-white rounded-xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
            <div class="text-white p-6 rounded-t-xl" style="background-color: var(--gabon-green);">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Assigner les Signalements
                    </h2>
                    <button onclick="closeModal('assignerSignalementsModal')" class="text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div id="assignerSignalementsList" class="space-y-3">
                    <p class="text-center text-gray-500 py-8">Chargement des signalements...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Valider Inscriptions Agents (Manager) -->
    <div id="validerInscriptionsAgentsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" style="padding-top: 80px;">
        <div class="bg-white rounded-xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
            <div class="text-white p-6 rounded-t-xl" style="background-color: var(--gabon-orange);">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-user-check mr-2"></i>Valider les Inscriptions d'Agents
                    </h2>
                    <button onclick="closeModal('validerInscriptionsAgentsModal')" class="text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div id="validerInscriptionsAgentsList" class="space-y-3">
                    <p class="text-center text-gray-500 py-8">Chargement des demandes d'inscription...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Chef de Quartier -->
    <div id="chefQuartierDashboard" class="hidden web-view">
        <div class="container mx-auto p-4 space-y-6">
            <h1 class="text-2xl font-bold">Espace Chef de Quartier</h1>
            
            <div class="grid grid-cols-3 gap-4">
                <div class="bg-white rounded-lg p-4 shadow">
                    <div class="text-2xl font-bold text-blue-600" id="chefSignalementsTotal">0</div>
                    <div class="text-sm text-gray-600">Signalements envoy√©s</div>
                </div>
                <div class="bg-white rounded-lg p-4 shadow">
                    <div class="text-2xl font-bold text-green-600" id="chefSignalementsResolus">0</div>
                    <div class="text-sm text-gray-600">R√©solus</div>
                </div>
                <div class="bg-white rounded-lg p-4 shadow">
                    <div class="text-2xl font-bold text-orange-600" id="chefSignalementsEnCours">0</div>
                    <div class="text-sm text-gray-600">En cours</div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-4 shadow">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-lg">Nouveau Signalement</h2>
                    <button onclick="showNewSignalementChef()" class="bg-blue-600 text-white px-4 py-2 rounded">
                        <i class="fas fa-plus mr-2"></i>Nouveau
                    </button>
                </div>
                <div id="chefSignalementsList" class="space-y-3">
                    <div class="text-center py-4">
                        <i class="fas fa-spinner fa-spin text-xl text-gray-400"></i>
                        <p class="mt-2 text-gray-600 text-sm">Chargement...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat IA -->
    <button id="chatToggle" class="chat-toggle" onclick="toggleChat()">
        <i class="fas fa-comments"></i>
    </button>
    
    <div id="chatContainer" class="chat-container">
        <div class="bg-green-600 text-white p-4 rounded-t-lg">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="font-bold">ASSISTANT ECITYZEN</h3>
                    <p class="text-sm opacity-90">ü§ñ IA e-cityzen Gabon</p>
                </div>
                <button onclick="toggleChat()" class="text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <div id="chatMessages" class="flex-1 p-4 overflow-y-auto bg-gray-50" style="height: 350px;">
            <div class="mb-4">
                <div class="bg-green-100 text-green-800 p-3 rounded-lg">
                    <strong>ASSISTANT ECITYZEN:</strong> Bonjour ! Je suis votre assistant e-cityzen. Comment puis-je vous aider aujourd'hui ? üá¨üá¶
                </div>
            </div>
        </div>
        
        <div class="p-4 border-t">
            <div class="flex gap-2">
                <input type="text" id="chatInput" class="flex-1 border rounded p-2" placeholder="Tapez votre question...">
                <button onclick="sendMessage()" class="bg-green-600 text-white px-4 py-2 rounded">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Notifications -->
    <div id="notification" class="notification"></div>

    <script>
        // Configuration API
        // IMPORTANT: Netlify ne peut pas ex√©cuter du PHP
        // Pour utiliser les APIs PHP en production, vous devez:
        // 1. H√©berger les APIs PHP sur un serveur s√©par√© (ex: votre serveur WAMP, ou un service comme Railway, Render, etc.)
        // 2. Modifier cette URL pour pointer vers votre serveur PHP
        // 3. Configurer CORS sur votre serveur PHP pour autoriser les requ√™tes depuis votre domaine Netlify
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'api'  // Local: utiliser les APIs locales
            : '';  // Production: vide = d√©sactiver les appels API PHP (seules login/register via Netlify Functions sont disponibles)
        
        // Si vous avez un serveur PHP en production, d√©commentez et remplissez cette ligne:
        // const API_BASE_URL_PRODUCTION = 'https://votre-serveur-php.com/api';
        
        // Configuration Supabase
        const SUPABASE_URL = 'https://srbzvjrqbhtuyzlwdghn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNyYnp2anJxYmh0dXl6bHdkZ2huIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNTg3NzQsImV4cCI6MjA3OTYzNDc3NH0.5KOkXAANWV_WLWPx02ozeC_xPCINd6boVtm3ia9iSmM';
        
        // Client Supabase (sera initialis√© apr√®s chargement)
        let supabaseClient = null;
        
        // √âtat global de l'application
        let currentUser = null;
        let currentProfile = null;
        
        // Variables pour les cartes
        let registerMap = null;
        let registerMarker = null;
        let signalementMap = null;
        let signalementMarker = null;
        
        // Coordonn√©es du Gabon (centr√© sur Libreville)
        const GABON_CENTER = [0.3901, 9.4540]; // Libreville
        const GABON_BOUNDS = [
            [-4.0, 8.0], // Sud-Ouest
            [2.5, 15.0]  // Nord-Est
        ];
        
        // Fonction helper pour les notifications (d√©finie t√¥t pour √™tre disponible partout)
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            
            notification.textContent = message;
            notification.className = `notification show bg-${type === 'success' ? 'green' : type === 'error' ? 'red' : type === 'warning' ? 'yellow' : 'blue'}-500`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }
        
        // Fonction helper pour les appels API
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include', // Inclure les cookies de session
                cache: 'no-cache' // Emp√™cher le cache
            };
            
            if (data && method !== 'GET') {
                // Ajouter les infos utilisateur pour les Netlify Functions
                if (!API_BASE_URL && currentUser) {
                    const dataToSend = { ...data };
                    dataToSend._user_id = currentUser.id;
                    dataToSend._user_role = currentUser.role;
                    options.body = JSON.stringify(dataToSend);
                } else {
                    options.body = JSON.stringify(data);
                }
            }
            
            // Construire l'URL selon l'environnement
            let url;
            const endpointClean = endpoint.replace('.php', '');
            
                    // Liste des Netlify Functions disponibles
                    const netlifyFunctions = ['login', 'register', 'signalements', 'demandes', 'notifications', 'geocode', 'chantiers', 'missions', 'users'];
            
            if (!API_BASE_URL) {
                // Production sans serveur PHP: utiliser Netlify Functions
                if (netlifyFunctions.includes(endpointClean)) {
                    url = `/.netlify/functions/${endpointClean}`;
                } else {
                    // Les autres endpoints n√©cessitent un serveur PHP
                    throw new Error(`L'endpoint ${endpointClean} n√©cessite un serveur PHP. Veuillez configurer un serveur PHP s√©par√©.`);
                }
            } else {
                // API PHP locale ou serveur PHP en production
                url = `${API_BASE_URL}/${endpoint}${endpoint.includes('.php') ? '' : '.php'}`;
            }
            
            // Pour les Netlify Functions en production, ajouter les infos utilisateur
            if (!API_BASE_URL && netlifyFunctions.includes(endpointClean) && currentUser) {
                if (method === 'GET') {
                    // Pour GET, ajouter les infos utilisateur dans l'URL AVANT le cache-busting
                    const separator = url.includes('?') ? '&' : '?';
                    url += `${separator}_user_id=${currentUser.id}&_user_role=${currentUser.role}`;
                } else if (data && typeof data === 'object') {
                    // Pour POST/PUT, ajouter user_id et user_role au body
                    data._user_id = currentUser.id;
                    data._user_role = currentUser.role;
                }
            }
            
            // Ajouter un param√®tre de cache-busting pour les requ√™tes GET (apr√®s les autres params)
            if (method === 'GET') {
                const separator = url.includes('?') ? '&' : '?';
                url += `${separator}_t=${Date.now()}`;
            }
            
            try {
                const response = await fetch(url, options);
                
                // G√©rer les erreurs 401 (Non authentifi√©)
                if (response.status === 401) {
                    // Si l'utilisateur n'est pas connect√©, rediriger vers la page de login
                    if (!currentUser) {
                        // Ne pas afficher de notification pour les tests de connexion automatiques
                        throw new Error('Non authentifi√©');
                    } else {
                        // Session expir√©e, d√©connecter l'utilisateur
                        showNotification('Votre session a expir√©. Veuillez vous reconnecter.', 'warning');
                        logout();
                        throw new Error('Session expir√©e');
                    }
                }
                
                // Lire le texte de la r√©ponse d'abord (pour g√©rer 403/409 avant le parsing JSON)
                const text = await response.text();
                
                // G√©rer les erreurs 403 (Acc√®s refus√© / Compte en attente)
                if (response.status === 403) {
                    let errorMessage = 'Acc√®s refus√©';
                    try {
                        const errorData = JSON.parse(text);
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        // Ignorer l'erreur de parsing
                    }
                    throw new Error(errorMessage);
                }
                
                // G√©rer les erreurs 409 (Conflit - t√©l√©phone d√©j√† utilis√©)
                if (response.status === 409) {
                    let errorMessage = 'Ce num√©ro de t√©l√©phone est d√©j√† utilis√©';
                    try {
                        const errorData = JSON.parse(text);
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        // Ignorer l'erreur de parsing
                    }
                    throw new Error(errorMessage);
                }
                
                // G√©rer les erreurs de parsing JSON
                let result;
                try {
                    result = text ? JSON.parse(text) : null;
                } catch (parseError) {
                    // Si la r√©ponse n'est pas du JSON (probablement une page HTML d'erreur 404)
                    if (response.status === 404) {
                        const endpointClean = endpoint.replace('.php', '');
                        throw new Error(`Endpoint ${endpointClean} non disponible. Pour utiliser cette fonctionnalit√© en production, vous devez h√©berger les APIs PHP sur un serveur s√©par√©.`);
                    }
                    console.error('Erreur parsing JSON:', parseError);
                    throw new Error('R√©ponse invalide du serveur');
                }
                
                if (!result || !result.success) {
                    throw new Error(result?.message || 'Erreur API');
                }
                
                return result;
            } catch (error) {
                // Ne pas afficher d'erreur si c'est une erreur d√©j√† g√©r√©e
                if (error.message === 'Non authentifi√©' || error.message === 'Session expir√©e') {
                    throw error; // Re-lancer sans afficher
                }
                
                // Ne pas afficher de notification pour les erreurs d'endpoints manquants si pas connect√©
                if (error.message && error.message.includes('non disponible') && !currentUser) {
                    throw error; // Silencieux pour √©viter de polluer la console
                }
                
                // Ne pas afficher d'erreur pour les tests de connexion automatiques (401)
                if (error.message && (error.message.includes('Non authentifi√©') || error.message === '401')) {
                    throw error;
                }
                
                // Pour les autres erreurs, logger seulement (les notifications seront g√©r√©es par les fonctions appelantes)
                if (error.message && !error.message.includes('en attente') && !error.message.includes('d√©j√† utilis√©')) {
                    console.error('Erreur API:', error);
                }
                
                throw error;
            }
        }
        
        // Types de signalements
        const signalementTypes = {
            'voirie': [
                'Nids-de-poule et chauss√©e d√©grad√©e',
                'Signalisation routi√®re d√©faillante', 
                '√âclairage public en panne',
                'Barri√®res et garde-corps endommag√©s',
                'Marquage au sol effac√©',
                'Feux tricolores d√©faillants'
            ],
            'assainissement': [
                'Caniveaux bouch√©s ou endommag√©s',
                '√âgouts √† ciel ouvert',
                'D√©chets sauvages et d√©potoirs',
                'Odeurs naus√©abondes',
                'Eaux stagnantes et moustiques',
                'Collecte ordures d√©faillante'
            ],
            'espaces-verts': [
                '√âlagage d\'arbres n√©cessaire',
                'Espaces verts mal entretenus',
                'Arbres dangereux ou malades',
                'Pollution sonore excessive',
                'Pollution de l\'air',
                'D√©forestation ill√©gale'
            ],
            'constructions': [
                'Constructions anarchiques',
                'Occupations ill√©gales du domaine public',
                'B√¢timents en ruine dangereux',
                'Travaux sans autorisation',
                'Cl√¥tures obstruant la voie publique',
                'Panneaux publicitaires sauvages'
            ],
            'securite': [
                'Zones mal √©clair√©es dangereuses',
                '√âquipements publics vandalis√©s',
                'Trous non signal√©s sur chauss√©e',
                'C√¢bles √©lectriques dangereux',
                'Animaux errants dangereux',
                'Points de vente de drogue'
            ],
            'corruption': [
                'Demande de pot-de-vin (anonyme)',
                'Corruption dans services publics',
                'Trafic d\'influence',
                'D√©tournement de fonds publics',
                'March√©s publics truqu√©s',
                'N√©potisme et favoritisme'
            ]
        };
        
        // Services administratifs
        const servicesAdmin = {
            'etat-civil': {
                services: [
                    'Acte de Naissance',
                    'Acte de D√©c√®s',
                    'Attestation / Certificat de Retraite',
                    'Certificat de R√©sidence',
                    'Autres d√©marches (Attestation de vie, l√©galisation, changement d\'√©tat civil)'
                ],
                tarifs: [5000, 8000, 6000, 3000, 7000],
                documents: [
                    'Pi√®ce d\'identit√© + Photocopie (d√©claration dans les 3 jours apr√®s accouchement, ou jugement suppl√©tif si d√©lai d√©pass√©)',
                    'Certificat m√©dical de d√©c√®s + Pi√®ce d\'identit√© du d√©funt + Acte de naissance du d√©funt',
                    'Bulletin de pension + Pi√®ce d\'identit√© + Justificatifs de services',
                    'Justificatif de domicile + Facture r√©cente + Pi√®ce d\'identit√©',
                    'Documents originaux √† l√©galiser + Acte de naissance + Pi√®ce d\'identit√©'
                ]
            },
            'cadastre-urbanisme': {
                services: [
                    'Permis de Construire',
                    'Permis de D√©molir',
                    'ODDC (Occupation du Domaine Communal)'
                ],
                tarifs: [45000, 30000, 20000],
                documents: [
                    'Plans architecturaux vis√©s + √âtude g√©otechnique + Certificat de propri√©t√©',
                    'Rapport technique + √âtude d\'impact + Plans de d√©molition',
                    'Plan d\'implantation + Description des activit√©s + Attestation d\'assurance'
                ]
            },
            'service-social': {
                services: [
                    'Demande d\'aide solidaire individuelle',
                    'Demande d\'aide solidaire collective',
                    'Accompagnement social d\'urgence'
                ],
                tarifs: [0, 0, 0],
                documents: [
                    'Lettre motiv√©e + Pi√®ce d\'identit√© + Justificatifs de revenus',
                    'Lettre des repr√©sentants + Liste des b√©n√©ficiaires + Budget pr√©visionnel',
                    'Rapport d\'assistante sociale + Pi√®ce d\'identit√© + Justificatifs d\'urgence'
                ]
            },
            'voiries': {
                services: [
                    'Contr√¥les et visites quotidiennes',
                    'Actions ponctuelles planifi√©es',
                    'Interventions sur interpellation/d√©nonciation'
                ],
                tarifs: [0, 0, 0],
                documents: [
                    'Planning de tourn√©e + Liste des axes √† inspecter',
                    'Ordre de mission + Fiches techniques des travaux',
                    'Lettre d\'interpellation / signalement citoyen + Coordonn√©es du site'
                ]
            },
            'finances': {
                services: [
                    'Gestion du transport municipal',
                    'Traitement de la paie des agents',
                    'Gestion des r√©gies municipales',
                    'Ordres de recettes',
                    'Traitement des fournisseurs'
                ],
                tarifs: [0, 0, 0, 0, 0],
                documents: [
                    'Planning des navettes + Engagement de d√©pense + Liste du personnel',
                    '√âtats de pr√©sence + Fiche agent + Relev√©s bancaires',
                    'Registres des r√©gies + Rapports de caisse + Pi√®ces justificatives',
                    'Pi√®ces comptables + Engagement budg√©taire + Visa du contr√¥leur',
                    'Bon de commande + Facture + Certificat de service fait'
                ]
            },
            'hopital': {
                services: [
                    'Acte de Naissance (D√©claration)',
                    'Acte de D√©c√®s (D√©claration)',
                    'Acte de Mariage (C√©l√©bration)',
                    'Certificat m√©dical de naissance',
                    'Certificat m√©dical de d√©c√®s',
                    'Attestation d\'hospitalisation'
                ],
                tarifs: [0, 0, 15000, 5000, 8000, 3000],
                documents: [
                    'Fiche de naissance remplie + Pi√®ce d\'identit√© parents + Acte de mariage (si mari√©s) - D√©claration dans les 3 jours apr√®s accouchement',
                    'Certificat m√©dical de d√©c√®s + Pi√®ce d\'identit√© d√©funt + Acte de naissance d√©funt - D√©claration et √©tablissement de l\'acte',
                    'Actes de naissance des deux √©poux + Pi√®ce d\'identit√© + Certificat m√©dical pr√©nuptial + 2 t√©moins majeurs - C√©l√©bration et √©tablissement de l\'acte',
                    'Rapport m√©dical de naissance sign√© par m√©decin',
                    'Rapport m√©dical de d√©c√®s sign√© par m√©decin',
                    'Justificatif d\'hospitalisation + Pi√®ce d\'identit√© patient'
                ]
            }
        };
        
        // R√©ponses de l'IA
        const aiResponses = {
            'salut': 'Bonjour ! Je suis ASSISTANT ECITYZEN, votre assistant e-cityzen. Comment puis-je vous aider ?',
            'bonjour': 'Bonjour ! Ravi de vous retrouver. Que puis-je faire pour vous aujourd\'hui ?',
            'aide': 'Je peux vous aider avec vos d√©marches administratives, signalements, paiements et bien plus !',
            'comment': 'Posez-moi votre question, je vous guiderai √©tape par √©tape.',
            'signalement': 'Pour faire un signalement, cliquez sur "Nouveau Signalement" puis choisissez la cat√©gorie appropri√©e. Vous pouvez joindre une photo et votre position GPS.',
            'demande': 'Pour une demande administrative, allez dans "Nouvelle Demande", s√©lectionnez le service et suivez les √©tapes. Je calculerai automatiquement les co√ªts.',
            'paiement': 'Nous acceptons ClickPay, Airtel Money, Moov Money, cartes bancaires et paiements esp√®ces via nos agents.',
            'patente': 'Pour votre patente commerciale au Gabon : Base = Chiffre d\'affaires d√©clar√© √ó 2.5% (commerce) ou 1.8% (services). Minimum 25,000 FCFA, Maximum 500,000 FCFA.',
            'permis construire': 'Pour un permis de construire : Plan architectural sign√©, √©tude g√©otechnique, certificat de propri√©t√©. Co√ªt : 45,000 FCFA r√©sidentiel, 125,000 FCFA commercial. D√©lai : 21 jours ouvrables.',
            'acte naissance': 'Acte de naissance : Pi√®ce d\'identit√© + photocopie. Co√ªt : 5,000 FCFA. D√©lai : 48h.',
            'corruption': 'Pour signaler des actes de corruption, utilisez notre canal s√©curis√© et anonyme. Vos informations sont prot√©g√©es.',
            'contact': 'Vous pouvez me poser toutes vos questions ici, ou contacter nos agents via les diff√©rents services.',
            'merci': 'De rien ! Je suis l√† pour vous aider. N\'h√©sitez pas si vous avez d\'autres questions !',
            'default': 'Je n\'ai pas bien compris votre question. Pouvez-vous la reformuler ? Je peux vous aider avec les signalements, demandes administratives, paiements, etc.'
        };

        // Fonction pour basculer entre les onglets
        function switchTab(tab) {
            const loginTab = document.getElementById('tabLogin');
            const registerTab = document.getElementById('tabRegister');
            const loginContainer = document.getElementById('loginFormContainer');
            const registerContainer = document.getElementById('registerFormContainer');
            
            if (tab === 'login') {
                loginTab.classList.add('border-b-2', 'border-green-600', 'text-green-600');
                loginTab.classList.remove('text-gray-500');
                registerTab.classList.remove('border-b-2', 'border-green-600', 'text-green-600');
                registerTab.classList.add('text-gray-500');
                loginContainer.classList.remove('hidden');
                registerContainer.classList.add('hidden');
            } else {
                registerTab.classList.add('border-b-2', 'border-green-600', 'text-green-600');
                registerTab.classList.remove('text-gray-500');
                loginTab.classList.remove('border-b-2', 'border-green-600', 'text-green-600');
                loginTab.classList.add('text-gray-500');
                registerContainer.classList.remove('hidden');
                loginContainer.classList.add('hidden');
                
                // S'assurer que la carte est initialis√©e quand le formulaire d'inscription est affich√©
                setTimeout(() => {
                    const mapContainer = document.getElementById('registerMap');
                    if (mapContainer) {
                        // V√©rifier qu'il n'y a pas d√©j√† une carte initialis√©e
                        if (mapContainer._leaflet_id && !registerMap) {
                            delete mapContainer._leaflet_id;
                            mapContainer.innerHTML = '';
                        }
                        if (!registerMap) {
                            // Attendre que le conteneur soit visible
                            setTimeout(() => {
                                initRegisterMap();
                                if (registerMap) {
                                    setTimeout(() => {
                                        registerMap.invalidateSize();
                                    }, 100);
                                }
                            }, 100);
                        } else {
                            registerMap.invalidateSize();
                        }
                    }
                }, 100);
            }
        }
        
        // Initialiser la carte d'inscription
        function initRegisterMap() {
            const mapContainer = document.getElementById('registerMap');
            if (!mapContainer) {
                console.error('Conteneur registerMap non trouv√©');
                return;
            }
            
            // V√©rifier que les constantes sont d√©finies
            if (typeof GABON_CENTER === 'undefined' || !Array.isArray(GABON_CENTER) || GABON_CENTER.length !== 2) {
                console.error('GABON_CENTER n\'est pas d√©fini correctement');
                return;
            }
            
            // V√©rifier si Leaflet a d√©j√† initialis√© ce conteneur
            if (mapContainer._leaflet_id) {
                console.log('Suppression de la carte d\'inscription existante (ID:', mapContainer._leaflet_id + ')');
                try {
                    if (registerMap) {
                        registerMap.remove();
                    }
                } catch(e) {
                    console.warn('Erreur lors de la suppression de la carte:', e);
                }
                // R√©initialiser l'ID Leaflet
                delete mapContainer._leaflet_id;
            }
            
            // Si la carte existe d√©j√†, la supprimer d'abord
            if (registerMap) {
                try {
                    registerMap.remove();
                } catch(e) {
                    console.warn('Erreur lors de la suppression de la carte:', e);
                }
                registerMap = null;
                registerMarker = null;
            }
            
            // Vider le conteneur pour √©viter les conflits
            mapContainer.innerHTML = '';
            
            // Cr√©er la carte centr√©e sur le Gabon
            try {
                registerMap = L.map('registerMap', {
                    center: GABON_CENTER,
                    zoom: 7,
                    minZoom: 6,
                    maxBounds: GABON_BOUNDS,
                    maxBoundsViscosity: 1.0
                });
                console.log('Carte d\'inscription cr√©√©e avec succ√®s');
            } catch(e) {
                console.error('Erreur lors de la cr√©ation de la carte d\'inscription:', e);
                return;
            }
            
            // Ajouter la couche de tuiles OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(registerMap);
            
            // Marqueur par d√©faut sur Libreville
            registerMarker = L.marker(GABON_CENTER, {
                draggable: true
            }).addTo(registerMap);
            
            // Mettre √† jour la localisation quand le marqueur est d√©plac√©
            registerMarker.on('dragend', function(e) {
                const lat = e.target.getLatLng().lat;
                const lng = e.target.getLatLng().lng;
                updateRegisterLocation(lat, lng);
            });
            
            // Mettre √† jour la localisation quand on clique sur la carte
            registerMap.on('click', function(e) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                registerMarker.setLatLng([lat, lng]);
                updateRegisterLocation(lat, lng);
            });
            
            // Initialiser avec Libreville
            updateRegisterLocation(GABON_CENTER[0], GABON_CENTER[1]);
        }
        
        // Mettre √† jour la localisation dans le formulaire d'inscription
        async function updateRegisterLocation(lat, lng) {
            document.getElementById('registerLatitude').value = lat;
            document.getElementById('registerLongitude').value = lng;
            
            // Afficher les coordonn√©es par d√©faut
            const coordsText = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            document.getElementById('registerCoords').textContent = coordsText;
            
            // Charger l'adresse compl√®te via notre API
            try {
                const geocodeUrl = !API_BASE_URL 
                    ? `/.netlify/functions/geocode?lat=${lat}&lng=${lng}&_t=${Date.now()}`
                    : `${API_BASE_URL}/geocode.php?lat=${lat}&lng=${lng}&_t=${Date.now()}`;
                
                const response = await fetch(geocodeUrl);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const data = result.data;
                    
                    // Afficher l'adresse compl√®te
                    document.getElementById('registerLocalisation').value = data.adresse_complete || data.display_name || coordsText;
                    
                    // Afficher les d√©tails
                    document.getElementById('registerQuartier').textContent = data.quartier || '-';
                    document.getElementById('registerVille').textContent = data.ville || 'Libreville';
                    document.getElementById('registerArrondissement').textContent = data.arrondissement || '-';
                } else {
                    // Si le g√©ocodage √©choue, afficher juste les coordonn√©es
                    document.getElementById('registerLocalisation').value = coordsText;
                    document.getElementById('registerQuartier').textContent = '-';
                    document.getElementById('registerVille').textContent = 'Libreville';
                    document.getElementById('registerArrondissement').textContent = '-';
                }
            } catch (error) {
                console.log('G√©ocodage non disponible:', error);
                // En cas d'erreur, afficher les coordonn√©es
                document.getElementById('registerLocalisation').value = coordsText;
                document.getElementById('registerQuartier').textContent = '-';
                document.getElementById('registerVille').textContent = 'Libreville';
                document.getElementById('registerArrondissement').textContent = '-';
            }
        }
        
        // Initialiser la carte de signalement
        function initSignalementMap() {
            const mapContainer = document.getElementById('signalementMap');
            if (!mapContainer) {
                console.error('Conteneur signalementMap non trouv√©');
                return;
            }
            
            // V√©rifier que les constantes sont d√©finies
            if (typeof GABON_CENTER === 'undefined' || !Array.isArray(GABON_CENTER) || GABON_CENTER.length !== 2) {
                console.error('GABON_CENTER n\'est pas d√©fini correctement');
                return;
            }
            
            // V√©rifier que le conteneur a une hauteur
            const height = mapContainer.offsetHeight || mapContainer.clientHeight || 180;
            if (height === 0) {
                mapContainer.style.height = '180px';
                mapContainer.style.minHeight = '180px';
            }
            
            // V√©rifier si Leaflet a d√©j√† initialis√© ce conteneur
            if (mapContainer._leaflet_id) {
                console.log('Suppression de la carte existante (ID:', mapContainer._leaflet_id + ')');
                try {
                    if (signalementMap) {
                        signalementMap.remove();
                    }
                } catch(e) {
                    console.warn('Erreur lors de la suppression de la carte:', e);
                }
                // R√©initialiser l'ID Leaflet
                delete mapContainer._leaflet_id;
            }
            
            // Si la carte existe d√©j√†, la supprimer d'abord
            if (signalementMap) {
                try {
                    signalementMap.remove();
                } catch(e) {
                    console.warn('Erreur lors de la suppression de la carte:', e);
                }
                signalementMap = null;
                signalementMarker = null;
            }
            
            // Vider le conteneur pour √©viter les conflits
            mapContainer.innerHTML = '';
            
            console.log('Cr√©ation de la carte Leaflet, hauteur conteneur:', height);
            
            // Cr√©er la carte centr√©e sur le Gabon
            try {
                signalementMap = L.map('signalementMap', {
                    center: GABON_CENTER,
                    zoom: 7,
                    minZoom: 6,
                    maxBounds: GABON_BOUNDS,
                    maxBoundsViscosity: 1.0,
                    preferCanvas: false
                });
                console.log('Carte cr√©√©e avec succ√®s');
            } catch(e) {
                console.error('Erreur lors de la cr√©ation de la carte:', e);
                return;
            }
            
            // Ajouter la couche de tuiles OpenStreetMap
            const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 18,
                subdomains: ['a', 'b', 'c']
            });
            
            tileLayer.addTo(signalementMap);
            
            // √âcouter les erreurs de chargement des tuiles
            tileLayer.on('tileerror', function(error, tile) {
                console.warn('Erreur de chargement de tuile:', error);
            });
            
            // Forcer le chargement des tuiles quand la carte est pr√™te
            signalementMap.whenReady(() => {
                console.log('Carte pr√™te, invalidation de la taille');
                setTimeout(() => {
                    if (signalementMap && GABON_CENTER && Array.isArray(GABON_CENTER) && GABON_CENTER.length === 2) {
                        signalementMap.invalidateSize();
                        signalementMap.setView(GABON_CENTER, 7, {animate: false, reset: true});
                        console.log('Vue de la carte d√©finie');
                    } else {
                        console.error('Impossible de d√©finir la vue: GABON_CENTER invalide ou carte non disponible');
                    }
                }, 150);
                
                // Forcer le rechargement apr√®s un d√©lai suppl√©mentaire
                setTimeout(() => {
                    if (signalementMap) {
                        signalementMap.invalidateSize();
                        tileLayer.redraw();
                        console.log('Tuiles redessin√©es');
                    }
                }, 500);
            });
            
            // Marqueur par d√©faut sur Libreville
            if (typeof GABON_CENTER !== 'undefined' && Array.isArray(GABON_CENTER) && GABON_CENTER.length === 2) {
                signalementMarker = L.marker(GABON_CENTER, {
                    draggable: true
                }).addTo(signalementMap);
                
                // Mettre √† jour la localisation quand le marqueur est d√©plac√©
                signalementMarker.on('dragend', function(e) {
                    const lat = e.target.getLatLng().lat;
                    const lng = e.target.getLatLng().lng;
                    updateSignalementLocation(lat, lng);
                });
                
                // Mettre √† jour la localisation quand on clique sur la carte
                signalementMap.on('click', function(e) {
                    const lat = e.latlng.lat;
                    const lng = e.latlng.lng;
                    signalementMarker.setLatLng([lat, lng]);
                    updateSignalementLocation(lat, lng);
                });
                
                // Initialiser avec Libreville
                updateSignalementLocation(GABON_CENTER[0], GABON_CENTER[1]);
            } else {
                console.error('GABON_CENTER invalide, impossible de cr√©er le marqueur');
            }
        }
        
        // Mettre √† jour la localisation dans le formulaire de signalement
        async function updateSignalementLocation(lat, lng) {
            document.getElementById('signalementLatitude').value = lat;
            document.getElementById('signalementLongitude').value = lng;
            
            // Afficher les coordonn√©es par d√©faut
            const coordsText = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            document.getElementById('signalementCoords').textContent = coordsText;
            
            // Charger l'adresse compl√®te via notre API
            try {
                const geocodeUrl = !API_BASE_URL 
                    ? `/.netlify/functions/geocode?lat=${lat}&lng=${lng}&_t=${Date.now()}`
                    : `${API_BASE_URL}/geocode.php?lat=${lat}&lng=${lng}&_t=${Date.now()}`;
                
                const response = await fetch(geocodeUrl);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const data = result.data;
                    
                    // Afficher l'adresse compl√®te
                    document.getElementById('signalementLocalisation').value = data.adresse_complete || data.display_name || coordsText;
                    
                    // Afficher les d√©tails
                    document.getElementById('signalementQuartier').textContent = data.quartier || '-';
                    document.getElementById('signalementVille').textContent = data.ville || 'Libreville';
                    document.getElementById('signalementArrondissement').textContent = data.arrondissement || '-';
                } else {
                    // Si le g√©ocodage √©choue, afficher juste les coordonn√©es
                    document.getElementById('signalementLocalisation').value = coordsText;
                    document.getElementById('signalementQuartier').textContent = '-';
                    document.getElementById('signalementVille').textContent = 'Libreville';
                    document.getElementById('signalementArrondissement').textContent = '-';
                }
            } catch (error) {
                console.log('G√©ocodage non disponible:', error);
                // En cas d'erreur, afficher les coordonn√©es
                document.getElementById('signalementLocalisation').value = coordsText;
                document.getElementById('signalementQuartier').textContent = '-';
                document.getElementById('signalementVille').textContent = 'Libreville';
                document.getElementById('signalementArrondissement').textContent = '-';
            }
        }
        
        // Gestion du changement de r√¥le dans le formulaire d'inscription
        document.getElementById('registerRole')?.addEventListener('change', function() {
            const role = this.value;
            const localisationContainer = document.getElementById('registerLocalisationContainer');
            const entrepriseContainer = document.getElementById('registerEntrepriseContainer');
            
            if (role === 'commercant' || role === 'hopital') {
                localisationContainer.classList.remove('hidden');
                entrepriseContainer.classList.remove('hidden');
                // Initialiser la carte si elle n'existe pas encore
                setTimeout(() => {
                    const mapContainer = document.getElementById('registerMap');
                    if (!mapContainer) return;
                    
                    // V√©rifier qu'il n'y a pas d√©j√† une carte initialis√©e
                    if (mapContainer._leaflet_id) {
                        delete mapContainer._leaflet_id;
                        mapContainer.innerHTML = '';
                    }
                    
                    if (!registerMap) {
                        initRegisterMap();
                        // Attendre un peu plus pour que le conteneur soit visible
                        setTimeout(() => {
                            if (registerMap) {
                                registerMap.invalidateSize();
                            }
                        }, 100);
                    } else {
                        registerMap.invalidateSize();
                        // Recalculer √† nouveau apr√®s un court d√©lai
                        setTimeout(() => {
                            registerMap.invalidateSize();
                        }, 200);
                    }
                }, 200);
            } else {
                localisationContainer.classList.add('hidden');
                entrepriseContainer.classList.add('hidden');
            }
        });
        
        // Gestion du formulaire de connexion
        document.getElementById('loginForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const telephone = document.getElementById('loginTelephone').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!telephone || !password) {
                showNotification('Veuillez remplir tous les champs', 'error');
                return;
            }
            
            try {
                showNotification('Connexion en cours...', 'info');
                
                // Utiliser Netlify Function si sur Netlify, sinon utiliser l'API PHP locale
                const endpoint = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
                    ? 'login.php'  // Local: utiliser l'API PHP
                    : 'login';     // Production: utiliser Netlify Function
                
                const result = await apiCall(endpoint, 'POST', {
                    telephone: telephone,
                    mot_de_passe: password
                });
                
                currentUser = result.data;
                currentProfile = result.data.role;
                
                // Masquer la page de connexion avec animation
                const loginPage = document.getElementById('loginPage');
                loginPage.style.opacity = '0';
                loginPage.style.transform = 'scale(0.95)';
                
                setTimeout(() => {
                    loginPage.classList.add('hidden');
                    
                    // Afficher le dashboard appropri√© avec animation
                    const dashboard = document.getElementById(currentProfile + 'Dashboard');
                    if (dashboard) {
                    dashboard.classList.remove('hidden');
                    dashboard.style.opacity = '0';
                    dashboard.style.transform = 'translateY(20px)';
                    
                    setTimeout(() => {
                        dashboard.style.transition = 'all 0.5s ease';
                        dashboard.style.opacity = '1';
                        dashboard.style.transform = 'translateY(0)';
                    }, 50);
                    
                    // Charger les donn√©es r√©elles
                        loadDashboardData(currentProfile);
                    
                    // Initialiser les graphiques si n√©cessaire
                        if (currentProfile === 'manager') {
                        setTimeout(() => initManagerChart(), 300);
                        } else if (currentProfile === 'superadmin') {
                        setTimeout(() => initAdminChart(), 300);
                        }
                    }
                }, 300);
                
                showNotification(`Connexion r√©ussie ! Bienvenue ${currentUser.name}`, 'success');
            } catch (error) {
                // Ne pas afficher d'erreur pour les erreurs 401/403/409 normales
                if (error.message && (error.message.includes('Non authentifi√©') || error.message.includes('Session expir√©e'))) {
                    return; // Erreur d√©j√† g√©r√©e
                }
                
                // Afficher le message d'erreur appropri√©
                const message = error.message || 'Erreur de connexion. V√©rifiez votre num√©ro de t√©l√©phone et votre mot de passe.';
                showNotification(message, error.message && error.message.includes('en attente') ? 'warning' : 'error');
            }
        });
        
        // Gestion du formulaire d'inscription
        document.getElementById('registerForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const nom = document.getElementById('registerNom').value.trim();
            const prenom = document.getElementById('registerPrenom').value.trim();
            const telephone = document.getElementById('registerTelephone').value.trim();
            const password = document.getElementById('registerPassword').value;
            const role = document.getElementById('registerRole').value;
                const localisation = document.getElementById('registerLocalisation').value.trim();
                const latitude = document.getElementById('registerLatitude').value;
                const longitude = document.getElementById('registerLongitude').value;
                const entreprise = document.getElementById('registerEntreprise').value.trim();
                
                if (!nom || !prenom || !telephone || !password || !role) {
                    showNotification('Veuillez remplir tous les champs obligatoires', 'error');
                    return;
                }
                
                if (password.length < 6) {
                    showNotification('Le mot de passe doit contenir au moins 6 caract√®res', 'error');
                    return;
                }
                
                try {
                    showNotification('Cr√©ation du compte en cours...', 'info');
                    
                    const registerData = {
                        nom: nom + ' ' + prenom,
                        prenom: prenom,
                        telephone: telephone,
                        mot_de_passe: password,
                        role: role
                    };
                    
                    if (localisation) {
                        registerData.localisation = localisation;
                        if (latitude) registerData.latitude = parseFloat(latitude);
                        if (longitude) registerData.longitude = parseFloat(longitude);
                    }
                    if (entreprise) registerData.entreprise = entreprise;
                
                // Utiliser Netlify Function si sur Netlify, sinon utiliser l'API PHP locale
                let result;
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    // Local: utiliser l'API PHP
                    result = await apiCall('register.php', 'POST', registerData);
                } else {
                    // Production: utiliser Netlify Function (sans .php)
                    result = await apiCall('register', 'POST', registerData);
                }
                
                // V√©rifier si l'utilisateur est un agent en attente
                if (result.data && result.data.role === 'agent' && result.data.statut === 'en_attente') {
                    // Agent en attente - ne pas connecter
                    showNotification(result.message || 'Votre demande d\'inscription a √©t√© soumise. Elle sera valid√©e par un manager sous peu. Vous ne pourrez pas vous connecter tant que votre compte n\'est pas valid√©.', 'warning');
                    
                    // R√©initialiser le formulaire
                    document.getElementById('registerForm').reset();
                    
                    // Revenir √† l'onglet connexion
                    const loginTab = document.getElementById('tabLogin');
                    if (loginTab) {
                        // Utiliser la fonction switchTab si elle existe, sinon cliquer sur le bouton
                        if (typeof switchTab === 'function') {
                            switchTab('login');
                        } else {
                            loginTab.click();
                        }
                    }
                    return;
                }
                
                // Pour les autres utilisateurs, connecter normalement
                if (!result.success || !result.data) {
                    throw new Error(result.message || 'Erreur lors de la cr√©ation du compte');
                }
                
                currentUser = result.data;
                currentProfile = result.data.role;
                
                // Masquer la page de connexion avec animation
                const loginPage = document.getElementById('loginPage');
                loginPage.style.opacity = '0';
                loginPage.style.transform = 'scale(0.95)';
                
                setTimeout(() => {
                    loginPage.classList.add('hidden');
                    
                    // Afficher le dashboard appropri√© avec animation
                    // G√©rer les cas sp√©ciaux pour les IDs de dashboard
                    let dashboardId = currentProfile + 'Dashboard';
                    if (currentProfile === 'chef_quartier') {
                        dashboardId = 'chefQuartierDashboard';
                    }
                    const dashboard = document.getElementById(dashboardId);
                    if (dashboard) {
                        dashboard.classList.remove('hidden');
                        dashboard.style.opacity = '0';
                        dashboard.style.transform = 'translateY(20px)';
                        
                        setTimeout(() => {
                            dashboard.style.transition = 'all 0.5s ease';
                            dashboard.style.opacity = '1';
                            dashboard.style.transform = 'translateY(0)';
                        }, 50);
                        
                        // Charger les donn√©es r√©elles
                        loadDashboardData(currentProfile);
                        
                        // Initialiser les graphiques si n√©cessaire
                        if (currentProfile === 'manager') {
                            setTimeout(() => initManagerChart(), 300);
                        } else if (currentProfile === 'superadmin') {
                            setTimeout(() => initAdminChart(), 300);
                        }
                    }
                }, 300);
                
                showNotification(result.message || `Compte cr√©√© avec succ√®s ! Bienvenue ${currentUser.name}`, 'success');
            } catch (error) {
                // Afficher le message d'erreur appropri√© (d√©j√† g√©r√© pour les agents en attente)
                if (error.message && !error.message.includes('en attente')) {
                    showNotification(error.message || 'Erreur lors de la cr√©ation du compte', 'error');
                }
            }
        });
        
        // Mettre √† jour les informations utilisateur dans les dashboards
        function updateUserInfo() {
            if (!currentUser) return;
            
            const name = currentUser.name || 'Utilisateur';
            const location = currentUser.location || '';
            const sector = currentUser.sector || '';
            const business = currentUser.business || '';
            
            // Dashboard Citoyen
            const citoyenGreeting = document.getElementById('citoyenGreeting');
            const citoyenInfo = document.getElementById('citoyenInfo');
            if (citoyenGreeting) citoyenGreeting.textContent = `Bonjour ${name.split(' ')[0]}`;
            if (citoyenInfo) {
                let info = name;
                if (location) info += ` ‚Ä¢ ${location}`;
                citoyenInfo.textContent = info;
            }
            
            // Dashboard Commer√ßant
            const commercantInfo = document.getElementById('commercantInfo');
            if (commercantInfo) {
                let info = name;
                if (business) info += ` ‚Ä¢ ${business}`;
                else if (location) info += ` ‚Ä¢ ${location}`;
                commercantInfo.textContent = info;
            }
            
            // Dashboard Agent
            const agentInfo = document.getElementById('agentInfo');
            if (agentInfo) {
                let info = name;
                if (sector) info += ` ‚Ä¢ Secteur ${sector}`;
                else if (location) info += ` ‚Ä¢ ${location}`;
                agentInfo.textContent = info;
            }
            
            // Dashboard Manager
            const managerInfo = document.getElementById('managerInfo');
            if (managerInfo) {
                let info = name;
                if (sector) info += ` ‚Ä¢ ${sector}`;
                else info += ' ‚Ä¢ Responsable Services Citoyens';
                managerInfo.textContent = info;
            }
            
            // Dashboard H√¥pital
            const hopitalInfo = document.getElementById('hopitalInfo');
            if (hopitalInfo) {
                let info = name;
                if (business) info += ` ‚Ä¢ ${business}`;
                else if (location) info += ` ‚Ä¢ ${location}`;
                hopitalInfo.textContent = info;
            }
            
            // Dashboard Super Admin
            const superadminInfo = document.getElementById('superadminInfo');
            if (superadminInfo) {
                let info = name;
                info += ' ‚Ä¢ Administrateur Syst√®me';
                superadminInfo.textContent = info;
            }
        }
        
        // Charger les donn√©es du ruban d'information
        async function loadInfoRibbon() {
            const ribbon = document.getElementById('infoRibbon');
            if (!ribbon) return;
            
            try {
                // Afficher le ruban
                ribbon.classList.remove('hidden');
                
                // Charger les donn√©es
                const [chantiersResult, notificationsResult] = await Promise.all([
                    apiCall('chantiers.php').catch(() => ({ data: [] })),
                    apiCall('notifications.php').catch(() => ({ data: { notifications: [], non_lues: 0 } }))
                ]);
                
                const chantiers = chantiersResult.data || [];
                const notifications = notificationsResult.data || {};
                const nonLues = notifications.non_lues || 0;
                
                // Mettre √† jour les compteurs
                const travauxCount = document.getElementById('travauxCount');
                const notificationsCount = document.getElementById('notificationsCount');
                
                if (travauxCount) {
                    const actifs = chantiers.filter(c => c.statut === 'en_cours' || c.statut === 'planifie').length;
                    travauxCount.textContent = actifs;
                    travauxCount.classList.toggle('hidden', actifs === 0);
                }
                
                if (notificationsCount) {
                    notificationsCount.textContent = nonLues;
                    notificationsCount.classList.toggle('hidden', nonLues === 0);
                }
            } catch (error) {
                console.error('Erreur chargement ruban:', error);
            }
        }
        
        // Charger les donn√©es du dashboard
        async function loadDashboardData(profile) {
            try {
                // Mettre √† jour les informations utilisateur
                updateUserInfo();
                
                // Charger le ruban d'information
                await loadInfoRibbon();
                
                if (profile === 'citoyen') {
                    await loadCitoyenData();
                } else if (profile === 'commercant') {
                    await loadCommercantData();
                } else if (profile === 'hopital') {
                    await loadHopitalData();
                } else if (profile === 'agent') {
                    await loadAgentData();
                } else if (profile === 'manager' || profile === 'superadmin') {
                    await loadManagerData();
                } else if (profile === 'chef_quartier') {
                    await loadChefQuartierData();
                }
                
                // Charger les notifications pour tous les profils
                try {
                    const notificationsResult = await apiCall('notifications.php').catch(() => ({ data: { notifications: [], non_lues: 0 } }));
                    if (notificationsResult.data && notificationsResult.data.non_lues > 0) {
                        const notificationBadge = document.getElementById('notificationBadge');
                        if (notificationBadge) {
                            notificationBadge.textContent = notificationsResult.data.non_lues > 9 ? '9+' : notificationsResult.data.non_lues;
                            notificationBadge.classList.remove('hidden');
                        }
                    }
                } catch (error) {
                    console.warn('Erreur chargement notifications:', error);
                }
            } catch (error) {
                console.error('Erreur chargement donn√©es:', error);
            }
        }
        
        // Charger les donn√©es h√¥pital
        async function loadHopitalData() {
            try {
                // Charger les demandes li√©es aux h√¥pitaux
                const demandesResult = await apiCall('demandes.php');
                const demandesHopital = (demandesResult.data || []).filter(d => 
                    d.service && (d.service.includes('D√©claration') || d.service.includes('Certificat') || 
                    d.service.includes('Naissance') || d.service.includes('naissance') ||
                    d.service.includes('D√©c√®s') || d.service.includes('d√©c√®s') ||
                    d.service.includes('Mariage') || d.service.includes('mariage') ||
                    d.service.includes('Acte'))
                );
                
                // Filtrer par mois actuel
                const aujourdhui = new Date();
                const moisActuel = aujourdhui.getMonth();
                const anneeActuelle = aujourdhui.getFullYear();
                
                const demandesCeMois = demandesHopital.filter(d => {
                    if (!d.date_creation) return false;
                    const dateCreation = new Date(d.date_creation);
                    return dateCreation.getMonth() === moisActuel && dateCreation.getFullYear() === anneeActuelle;
                });
                
                // Mettre √† jour les statistiques
                updateHopitalStats(demandesCeMois, demandesHopital);
                
                // Mettre √† jour les d√©clarations r√©centes
                updateHopitalDeclarations(demandesHopital);
                
            } catch (error) {
                console.error('Erreur chargement donn√©es h√¥pital:', error);
            }
        }
        
        // Mettre √† jour les statistiques de l'h√¥pital
        function updateHopitalStats(demandesCeMois, demandesTotal) {
            const naissancesDiv = document.getElementById('hopitalNaissances');
            const decesDiv = document.getElementById('hopitalDeces');
            
            const naissances = demandesCeMois.filter(d => 
                d.service && (d.service.includes('Naissance') || d.service.includes('naissance') || d.service.includes('Acte de Naissance'))
            ).length;
            const deces = demandesCeMois.filter(d => 
                d.service && (d.service.includes('D√©c√®s') || d.service.includes('d√©c√®s') || d.service.includes('Acte de D√©c√®s'))
            ).length;
            
            if (naissancesDiv) {
                naissancesDiv.textContent = naissances;
            }
            if (decesDiv) {
                decesDiv.textContent = deces;
            }
            if (decesDiv) {
                decesDiv.textContent = deces;
            }
            
            // Mettre √† jour les statistiques mensuelles
            const statsMensuelles = document.getElementById('hopitalStatsMensuelles');
            if (statsMensuelles && statsMensuelles.children.length >= 3) {
                const naissancesTotal = demandesTotal.filter(d => 
                    d.service && (d.service.includes('Naissance') || d.service.includes('naissance'))
                ).length;
                const decesTotal = demandesTotal.filter(d => 
                    d.service && (d.service.includes('D√©c√®s') || d.service.includes('d√©c√®s'))
                ).length;
                
                if (statsMensuelles.children[0]) {
                    const valueDiv = statsMensuelles.children[0].querySelector('.text-xl');
                    if (valueDiv) valueDiv.textContent = naissancesTotal;
                }
                if (statsMensuelles.children[1]) {
                    const valueDiv = statsMensuelles.children[1].querySelector('.text-xl');
                    if (valueDiv) valueDiv.textContent = decesTotal;
                }
                if (statsMensuelles.children[2]) {
                    const valueDiv = statsMensuelles.children[2].querySelector('.text-xl');
                    if (valueDiv) valueDiv.textContent = naissancesTotal + decesTotal;
                }
            }
        }
        
        // Mettre √† jour les d√©clarations r√©centes
        function updateHopitalDeclarations(demandes) {
            const declarationsList = document.getElementById('hopitalDeclarationsList');
            if (!declarationsList) return;
            
            declarationsList.innerHTML = '';
            
            // Trier par date de cr√©ation (plus r√©centes en premier) et limiter √† 5
            const declarationsRecentes = demandes
                .sort((a, b) => new Date(b.date_creation) - new Date(a.date_creation))
                .slice(0, 5);
            
            if (declarationsRecentes.length === 0) {
                declarationsList.innerHTML = '<p class="text-sm text-gray-500 text-center py-2">Aucune d√©claration r√©cente</p>';
            } else {
                declarationsRecentes.forEach(demande => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded';
                    
                    const dateCreation = new Date(demande.date_creation);
                    const dateFormatee = dateCreation.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const heureFormatee = dateCreation.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    
                    const isNaissance = demande.service && demande.service.includes('Naissance');
                    const isDeces = demande.service && (demande.service.includes('D√©c√®s') || demande.service.includes('d√©c√®s'));
                    const typeDeclaration = isNaissance ? 'Naissance' : isDeces ? 'D√©c√®s' : demande.service || 'D√©claration';
                    
                    const statutText = demande.statut === 'valide' ? 'D√©clar√©' : demande.statut === 'en_traitement' ? 'En cours' : 'En attente';
                    const statutClass = demande.statut === 'valide' ? 'bg-green-100 text-green-800' : 
                                       demande.statut === 'en_traitement' ? 'bg-blue-100 text-blue-800' : 
                                       'bg-gray-100 text-gray-800';
                    
                    // Extraire le nom du motif si disponible
                    const nom = demande.motif ? demande.motif.split(' ')[0] : 'N/A';
                    
                    div.innerHTML = `
                        <div>
                            <div class="font-medium">${typeDeclaration} - ${nom}</div>
                            <div class="text-sm text-gray-600">${dateFormatee} - ${heureFormatee}</div>
                        </div>
                        <span class="px-2 py-1 ${statutClass} rounded text-xs">${statutText}</span>
                    `;
                    declarationsList.appendChild(div);
                });
            }
        }
        
        // Charger les donn√©es citoyen
        async function loadCitoyenData() {
            try {
                const [signalementsResult, demandesResult, notificationsResult] = await Promise.all([
                    apiCall('signalements.php').catch(() => ({ data: [] })),
                    apiCall('demandes.php').catch(() => ({ data: [] })),
                    apiCall('notifications.php').catch(() => ({ data: { notifications: [], non_lues: 0 } }))
                ]);
                
                // Mettre √† jour l'affichage des demandes
                updateDemandesList(demandesResult.data || []);
                
                // Mettre √† jour l'affichage des signalements
                updateSignalementsList(signalementsResult.data || []);
                
                // Mettre √† jour les statistiques
                const demandesActives = (demandesResult.data || []).filter(d => d.statut !== 'valide' && d.statut !== 'rejete' && d.statut !== 'annule').length;
                    const signalementsActifs = (signalementsResult.data || []).filter(s => s.statut !== 'resolu').length;
                    
                const demandesActivesDiv = document.getElementById('citoyenDemandesActives');
                const signalementsActifsDiv = document.getElementById('citoyenSignalementsActifs');
                
                if (demandesActivesDiv) {
                    demandesActivesDiv.textContent = demandesActives;
                }
                if (signalementsActifsDiv) {
                    signalementsActifsDiv.textContent = signalementsActifs;
                }
                
                // Mettre √† jour le badge de notifications
                const notificationBadge = document.getElementById('notificationBadge');
                if (notificationBadge && notificationsResult.data && notificationsResult.data.non_lues > 0) {
                    notificationBadge.textContent = notificationsResult.data.non_lues > 9 ? '9+' : notificationsResult.data.non_lues;
                    notificationBadge.classList.remove('hidden');
                } else if (notificationBadge) {
                    notificationBadge.classList.add('hidden');
                }
            } catch (error) {
                console.error('Erreur chargement donn√©es citoyen:', error);
            }
        }
        
        // Mettre √† jour la liste des demandes
        function updateDemandesList(demandes) {
            // Utiliser l'ID direct pour √©viter les probl√®mes de s√©lection
            const listContainer = document.getElementById('citoyenDemandesListContainer');
            if (!listContainer) {
                // Fallback sur l'ancienne m√©thode
            const demandesSection = Array.from(document.querySelectorAll('#citoyenDashboard .bg-white')).find(el => 
                el.querySelector('h2') && el.querySelector('h2').textContent.includes('Demandes')
            );
            if (demandesSection) {
                    const container = demandesSection.querySelector('.space-y-3');
                    if (container) {
                        container.innerHTML = '';
                        if (!demandes || demandes.length === 0) {
                            container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Aucune demande</p>';
                            return;
                        }
                    demandes.slice(0, 5).forEach(demande => {
                        const statutClass = demande.statut === 'valide' ? 'bg-green-100 text-green-800' : 
                                           demande.statut === 'en_traitement' ? 'bg-blue-100 text-blue-800' : 
                                           'bg-yellow-100 text-yellow-800';
                        const statutText = demande.statut === 'valide' ? 'Valid√©' : 
                                         demande.statut === 'en_traitement' ? 'En cours' : 
                                         'En attente';
                        
                        const div = document.createElement('div');
                        div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded hover:bg-gray-100 transition-colors cursor-pointer';
                        div.innerHTML = `
                            <div>
                                <div class="font-medium">${demande.service}</div>
                                <div class="text-sm text-gray-600">${demande.numero_dossier}</div>
                            </div>
                            <span class="px-2 py-1 ${statutClass} rounded text-xs">${statutText}</span>
                        `;
                            container.appendChild(div);
                    });
                }
            }
                return;
            }
            
            listContainer.innerHTML = '';
            
            // Afficher un message si aucune demande
            if (!demandes || demandes.length === 0) {
                listContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Aucune demande</p>';
                return;
            }
            
            demandes.slice(0, 5).forEach(demande => {
                const statutClass = demande.statut === 'valide' ? 'bg-green-100 text-green-800' : 
                                   demande.statut === 'en_traitement' ? 'bg-blue-100 text-blue-800' : 
                                   'bg-yellow-100 text-yellow-800';
                const statutText = demande.statut === 'valide' ? 'Valid√©' : 
                                 demande.statut === 'en_traitement' ? 'En cours' : 
                                 'En attente';
                
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded hover:bg-gray-100 transition-colors cursor-pointer';
                div.innerHTML = `
                    <div>
                        <div class="font-medium">${demande.service || 'Service'}</div>
                        <div class="text-sm text-gray-600">${demande.numero_dossier || 'N/A'}</div>
                    </div>
                    <span class="px-2 py-1 ${statutClass} rounded text-xs">${statutText}</span>
                `;
                listContainer.appendChild(div);
            });
        }
        
        // Mettre √† jour la liste des signalements
        function updateSignalementsList(signalements) {
            // Utiliser l'ID direct pour √©viter les probl√®mes de s√©lection
            const listContainer = document.getElementById('citoyenSignalementsListContainer');
            if (!listContainer) {
                // Fallback sur l'ancienne m√©thode
            const signalementsSection = Array.from(document.querySelectorAll('#citoyenDashboard .bg-white')).find(el => 
                el.querySelector('h2') && el.querySelector('h2').textContent.includes('Signalements')
            );
            if (signalementsSection) {
                    const container = signalementsSection.querySelector('.space-y-3');
                    if (container) {
                        container.innerHTML = '';
                        if (!signalements || signalements.length === 0) {
                            container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Aucun signalement</p>';
                            return;
                        }
                        signalements.slice(0, 5).forEach(sig => {
                            const statutClass = sig.statut === 'resolu' ? 'bg-green-100 text-green-800' : 
                                               sig.statut === 'en_cours' ? 'bg-blue-100 text-blue-800' : 
                                               'bg-yellow-100 text-yellow-800';
                            const statutText = sig.statut === 'resolu' ? 'R√©solu' : 
                                             sig.statut === 'en_cours' ? 'En cours' : 
                                             'En attente';
                            
                            const div = document.createElement('div');
                            div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded hover:bg-gray-100 transition-colors cursor-pointer';
                            div.innerHTML = `
                                <div>
                                    <div class="font-medium">${sig.sous_type || sig.type || 'Signalement'}</div>
                                    <div class="text-sm text-gray-600">${sig.id_formate || 'SIG-' + sig.id}</div>
                                </div>
                                <span class="px-2 py-1 ${statutClass} rounded text-xs">${statutText}</span>
                            `;
                            container.appendChild(div);
                        });
                    }
                }
                return;
            }
            
                    listContainer.innerHTML = '';
            
            // Afficher un message si aucun signalement
            if (!signalements || signalements.length === 0) {
                listContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Aucun signalement</p>';
                return;
            }
            
                    signalements.slice(0, 5).forEach(sig => {
                        const statutClass = sig.statut === 'resolu' ? 'bg-green-100 text-green-800' : 
                                           sig.statut === 'en_cours' ? 'bg-blue-100 text-blue-800' : 
                                           'bg-yellow-100 text-yellow-800';
                        const statutText = sig.statut === 'resolu' ? 'R√©solu' : 
                                         sig.statut === 'en_cours' ? 'En cours' : 
                                         'En attente';
                        
                        const idFormate = sig.id_formate || 'SIG' + new Date(sig.date_creation).getFullYear() + '-' + String(sig.id).padStart(6, '0');
                        
                        const div = document.createElement('div');
                        div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded hover:bg-gray-100 transition-colors cursor-pointer';
                        div.innerHTML = `
                            <div>
                        <div class="font-medium">${sig.sous_type || sig.type || 'Signalement'}</div>
                                <div class="text-sm text-gray-600">${idFormate}</div>
                            </div>
                            <span class="px-2 py-1 ${statutClass} rounded text-xs">${statutText}</span>
                        `;
                        listContainer.appendChild(div);
                    });
        }
        
        // Charger les donn√©es commer√ßant
        async function loadCommercantData() {
            try {
                const [licencesResult, emplacementsResult, paiementsResult] = await Promise.all([
                    apiCall('licences.php').catch(() => ({ data: [] })),
                    apiCall('emplacements.php').catch(() => ({ data: [] })),
                    apiCall('paiements.php').catch(() => ({ data: [] }))
                ]);
                
                const licences = licencesResult.data || [];
                const emplacements = emplacementsResult.data || [];
                const paiements = paiementsResult.data || [];
                
                // Trouver la licence active la plus r√©cente
                const licenceActive = licences
                    .filter(l => l.statut === 'active')
                    .sort((a, b) => new Date(b.date_fin) - new Date(a.date_fin))[0];
                
                // Mettre √† jour les statistiques
                updateCommercantStats(licenceActive, emplacements);
                
                // Mettre √† jour la liste des licences
                updateCommercantLicences(licences);
                
                // Mettre √† jour les paiements √† effectuer
                updateCommercantPaiements(paiements, licenceActive, emplacements);
                
                // Mettre √† jour les emplacements
                updateCommercantEmplacements(emplacements);
                
            } catch (error) {
                console.error('Erreur chargement donn√©es commer√ßant:', error);
            }
        }
        
        // Mettre √† jour les statistiques du commer√ßant
        function updateCommercantStats(licenceActive, emplacements) {
            // Patente
            const patenteDiv = document.getElementById('commercantPatente');
            if (patenteDiv) {
                if (licenceActive) {
                    const montant = parseFloat(licenceActive.montant) || 0;
                    if (montant >= 1000) {
                        patenteDiv.textContent = (montant / 1000).toFixed(0) + 'K';
                    } else {
                        patenteDiv.textContent = montant.toFixed(0);
                    }
                    patenteDiv.className = 'text-2xl font-bold text-green-600';
                } else {
                    patenteDiv.textContent = 'Aucune';
                    patenteDiv.className = 'text-2xl font-bold text-gray-400';
                }
            }
            
            // √âch√©ance restante
            const echeanceDiv = document.getElementById('commercantEcheance');
            if (echeanceDiv) {
                if (licenceActive) {
                    const dateFin = new Date(licenceActive.date_fin);
                    const aujourdhui = new Date();
                    const joursRestants = Math.ceil((dateFin - aujourdhui) / (1000 * 60 * 60 * 24));
                    echeanceDiv.textContent = joursRestants > 0 ? joursRestants + 'j' : 'Expir√©';
                    echeanceDiv.className = joursRestants > 0 ? 'text-2xl font-bold text-red-600' : 'text-2xl font-bold text-gray-600';
                } else {
                    echeanceDiv.textContent = '-';
                    echeanceDiv.className = 'text-2xl font-bold text-gray-400';
                }
            }
        }
        
        // Mettre √† jour la liste des licences
        function updateCommercantLicences(licences) {
            const licencesList = document.getElementById('commercantLicencesList');
            if (!licencesList) return;
            
            licencesList.innerHTML = '';
            
            if (licences.length === 0) {
                licencesList.innerHTML = '<p class="text-sm text-gray-500 text-center py-2">Aucune licence</p>';
            } else {
                licences.forEach(licence => {
                    const div = document.createElement('div');
                    div.className = 'p-3 border rounded';
                    const dateFin = new Date(licence.date_fin);
                    const dateFinFormatee = dateFin.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const statutClass = licence.statut === 'active' ? 'bg-green-500' : 'bg-gray-500';
                    
                    div.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-medium">${licence.type_licence}</div>
                                <div class="text-sm text-gray-600">Expire: ${dateFinFormatee}</div>
                            </div>
                            <button onclick="renouvellerPatente(${licence.id})" class="${statutClass} text-white px-3 py-1 rounded text-sm">
                                ${licence.statut === 'active' ? 'Renouveler' : 'Expir√©e'}
                            </button>
                        </div>
                    `;
                    licencesList.appendChild(div);
                });
            }
        }
        
        // Mettre √† jour les paiements √† effectuer
        function updateCommercantPaiements(paiements, licenceActive, emplacements) {
            const paiementsList = document.getElementById('commercantPaiementsList');
            if (!paiementsList) return;
            
            paiementsList.innerHTML = '';
            
            const paiementsEnAttente = paiements.filter(p => p.statut === 'en_attente');
            
            if (paiementsEnAttente.length === 0) {
                paiementsList.innerHTML = '<p class="text-sm text-gray-500 text-center py-2">Aucun paiement en attente</p>';
            } else {
                paiementsEnAttente.forEach(paiement => {
                    const div = document.createElement('div');
                    div.className = 'p-3 bg-red-50 rounded border';
                    div.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-medium text-red-600">${paiement.type_paiement}</div>
                                <div class="text-sm">${parseFloat(paiement.montant).toLocaleString('fr-FR')} FCFA</div>
                            </div>
                            <button onclick="effectuerPaiement(${paiement.id}, ${paiement.montant})" class="bg-red-500 text-white px-3 py-1 rounded text-sm">
                                Payer
                            </button>
                        </div>
                    `;
                    paiementsList.appendChild(div);
                });
            }
        }
        
        // Mettre √† jour les emplacements
        function updateCommercantEmplacements(emplacements) {
            const emplacementsList = document.getElementById('commercantEmplacementsList');
            if (!emplacementsList) return;
            
            emplacementsList.innerHTML = '';
            
            const emplacementsActifs = emplacements.filter(e => e.statut === 'actif');
            
            if (emplacementsActifs.length === 0) {
                emplacementsList.innerHTML = '<p class="text-sm text-gray-500 text-center py-2">Aucun emplacement actif</p>';
            } else {
                emplacementsActifs.forEach(emplacement => {
                    const div = document.createElement('div');
                    div.className = 'p-3 bg-green-50 rounded border';
                    const dateFin = emplacement.date_fin ? new Date(emplacement.date_fin) : null;
                    const dateFinFormatee = dateFin ? dateFin.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' }) : 'Non d√©fini';
                    
                    div.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-medium">${emplacement.marche} ${emplacement.emplacement}</div>
                                <div class="text-sm text-gray-600">Pay√© jusqu'au ${dateFinFormatee}</div>
                            </div>
                            <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">Actif</span>
                        </div>
                    `;
                    emplacementsList.appendChild(div);
                });
            }
            
            // Ajouter le bouton de r√©servation
            const buttonDiv = document.createElement('div');
            buttonDiv.innerHTML = `
                <button onclick="reserverEmplacement()" class="w-full bg-blue-500 text-white p-2 rounded mt-3">
                    <i class="fas fa-plus mr-2"></i>R√©server Nouvel Emplacement
                </button>
            `;
            emplacementsList.appendChild(buttonDiv);
        }
        
        // Charger les donn√©es agent
        async function loadAgentData() {
            try {
                const [demandesResult, signalementsResult] = await Promise.all([
                    apiCall('demandes.php'),
                    apiCall('signalements.php')
                ]);
                
                // Charger les missions s√©par√©ment pour g√©rer les erreurs
                let missionsResult = { data: [] };
                try {
                    missionsResult = await apiCall('missions.php');
                } catch (error) {
                    console.warn('Erreur chargement missions (peut √™tre normal si aucune mission):', error);
                    // Continuer avec un tableau vide
                }
                
                const demandes = demandesResult.data || [];
                const signalements = signalementsResult.data || [];
                const missions = missionsResult.data || [];
                
                // Filtrer les donn√©es pour l'agent connect√©
                const demandesAgent = demandes.filter(d => d.agent_assign√©_id == currentUser.id);
                const signalementsAgent = signalements.filter(s => s.agent_assign√©_id == currentUser.id);
                const missionsAgent = missions.filter(m => m.agent_id == currentUser.id);
                
                // Calculer les statistiques
                const demandesAssignees = demandesAgent.filter(d => d.statut !== 'valide' && d.statut !== 'rejete' && d.statut !== 'annule').length;
                
                // Demandes valid√©es aujourd'hui
                const aujourdhui = new Date().toISOString().split('T')[0];
                const demandesValideesAujourdhui = demandesAgent.filter(d => {
                    if (d.statut !== 'valide' || !d.date_validation) return false;
                    const dateValidation = new Date(d.date_validation).toISOString().split('T')[0];
                    return dateValidation === aujourdhui;
                }).length;
                
                // Missions terrain (en cours ou planifi√©es)
                const missionsTerrain = missionsAgent.filter(m => m.statut === 'planifiee' || m.statut === 'en_cours').length;
                
                // Mettre √† jour les statistiques
                const statsDiv = document.querySelector('#agentDashboard .grid.grid-cols-3');
                if (statsDiv) {
                    if (statsDiv.children[0]) {
                        statsDiv.children[0].querySelector('.text-xl').textContent = demandesAssignees;
                    }
                    if (statsDiv.children[1]) {
                        statsDiv.children[1].querySelector('.text-xl').textContent = demandesValideesAujourdhui;
                    }
                    if (statsDiv.children[2]) {
                        statsDiv.children[2].querySelector('.text-xl').textContent = missionsTerrain;
                    }
                }
                
                // Mettre √† jour la liste des demandes √† traiter (toutes les demandes assign√©es, pas seulement en attente)
                // Trier pour montrer les nouvelles en premier
                const demandesATraiter = demandesAgent
                    .filter(d => d.statut === 'en_attente' || d.statut === 'en_traitement')
                    .sort((a, b) => {
                        const dateA = new Date(a.date_creation || 0);
                        const dateB = new Date(b.date_creation || 0);
                        return dateB - dateA; // Plus r√©centes en premier
                    });
                
                updateAgentDemandesList(demandesATraiter);
                
                // Mettre √† jour la liste des signalements assign√©s
                const signalementsATraiter = signalementsAgent
                    .filter(s => s.statut === 'en_attente' || s.statut === 'en_cours')
                    .sort((a, b) => {
                        const dateA = new Date(a.date_creation || 0);
                        const dateB = new Date(b.date_creation || 0);
                        return dateB - dateA; // Plus r√©centes en premier
                    });
                
                updateAgentSignalementsList(signalementsATraiter);
                
                // Mettre √† jour la liste des missions
                updateAgentMissionsList(missionsAgent.filter(m => m.statut === 'planifiee' || m.statut === 'en_cours'));
                
            } catch (error) {
                console.error('Erreur chargement donn√©es agent:', error);
            }
        }
        
        // Mettre √† jour la liste des demandes de l'agent
        function updateAgentDemandesList(demandes) {
            const listContainer = document.getElementById('agentDemandesList');
            if (!listContainer) return;
            
            listContainer.innerHTML = '';
            
            if (demandes.length === 0) {
                listContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Aucune demande √† traiter</p>';
            } else {
                // Trier par date de cr√©ation (plus r√©centes en premier)
                const demandesTriees = demandes.sort((a, b) => {
                    const dateA = new Date(a.date_creation || 0);
                    const dateB = new Date(b.date_creation || 0);
                    return dateB - dateA;
                });
                
                demandesTriees.forEach(demande => {
                    const div = document.createElement('div');
                    div.className = 'p-3 border rounded hover:bg-gray-50 transition-colors';
                    
                    // V√©rifier si c'est une nouvelle demande (moins de 24h)
                    const dateCreation = new Date(demande.date_creation);
                    const maintenant = new Date();
                    const heuresEcoulees = (maintenant - dateCreation) / (1000 * 60 * 60);
                    const isNouvelle = heuresEcoulees < 24;
                    
                    const dateFormatee = dateCreation.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const heureFormatee = dateCreation.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    
                    const statutClass = demande.statut === 'en_attente' ? 'bg-yellow-100 text-yellow-800' : 
                                       demande.statut === 'en_traitement' ? 'bg-blue-100 text-blue-800' : 
                                       'bg-gray-100 text-gray-800';
                    const statutText = demande.statut === 'en_attente' ? 'En attente' : 
                                      demande.statut === 'en_traitement' ? 'En traitement' : 
                                      demande.statut;
                    
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <div class="font-medium">${demande.service || demande.type || 'Demande'}</div>
                                    ${isNouvelle ? '<span class="px-2 py-0.5 bg-red-500 text-white text-xs rounded-full animate-pulse">NOUVEAU</span>' : ''}
                                </div>
                                <div class="text-sm text-gray-600 mb-1">
                                    <i class="fas fa-user mr-1"></i>${demande.utilisateur_nom || 'Utilisateur'}
                                </div>
                                <div class="text-xs text-gray-500 mb-1">
                                    <i class="fas fa-file-alt mr-1"></i>${demande.numero_dossier || 'N/A'}
                                </div>
                                <div class="text-xs text-gray-500">
                                    <i class="fas fa-clock mr-1"></i>${dateFormatee} √† ${heureFormatee}
                                </div>
                                ${demande.motif ? `<div class="text-xs text-gray-600 mt-1 italic">${demande.motif.substring(0, 50)}${demande.motif.length > 50 ? '...' : ''}</div>` : ''}
                                ${demande.commentaire_agent ? `<div class="text-xs text-red-600 mt-1"><i class="fas fa-exclamation-triangle mr-1"></i>${demande.commentaire_agent}</div>` : ''}
                            </div>
                            <div class="flex flex-col items-end gap-2 ml-4">
                                <span class="px-2 py-1 ${statutClass} rounded text-xs">${statutText}</span>
                                <button onclick="voirDetailsDemande(${demande.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-colors whitespace-nowrap">
                                    <i class="fas fa-eye mr-1"></i>Voir d√©tails
                                </button>
                            </div>
                        </div>
                    `;
                    listContainer.appendChild(div);
                });
            }
        }
        
        // Mettre √† jour la liste des signalements de l'agent
        function updateAgentSignalementsList(signalements) {
            const listContainer = document.getElementById('agentSignalementsList');
            if (!listContainer) return;
            
            listContainer.innerHTML = '';
            
            if (signalements.length === 0) {
                listContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Aucun signalement √† traiter</p>';
            } else {
                signalements.forEach(signalement => {
                    const div = document.createElement('div');
                    div.className = 'p-3 border rounded hover:bg-gray-50 transition-colors';
                    
                    // V√©rifier si c'est un nouveau signalement (moins de 24h)
                    const dateCreation = new Date(signalement.date_creation);
                    const maintenant = new Date();
                    const heuresEcoulees = (maintenant - dateCreation) / (1000 * 60 * 60);
                    const isNouveau = heuresEcoulees < 24;
                    
                    const dateFormatee = dateCreation.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const heureFormatee = dateCreation.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    
                    const statutClass = signalement.statut === 'en_attente' ? 'bg-yellow-100 text-yellow-800' : 
                                       signalement.statut === 'en_cours' ? 'bg-blue-100 text-blue-800' : 
                                       'bg-gray-100 text-gray-800';
                    const statutText = signalement.statut === 'en_attente' ? 'En attente' : 
                                      signalement.statut === 'en_cours' ? 'En cours' : 
                                      signalement.statut;
                    
                    const idFormate = signalement.id_formate || 'SIG' + new Date(signalement.date_creation).getFullYear() + '-' + String(signalement.id).padStart(6, '0');
                    
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <div class="font-medium">${signalement.sous_type || signalement.type || 'Signalement'}</div>
                                    ${isNouveau ? '<span class="px-2 py-0.5 bg-red-500 text-white text-xs rounded-full animate-pulse">NOUVEAU</span>' : ''}
                                </div>
                                <div class="text-sm text-gray-600 mb-1">
                                    <i class="fas fa-user mr-1"></i>${signalement.utilisateur_nom || 'Utilisateur'}
                                </div>
                                <div class="text-xs text-gray-500 mb-1">
                                    <i class="fas fa-hashtag mr-1"></i>${idFormate}
                                </div>
                                <div class="text-xs text-gray-500 mb-1">
                                    <i class="fas fa-clock mr-1"></i>${dateFormatee} √† ${heureFormatee}
                                </div>
                                ${signalement.description ? `<div class="text-xs text-gray-600 mt-1 italic">${signalement.description.substring(0, 50)}${signalement.description.length > 50 ? '...' : ''}</div>` : ''}
                                ${signalement.localisation ? `<div class="text-xs text-gray-500 mt-1"><i class="fas fa-map-marker-alt mr-1"></i>${signalement.localisation}</div>` : ''}
                                ${(signalement.photo || signalement.photo_url) ? `<div class="mt-2"><img src="${signalement.photo || signalement.photo_url}" alt="Photo" class="w-20 h-20 object-cover rounded border" onerror="this.style.display='none'"></div>` : ''}
                            </div>
                            <div class="flex flex-col items-end gap-2 ml-4">
                                <span class="px-2 py-1 ${statutClass} rounded text-xs">${statutText}</span>
                                <button onclick="voirSignalement(${signalement.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-colors whitespace-nowrap">
                                    <i class="fas fa-eye mr-1"></i>Voir
                                </button>
                            </div>
                        </div>
                    `;
                    listContainer.appendChild(div);
                });
            }
        }
        
        // Fonction pour voir les d√©tails d'un signalement
        async function voirSignalement(signalementId) {
            try {
                // R√©cup√©rer les d√©tails du signalement depuis l'API
                const result = await apiCall('signalements.php');
                const signalements = result.data || [];
                const signalement = signalements.find(s => s.id == signalementId);
                
                if (!signalement) {
                    showNotification('Signalement introuvable', 'error');
                    return;
                }
                
                // Afficher la modale avec les d√©tails
                afficherDetailsSignalement(signalement);
                
            } catch (error) {
                console.error('Erreur chargement signalement:', error);
                showNotification('Erreur lors du chargement du signalement', 'error');
            }
        }
        
        // Fonction pour afficher les d√©tails du signalement dans une modale
        function afficherDetailsSignalement(signalement) {
            // Cr√©er ou r√©cup√©rer la modale
            let modal = document.getElementById('detailsSignalementModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'detailsSignalementModal';
                modal.className = 'hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.style.paddingTop = '80px';
                document.body.appendChild(modal);
            }
            
            const dateCreation = new Date(signalement.date_creation);
            const dateFormatee = dateCreation.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const heureFormatee = dateCreation.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            const idFormate = signalement.id_formate || 'SIG' + new Date(signalement.date_creation).getFullYear() + '-' + String(signalement.id).padStart(6, '0');
            
            const statutClass = signalement.statut === 'en_attente' ? 'bg-yellow-100 text-yellow-800' : 
                               signalement.statut === 'en_cours' ? 'bg-blue-100 text-blue-800' : 
                               signalement.statut === 'resolu' ? 'bg-green-100 text-green-800' :
                               'bg-gray-100 text-gray-800';
            const statutText = signalement.statut === 'en_attente' ? 'En attente' : 
                              signalement.statut === 'en_cours' ? 'En cours' : 
                              signalement.statut === 'resolu' ? 'R√©solu' :
                              signalement.statut;
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-4 md:p-6 max-w-2xl w-full mx-2 md:mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">D√©tails du Signalement</h2>
                        <button onclick="closeModal('detailsSignalementModal')" class="text-gray-500 hover:text-gray-700 text-2xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- En-t√™te avec statut -->
                        <div class="flex justify-between items-center pb-4 border-b">
                            <div>
                                <h3 class="text-lg font-semibold">${signalement.sous_type || signalement.type || 'Signalement'}</h3>
                                <p class="text-sm text-gray-600">${idFormate}</p>
                            </div>
                            <span class="px-3 py-1 ${statutClass} rounded-full text-sm font-medium">${statutText}</span>
                        </div>
                        
                        <!-- Informations g√©n√©rales -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-medium text-gray-700">Utilisateur</label>
                                <p class="text-sm text-gray-900 mt-1">
                                    <i class="fas fa-user mr-2"></i>${signalement.utilisateur_nom || 'Non renseign√©'}
                                </p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700">Date de cr√©ation</label>
                                <p class="text-sm text-gray-900 mt-1">
                                    <i class="fas fa-clock mr-2"></i>${dateFormatee} √† ${heureFormatee}
                                </p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700">Type</label>
                                <p class="text-sm text-gray-900 mt-1">${signalement.type || 'Non renseign√©'}</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700">Sous-type</label>
                                <p class="text-sm text-gray-900 mt-1">${signalement.sous_type || 'Non renseign√©'}</p>
                            </div>
                        </div>
                        
                        <!-- Description -->
                        <div>
                            <label class="text-sm font-medium text-gray-700">Description</label>
                            <p class="text-sm text-gray-900 mt-1 bg-gray-50 p-3 rounded">${signalement.description || 'Aucune description'}</p>
                        </div>
                        
                        <!-- Localisation -->
                        ${signalement.localisation ? `
                        <div>
                            <label class="text-sm font-medium text-gray-700">Localisation</label>
                            <p class="text-sm text-gray-900 mt-1">
                                <i class="fas fa-map-marker-alt mr-2 text-red-500"></i>${signalement.localisation}
                            </p>
                        </div>
                        ` : ''}
                        
                        <!-- Coordonn√©es GPS -->
                        ${signalement.latitude && signalement.longitude ? `
                        <div>
                            <label class="text-sm font-medium text-gray-700">Coordonn√©es GPS</label>
                            <p class="text-sm text-gray-900 mt-1">
                                <i class="fas fa-map mr-2"></i>Lat: ${signalement.latitude}, Long: ${signalement.longitude}
                            </p>
                            <div id="signalementMap" style="height: 250px; margin-top: 10px; border-radius: 8px;" class="border"></div>
                        </div>
                        ` : ''}
                        
                        <!-- Photo -->
                        ${signalement.photo ? `
                        <div>
                            <label class="text-sm font-medium text-gray-700">Photo</label>
                            <div class="mt-2">
                                <img src="${signalement.photo}" alt="Photo du signalement" class="max-w-full h-auto rounded-lg border" onerror="this.style.display='none'">
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Agent assign√© -->
                        ${signalement.agent_nom ? `
                        <div>
                            <label class="text-sm font-medium text-gray-700">Agent assign√©</label>
                            <p class="text-sm text-gray-900 mt-1">
                                <i class="fas fa-user-tie mr-2"></i>${signalement.agent_nom}
                            </p>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex gap-3 mt-6 pt-4 border-t">
                        <button onclick="closeModal('detailsSignalementModal')" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white p-2 rounded">
                            Fermer
                        </button>
                        ${signalement.statut === 'en_attente' ? `
                        <button onclick="demarrerTraitementSignalement(${signalement.id})" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white p-2 rounded">
                            <i class="fas fa-play mr-2"></i>D√©marrer le traitement
                        </button>
                        ` : ''}
                        ${signalement.statut === 'en_cours' ? `
                        <button onclick="resoudreSignalement(${signalement.id})" class="flex-1 bg-green-500 hover:bg-green-600 text-white p-2 rounded">
                            <i class="fas fa-check mr-2"></i>Marquer comme r√©solu
                        </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
            
            // Initialiser la carte si des coordonn√©es GPS sont disponibles
            if (signalement.latitude && signalement.longitude) {
                setTimeout(() => {
                    initSignalementMapView(signalement.latitude, signalement.longitude);
                }, 100);
            }
        }
        
        // Initialiser la carte pour afficher un signalement existant
        function initSignalementMapView(lat, lng) {
            const mapContainer = document.getElementById('signalementMap');
            if (!mapContainer || typeof L === 'undefined') return;
            
            // V√©rifier que lat et lng sont valides
            if (typeof lat !== 'number' || typeof lng !== 'number' || isNaN(lat) || isNaN(lng)) {
                console.error('Coordonn√©es invalides pour la carte:', lat, lng);
                return;
            }
            
            // Supprimer la carte existante si elle existe
            if (window.signalementMapInstance) {
                try {
                    window.signalementMapInstance.remove();
                } catch(e) {
                    console.warn('Erreur lors de la suppression:', e);
                }
            }
            
            // V√©rifier si le conteneur a d√©j√† une carte Leaflet
            if (mapContainer._leaflet_id) {
                delete mapContainer._leaflet_id;
                mapContainer.innerHTML = '';
            }
            
            // Cr√©er une nouvelle carte
            try {
                window.signalementMapInstance = L.map('signalementMap').setView([lat, lng], 15);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(window.signalementMapInstance);
                
                // Ajouter un marqueur
                L.marker([lat, lng]).addTo(window.signalementMapInstance)
                    .bindPopup('Emplacement du signalement');
            } catch(e) {
                console.error('Erreur lors de la cr√©ation de la carte:', e);
            }
        }
        
        // D√©marrer le traitement d'un signalement
        async function demarrerTraitementSignalement(signalementId) {
            try {
                const result = await apiCall('signalements.php', 'PUT', {
                    id: signalementId,
                    statut: 'en_cours'
                });
                
                if (result.success) {
                    showNotification('Traitement d√©marr√©', 'success');
                    closeModal('detailsSignalementModal');
                    await loadAgentData();
                }
            } catch (error) {
                console.error('Erreur d√©marrage traitement:', error);
                showNotification('Erreur lors du d√©marrage du traitement', 'error');
            }
        }
        
        // R√©soudre un signalement
        async function resoudreSignalement(signalementId) {
            try {
                const result = await apiCall('signalements.php', 'PUT', {
                    id: signalementId,
                    statut: 'resolu'
                });
                
                if (result.success) {
                    showNotification('Signalement marqu√© comme r√©solu', 'success');
                    closeModal('detailsSignalementModal');
                    await loadAgentData();
                }
            } catch (error) {
                console.error('Erreur r√©solution signalement:', error);
                showNotification('Erreur lors de la r√©solution', 'error');
            }
        }
        
        // Fonction pour traiter un signalement (ancienne fonction, maintenant redirige vers voirSignalement)
        async function traiterSignalement(signalementId) {
            await voirSignalement(signalementId);
        }
        
        // Mettre √† jour la liste des missions de l'agent
        function updateAgentMissionsList(missions) {
            const listContainer = document.getElementById('agentMissionsList');
            if (!listContainer) return;
            
            listContainer.innerHTML = '';
            
            if (missions.length === 0) {
                listContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Aucune mission planifi√©e</p>';
            } else {
                missions.forEach(mission => {
                    const div = document.createElement('div');
                    div.className = 'p-3 bg-blue-50 rounded border';
                    const dateMission = new Date(mission.date_mission);
                    const heure = dateMission.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    const date = dateMission.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' });
                    
                    div.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-medium">${mission.type_mission}</div>
                                <div class="text-sm text-gray-600">${date} - ${heure}</div>
                                ${mission.localisation ? `<div class="text-xs text-gray-500">${mission.localisation}</div>` : ''}
                            </div>
                            <button onclick="demarrerMission(${mission.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                ${mission.statut === 'en_cours' ? 'En cours' : 'D√©marrer'}
                            </button>
                        </div>
                    `;
                    listContainer.appendChild(div);
                });
            }
        }
        
        // Charger les donn√©es manager
        async function loadManagerData() {
            // Compter les demandes et signalements non assign√©s
            try {
                const [demandesResult, signalementsResult, usersResult] = await Promise.all([
                    apiCall('demandes.php').catch(() => ({ data: [] })),
                    apiCall('signalements.php').catch(() => ({ data: [] })),
                    apiCall('users.php').catch(() => ({ data: [] }))
                ]);
                
                const demandes = demandesResult.data || [];
                const signalements = signalementsResult.data || [];
                const users = usersResult.data || [];
                
                const demandesNonAssignees = demandes.filter(d => !d.agent_assign√©_id && d.statut === 'en_attente');
                const signalementsNonAssignes = signalements.filter(s => !s.agent_assign√©_id && s.statut === 'en_attente');
                const agentsEnAttente = users.filter(u => u.role === 'agent' && u.statut === 'en_attente');
                
                // Mettre √† jour les badges
                const badgeDemandes = document.getElementById('managerDemandesNonAssignees');
                const badgeSignalements = document.getElementById('managerSignalementsNonAssignes');
                const badgeAgents = document.getElementById('managerAgentsEnAttente');
                const alertBox = document.getElementById('managerAgentsAlert');
                const alertText = document.getElementById('managerAgentsAlertText');
                if (badgeDemandes) badgeDemandes.textContent = demandesNonAssignees.length;
                if (badgeSignalements) badgeSignalements.textContent = signalementsNonAssignes.length;
                if (badgeAgents) badgeAgents.textContent = agentsEnAttente.length;
                if (alertBox) {
                    if (agentsEnAttente.length > 0) {
                        alertBox.classList.remove('hidden');
                        if (alertText) alertText.textContent = `${agentsEnAttente.length} dossier(s) doivent √™tre valid√©s avant activation.`;
                    } else {
                        alertBox.classList.add('hidden');
                        if (alertText) alertText.textContent = 'Aucun dossier en attente.';
                    }
                }
            } catch (error) {
                console.error('Erreur comptage demandes/signalements:', error);
            }
            
            // Continuer avec le chargement normal
            try {
                const statsResult = await apiCall('stats.php');
                if (statsResult && statsResult.data) {
                    const stats = statsResult.data;
                    
                    // Mettre √† jour les KPI du manager
                    const managerKpis = document.querySelectorAll('#managerDashboard .grid.grid-cols-4 > div');
                    if (managerKpis.length >= 4) {
                        // Demandes ce mois
                        if (managerKpis[0]) {
                            const valueDiv = managerKpis[0].querySelector('.text-3xl');
                            if (valueDiv) {
                                valueDiv.textContent = stats.demandes_mois || 0;
                                // Mettre √† jour la variation si disponible
                                const variationDiv = managerKpis[0].querySelector('.text-sm');
                                if (variationDiv) {
                                    variationDiv.textContent = 'Ce mois';
                                }
                            }
                        }
                        // Taux de satisfaction
                        if (managerKpis[1]) {
                            const valueDiv = managerKpis[1].querySelector('.text-3xl');
                            if (valueDiv) {
                                valueDiv.textContent = (stats.taux_satisfaction || 0) + '%';
                                const variationDiv = managerKpis[1].querySelector('.text-sm');
                                if (variationDiv) {
                                    variationDiv.textContent = 'Taux de satisfaction';
                                }
                            }
                        }
                        // D√©lai moyen
                        if (managerKpis[2]) {
                            const valueDiv = managerKpis[2].querySelector('.text-3xl');
                            if (valueDiv) {
                                valueDiv.textContent = (stats.delai_moyen || 0) + 'j';
                                const variationDiv = managerKpis[2].querySelector('.text-sm');
                                if (variationDiv) {
                                    variationDiv.textContent = 'D√©lai moyen';
                                }
                            }
                        }
                        // Recettes
                        if (managerKpis[3]) {
                            const valueDiv = managerKpis[3].querySelector('.text-3xl');
                            if (valueDiv) {
                                const montant = stats.recettes_mois || 0;
                                if (montant >= 1000000) {
                                    valueDiv.textContent = (montant / 1000000).toFixed(1) + 'M';
                                } else if (montant >= 1000) {
                                    valueDiv.textContent = (montant / 1000).toFixed(0) + 'K';
                                } else {
                                    valueDiv.textContent = montant.toFixed(0);
                                }
                                const variationDiv = managerKpis[3].querySelector('.text-sm');
                                if (variationDiv) {
                                    variationDiv.textContent = 'Recettes FCFA';
                                }
                            }
                        }
                    }
                    
                    // Mettre √† jour l'√©quipe active
                    updateManagerEquipe(stats.agents_performance || [], stats.agents_actifs || 0);
                    
                    // Mettre √† jour les statistiques des march√©s
                    updateManagerMarches(stats);
                    
                    // Mettre √† jour les KPI du superadmin
                    const superadminKpis = document.querySelectorAll('#superadminDashboard .grid.grid-cols-5 > div');
                    if (superadminKpis.length >= 5) {
                        if (superadminKpis[0]) {
                            const valueDiv = superadminKpis[0].querySelector('.text-2xl');
                            if (valueDiv) valueDiv.textContent = stats.utilisateurs_actifs || 0;
                        }
                        // Les autres m√©triques syst√®me restent statiques pour l'instant
                    }
                }
            } catch (error) {
                console.warn('Erreur chargement donn√©es manager (peut √™tre normal):', error);
                // Ne pas bloquer l'affichage en cas d'erreur
            }
        }
        
        // Mettre √† jour l'√©quipe active du manager
        function updateManagerEquipe(agents, totalAgents) {
            const titleElement = document.getElementById('managerEquipeTitle');
            const listElement = document.getElementById('managerEquipeList');
            
            if (titleElement) {
                titleElement.textContent = `√âquipe Active (${totalAgents} agent${totalAgents > 1 ? 's' : ''})`;
            }
            
            if (listElement) {
                listElement.innerHTML = '';
                
                if (agents.length === 0) {
                    listElement.innerHTML = '<p class="text-gray-500 text-center py-2">Aucun agent actif</p>';
                } else {
                    // Limiter √† 3 agents pour l'affichage
                    const agentsToShow = agents.slice(0, 3);
                    agentsToShow.forEach(agent => {
                        const div = document.createElement('div');
                        div.className = 'flex justify-between';
                        
                        // Calculer le pourcentage de performance (bas√© sur les demandes valid√©es)
                        const maxDemandes = Math.max(...agents.map(a => parseInt(a.demandes_validees) || 0), 1);
                        const demandesAgent = parseInt(agent.demandes_validees) || 0;
                        const performance = maxDemandes > 0 ? Math.round((demandesAgent / maxDemandes) * 100) : 0;
                        const performanceClass = performance >= 90 ? 'text-green-600' : performance >= 70 ? 'text-yellow-600' : 'text-red-600';
                        
                        div.innerHTML = `
                            <span>${agent.nom || 'Agent'}</span>
                            <span class="${performanceClass}">${performance}% performance</span>
                        `;
                        listElement.appendChild(div);
                    });
                }
            }
        }
        
        // Mettre √† jour les statistiques des march√©s
        function updateManagerMarches(stats) {
            const statsGrid = document.getElementById('managerMarchesStats');
            if (!statsGrid || statsGrid.children.length < 3) return;
            
            // Taux d'occupation
            if (statsGrid.children[0]) {
                const valueDiv = statsGrid.children[0].querySelector('.text-2xl');
                if (valueDiv) {
                    valueDiv.textContent = (stats.taux_occupation || 0) + '%';
                }
            }
            // Emplacements occup√©s
            if (statsGrid.children[1]) {
                const valueDiv = statsGrid.children[1].querySelector('.text-2xl');
                if (valueDiv) {
                    valueDiv.textContent = (stats.emplacements_occupes || 0).toLocaleString('fr-FR');
                }
            }
            // Recettes march√©s
            if (statsGrid.children[2]) {
                const valueDiv = statsGrid.children[2].querySelector('.text-2xl');
                if (valueDiv) {
                    const montant = stats.recettes_marches || 0;
                    if (montant >= 1000000) {
                        valueDiv.textContent = (montant / 1000000).toFixed(1) + 'M';
                    } else if (montant >= 1000) {
                        valueDiv.textContent = (montant / 1000).toFixed(0) + 'K';
                    } else {
                        valueDiv.textContent = montant.toFixed(0);
                    }
                }
            }
        }
        
        async function logout() {
            try {
                await apiCall('logout.php', 'POST');
            } catch (error) {
                // Continuer m√™me en cas d'erreur
            }
            
            // Masquer tous les dashboards avec animation
            document.querySelectorAll('[id$="Dashboard"]').forEach(el => {
                if (!el.classList.contains('hidden')) {
                    el.style.opacity = '0';
                    el.style.transform = 'translateY(-20px)';
                    setTimeout(() => el.classList.add('hidden'), 300);
                }
            });
            
            // Afficher la page de connexion avec animation
            setTimeout(() => {
                const loginPage = document.getElementById('loginPage');
                loginPage.classList.remove('hidden');
                loginPage.style.opacity = '0';
                loginPage.style.transform = 'scale(0.95)';
                
                setTimeout(() => {
                    loginPage.style.transition = 'all 0.5s ease';
                    loginPage.style.opacity = '1';
                    loginPage.style.transform = 'scale(1)';
                }, 50);
            }, 300);
            
            showNotification('D√©connexion r√©ussie', 'info');
            currentUser = null;
            currentProfile = null;
        }

        // Fonctions pour les signalements
        function showNewSignalement() {
            const modal = document.getElementById('signalementModal');
            modal.classList.remove('hidden');
            
            // R√©initialiser la carte √† chaque ouverture pour forcer le rechargement
            const mapContainer = document.getElementById('signalementMap');
            if (mapContainer && mapContainer._leaflet_id) {
                // Supprimer l'ID Leaflet pour permettre la r√©initialisation
                delete mapContainer._leaflet_id;
            }
            
            if (signalementMap) {
                try {
                    signalementMap.remove();
                } catch(e) {
                    console.warn('Erreur lors de la suppression:', e);
                }
                signalementMap = null;
                signalementMarker = null;
            }
            
            // Attendre que la modale soit compl√®tement visible avant d'initialiser la carte
            setTimeout(() => {
                const mapContainer = document.getElementById('signalementMap');
                if (!mapContainer) {
                    console.error('Conteneur de carte non trouv√©');
                    return;
                }
                
                // V√©rifier que le conteneur est visible et a une hauteur
                const containerStyle = window.getComputedStyle(mapContainer);
                const containerHeight = mapContainer.offsetHeight || mapContainer.clientHeight;
                
                if (containerStyle.display === 'none' || containerStyle.visibility === 'hidden') {
                    console.error('Conteneur de carte non visible');
                    return;
                }
                
                if (containerHeight === 0) {
                    console.error('Conteneur de carte a une hauteur de 0');
                    // Forcer une hauteur minimale
                    mapContainer.style.minHeight = '180px';
                    mapContainer.style.height = '180px';
                }
                
                // V√©rifier que GABON_CENTER est d√©fini
                if (typeof GABON_CENTER === 'undefined' || !Array.isArray(GABON_CENTER) || GABON_CENTER.length !== 2) {
                    console.error('GABON_CENTER n\'est pas d√©fini correctement:', typeof GABON_CENTER, GABON_CENTER);
                    return;
                }
                
                console.log('Initialisation de la carte, hauteur du conteneur:', containerHeight, 'GABON_CENTER:', GABON_CENTER);
                
                // V√©rifier qu'il n'y a pas d√©j√† une carte initialis√©e
                if (mapContainer._leaflet_id) {
                    console.log('Carte d√©j√† initialis√©e, suppression...');
                    try {
                        const existingMap = mapContainer._leaflet;
                        if (existingMap) {
                            existingMap.remove();
                        }
                    } catch(e) {
                        console.warn('Erreur lors de la suppression de la carte existante:', e);
                    }
                    delete mapContainer._leaflet_id;
                    mapContainer.innerHTML = '';
                }
                
                // Initialiser la carte
                initSignalementMap();
                
                // Forcer le rechargement des tuiles apr√®s plusieurs d√©lais
                setTimeout(() => {
                    if (signalementMap && typeof GABON_CENTER !== 'undefined' && Array.isArray(GABON_CENTER) && GABON_CENTER.length === 2) {
                        signalementMap.invalidateSize();
                        signalementMap.setView(GABON_CENTER, 7, {animate: false});
                    } else {
                        console.error('Impossible de d√©finir la vue: GABON_CENTER invalide ou carte non disponible');
                    }
                }, 200);
                
                setTimeout(() => {
                    if (signalementMap) {
                        signalementMap.invalidateSize();
                        // Forcer le rechargement en changeant l√©g√®rement le zoom puis revenir
                        const currentZoom = signalementMap.getZoom();
                        signalementMap.setZoom(currentZoom + 0.1, {animate: false});
                        setTimeout(() => {
                            signalementMap.setZoom(currentZoom, {animate: false});
                        }, 50);
                    }
                }, 500);
                
                setTimeout(() => {
                    if (signalementMap) {
                        signalementMap.invalidateSize();
                        // Forcer le rechargement des tuiles
                        signalementMap.eachLayer((layer) => {
                            if (layer instanceof L.TileLayer) {
                                layer.redraw();
                            }
                        });
                    }
                }, 1000);
            }, 400);
        }
        
        // Gestion des types de signalements
        document.getElementById('signalementType').addEventListener('change', function() {
            const type = this.value;
            const sousTypeSelect = document.getElementById('signalementSousType');
            
            sousTypeSelect.innerHTML = '<option value="">S√©lectionner...</option>';
            
            if (type && signalementTypes[type]) {
                signalementTypes[type].forEach(sousType => {
                    const option = document.createElement('option');
                    option.value = sousType;
                    option.textContent = sousType;
                    sousTypeSelect.appendChild(option);
                });
            }
        });
        
        document.getElementById('signalementForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const type = document.getElementById('signalementType').value;
            const sousType = document.getElementById('signalementSousType').value;
            const description = document.getElementById('signalementDescription').value;
            const localisation = document.getElementById('signalementLocalisation').value;
            const latitude = document.getElementById('signalementLatitude').value;
            const longitude = document.getElementById('signalementLongitude').value;
            
            if (!type || !sousType || !description) {
                showNotification('Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }
            
            try {
                showNotification('Enregistrement du signalement...', 'info');
                
                // G√©rer l'upload de photo si pr√©sent
                let photoBase64 = null;
                const photoInput = document.getElementById('signalementPhoto');
                if (photoInput && photoInput.files && photoInput.files.length > 0) {
                    const file = photoInput.files[0];
                    // Convertir en base64 pour l'envoi
                    photoBase64 = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                }
                
                const signalementData = {
                    type: type,
                    sous_type: sousType,
                    description: description,
                    localisation: localisation || 'Libreville, Gabon',
                    latitude: latitude ? parseFloat(latitude) : null,
                    longitude: longitude ? parseFloat(longitude) : null,
                    photo: photoBase64
                };
                
                const result = await apiCall('signalements.php', 'POST', signalementData);
                
                closeModal('signalementModal');
                
                // R√©initialiser le formulaire
                document.getElementById('signalementForm').reset();
                document.getElementById('signalementSousType').innerHTML = '<option value="">Choisir d\'abord le type...</option>';
                
                showNotification(`Signalement ${result.data.id_formate || result.data.id} enregistr√© avec succ√®s !`, 'success');
                
                // Recharger les donn√©es si connect√©
                if (currentUser && currentProfile === 'citoyen') {
                    await loadCitoyenData();
                }
                
                // Message pour les signalements anonymes
                if (!currentUser) {
                    showNotification('Votre signalement a √©t√© enregistr√©. Un agent le traitera sous peu.', 'info');
                } else if (result.data.agent_assign√©_id) {
                    showNotification('Votre signalement a √©t√© assign√© √† un agent qui le traitera sous peu.', 'info');
                } else {
                    setTimeout(() => {
                        showNotification('Signalement re√ßu et en attente d\'assignation', 'info');
                    }, 2000);
                }
            } catch (error) {
                showNotification('Erreur lors de l\'enregistrement', 'error');
            }
        });
        
        function geoLocaliser() {
            // Utiliser la g√©olocalisation du navigateur si disponible
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        // V√©rifier si on est dans les limites du Gabon
                        if (lat >= GABON_BOUNDS[0][0] && lat <= GABON_BOUNDS[1][0] &&
                            lng >= GABON_BOUNDS[0][1] && lng <= GABON_BOUNDS[1][1]) {
                            if (signalementMap && signalementMarker) {
                                signalementMarker.setLatLng([lat, lng]);
                                signalementMap.setView([lat, lng], 15);
                                updateSignalementLocation(lat, lng);
            showNotification('Position g√©olocalis√©e !', 'success');
                            }
                        } else {
                            showNotification('Vous semblez √™tre en dehors du Gabon. Veuillez s√©lectionner manuellement sur la carte.', 'warning');
                        }
                    },
                    function(error) {
                        showNotification('Impossible d\'obtenir votre position. Utilisez la carte pour s√©lectionner.', 'warning');
                    }
                );
            } else {
                showNotification('La g√©olocalisation n\'est pas disponible. Utilisez la carte pour s√©lectionner.', 'warning');
            }
        }

        // Fonctions pour les demandes administratives
        function showNewDemande() {
            document.getElementById('demandeModal').classList.remove('hidden');
        }
        
        document.getElementById('demandeType').addEventListener('change', function() {
            const type = this.value;
            const serviceSelect = document.getElementById('demandeService');
            const documentsDiv = document.getElementById('documentsRequis');
            const coutDiv = document.getElementById('coutEstime');
            const documentsUploadContainer = document.getElementById('documentsUploadContainer');
            
            serviceSelect.innerHTML = '<option value="">S√©lectionner...</option>';
            documentsDiv.textContent = 'S√©lectionnez un service pour voir les documents requis';
            coutDiv.textContent = '- FCFA';
            documentsUploadContainer.innerHTML = '';
            documentsUploadContainer.classList.add('hidden');
            
            if (type && servicesAdmin[type]) {
                servicesAdmin[type].services.forEach((service, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = service;
                    serviceSelect.appendChild(option);
                });
            }
        });
        
        document.getElementById('demandeService').addEventListener('change', function() {
            const typeSelect = document.getElementById('demandeType');
            const type = typeSelect.value;
            const serviceIndex = parseInt(this.value);
            
            if (type && servicesAdmin[type] && !isNaN(serviceIndex)) {
                const documentsDiv = document.getElementById('documentsRequis');
                const coutDiv = document.getElementById('coutEstime');
                const infoSpeciale = document.getElementById('infoSpeciale');
                const infoSpecialeText = document.getElementById('infoSpecialeText');
                const documentsUploadContainer = document.getElementById('documentsUploadContainer');
                
                const serviceName = servicesAdmin[type].services[serviceIndex];
                const documentsText = servicesAdmin[type].documents[serviceIndex];
                documentsDiv.textContent = documentsText;
                coutDiv.textContent = servicesAdmin[type].tarifs[serviceIndex].toLocaleString() + ' FCFA';
                
                // Afficher les informations sp√©ciales selon le service
                if (serviceName.includes('Acte de Naissance') || serviceName.includes('Naissance')) {
                    infoSpeciale.classList.remove('hidden');
                    infoSpecialeText.textContent = '‚ö†Ô∏è Important : D√©claration obligatoire dans les 3 jours apr√®s l\'accouchement. En cas de non-d√©claration dans les d√©lais, un jugement suppl√©tif sera n√©cessaire.';
                } else if (serviceName.includes('Acte de Mariage') || serviceName.includes('Mariage')) {
                    infoSpeciale.classList.remove('hidden');
                    infoSpecialeText.textContent = 'üíí C√©l√©bration et √©tablissement de l\'acte de mariage. Pr√©sence des deux √©poux et de 2 t√©moins majeurs obligatoire.';
                } else if (serviceName.includes('Acte de D√©c√®s') || serviceName.includes('D√©c√®s')) {
                    infoSpeciale.classList.remove('hidden');
                    infoSpecialeText.textContent = '‚ö∞Ô∏è D√©claration et √©tablissement de l\'acte de d√©c√®s. Doit √™tre effectu√©e dans les 24 heures suivant le d√©c√®s.';
                } else {
                    infoSpeciale.classList.add('hidden');
                }
                
                // Cr√©er les champs de t√©l√©chargement pour chaque document requis
                documentsUploadContainer.innerHTML = '';
                const documentsList = documentsText.split('+').map(doc => doc.trim()).filter(doc => doc.length > 0);
                
                documentsList.forEach((doc, index) => {
                    const docDiv = document.createElement('div');
                    docDiv.className = 'mb-3 p-3 bg-gray-50 rounded border border-gray-200';
                    
                    const label = document.createElement('label');
                    label.className = 'block text-xs font-semibold text-gray-800 mb-2';
                    label.innerHTML = `<i class="fas fa-file-upload mr-1 text-blue-600"></i> ${doc} <span class="text-red-500">*</span>`;
                    label.setAttribute('for', `doc_${serviceIndex}_${index}`);
                    
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.id = `doc_${serviceIndex}_${index}`;
                    input.name = `document_${index}`;
                    input.className = 'w-full text-xs border-2 border-gray-300 rounded p-2 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600 transition-colors';
                    input.required = true;
                    input.accept = '.pdf,.jpg,.jpeg,.png,.doc,.docx';
                    input.setAttribute('data-document-name', doc);
                    
                    const fileInfo = document.createElement('div');
                    fileInfo.className = 'text-xs text-gray-500 mt-1 hidden';
                    fileInfo.id = `fileInfo_${serviceIndex}_${index}`;
                    
                    // Validation visuelle
                    input.addEventListener('change', function() {
                        if (this.files && this.files.length > 0) {
                            const file = this.files[0];
                            const fileSize = (file.size / 1024 / 1024).toFixed(2); // MB
                            fileInfo.innerHTML = `<i class="fas fa-check-circle text-green-600 mr-1"></i> ${file.name} (${fileSize} MB)`;
                            fileInfo.classList.remove('hidden');
                            this.classList.remove('border-red-500', 'border-gray-300');
                            this.classList.add('border-green-500');
                        } else {
                            fileInfo.classList.add('hidden');
                            this.classList.remove('border-green-500');
                            this.classList.add('border-red-500');
                        }
                    });
                    
                    docDiv.appendChild(label);
                    docDiv.appendChild(input);
                    docDiv.appendChild(fileInfo);
                    documentsUploadContainer.appendChild(docDiv);
                });
                
                documentsUploadContainer.classList.remove('hidden');
            }
        });
        
        document.getElementById('demandeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const typeSelect = document.getElementById('demandeType');
            const serviceSelect = document.getElementById('demandeService');
            const motif = document.getElementById('demandeMotif').value;
            const documentsUploadContainer = document.getElementById('documentsUploadContainer');
            
            if (!typeSelect.value || !serviceSelect.value || !motif) {
                showNotification('Veuillez remplir tous les champs', 'error');
                return;
            }
            
            // V√©rifier que tous les documents sont fournis
            const documentInputs = documentsUploadContainer.querySelectorAll('input[type="file"]');
            let allDocumentsProvided = true;
            const missingDocuments = [];
            
            documentInputs.forEach(input => {
                if (!input.files || input.files.length === 0) {
                    allDocumentsProvided = false;
                    missingDocuments.push(input.getAttribute('data-document-name'));
                    input.classList.add('border-red-500');
                    input.classList.add('ring-2');
                    input.classList.add('ring-red-300');
                } else {
                    input.classList.remove('border-red-500');
                    input.classList.remove('ring-2');
                    input.classList.remove('ring-red-300');
                }
            });
            
            if (!allDocumentsProvided) {
                showNotification(`Veuillez t√©l√©charger tous les documents requis : ${missingDocuments.join(', ')}`, 'error');
                // Faire d√©filer vers le premier champ manquant
                const firstMissing = documentsUploadContainer.querySelector('input[type="file"]:not([value])');
                if (firstMissing) {
                    firstMissing.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstMissing.focus();
                }
                return;
            }
            
            const type = typeSelect.value;
            const serviceIndex = parseInt(serviceSelect.value);
            const serviceName = servicesAdmin[type].services[serviceIndex];
            const cout = servicesAdmin[type].tarifs[serviceIndex];
            
            try {
                showNotification('Cr√©ation de la demande avec les documents...', 'info');
                
                // Cr√©er FormData pour envoyer les fichiers
                const formData = new FormData();
                formData.append('type', type);
                formData.append('service', serviceName);
                formData.append('motif', motif);
                formData.append('cout', cout);
                
                // Ajouter tous les documents
                documentInputs.forEach((input, index) => {
                    if (input.files && input.files.length > 0) {
                        formData.append(`document_${index}`, input.files[0]);
                        formData.append(`document_name_${index}`, input.getAttribute('data-document-name'));
                    }
                });
                
                // Envoyer avec FormData ou base64 selon l'environnement
                let response;
                let result;
                
                if (!API_BASE_URL) {
                    // Production: Convertir les fichiers en base64 et envoyer via JSON
                    showNotification('Conversion des fichiers en cours...', 'info');
                    
                    const documents = [];
                    for (let i = 0; i < documentInputs.length; i++) {
                        const input = documentInputs[i];
                        if (input.files && input.files.length > 0) {
                            const file = input.files[0];
                            const fileName = input.getAttribute('data-document-name');
                            
                            // Convertir en base64
                            const base64 = await new Promise((resolve, reject) => {
                                const reader = new FileReader();
                                reader.onload = () => resolve(reader.result.split(',')[1]);
                                reader.onerror = reject;
                                reader.readAsDataURL(file);
                            });
                            
                            documents.push({
                                nom: fileName,
                                fichier: base64,
                                nom_fichier: file.name,
                                taille: file.size,
                                type: file.type
                            });
                        }
                    }
                    
                    // Envoyer via Netlify Function avec les fichiers en base64
                    const demandeData = {
                        type: type,
                        service: serviceName,
                        motif: motif,
                        cout: cout,
                        documents: documents
                    };
                    
                    result = await apiCall('demandes', 'POST', demandeData);
                } else {
                    // Local: Utiliser FormData normal
                    response = await fetch(`${API_BASE_URL}/demandes.php`, {
                        method: 'POST',
                        credentials: 'include',
                        body: formData
                    });
                    
                    result = await response.json();
                }
                
                if (!result.success) {
                    throw new Error(result.message || 'Erreur lors de la cr√©ation de la demande');
                }
                
                closeModal('demandeModal');
                
                // R√©initialiser le formulaire
                document.getElementById('demandeForm').reset();
                document.getElementById('demandeService').innerHTML = '<option value="">Choisir d\'abord le type...</option>';
                document.getElementById('documentsRequis').textContent = 'S√©lectionnez un service pour voir les documents requis';
                document.getElementById('coutEstime').textContent = '- FCFA';
                documentsUploadContainer.innerHTML = '';
                documentsUploadContainer.classList.add('hidden');
                
                showNotification(`Demande ${result.data.numero_dossier} cr√©√©e avec tous les documents ! Co√ªt: ${cout.toLocaleString()} FCFA`, 'success');
                
                // Recharger les donn√©es
                if (currentProfile === 'citoyen') {
                    await loadCitoyenData();
                } else if (currentProfile === 'commercant') {
                    await loadCommercantData();
                } else if (currentProfile === 'hopital') {
                    await loadHopitalData();
                }
                
                // Notifier que la demande a √©t√© assign√©e √† un agent
                if (result.data.agent_assign√©_id) {
                    showNotification('Votre demande a √©t√© assign√©e √† un agent qui la traitera sous peu.', 'info');
                }
                
                // Proposer le paiement
                setTimeout(() => {
                    if (confirm('Souhaitez-vous proc√©der au paiement maintenant ?')) {
                        effectuerPaiement(serviceName, cout, result.data.id);
                    }
                }, 2000);
            } catch (error) {
                console.error('Erreur cr√©ation demande:', error);
                showNotification('Erreur lors de la cr√©ation de la demande : ' + error.message, 'error');
            }
        });

        // Fonctions de paiement
        function effectuerPaiement(service, montant, demandeId = null) {
            document.getElementById('paiementService').textContent = service;
            document.getElementById('paiementMontant').textContent = montant.toLocaleString();
            document.getElementById('paiementModal').classList.remove('hidden');
            
            // Stocker les donn√©es pour le paiement
            document.getElementById('paiementModal').dataset.service = service;
            document.getElementById('paiementModal').dataset.montant = montant;
            document.getElementById('paiementModal').dataset.demandeId = demandeId || '';
        }
        
        async function selectPaiement(method) {
            const modal = document.getElementById('paiementModal');
            const service = modal.dataset.service;
            const montant = parseFloat(modal.dataset.montant.replace(/\s/g, ''));
            const demandeId = modal.dataset.demandeId ? parseInt(modal.dataset.demandeId) : null;
            
            closeModal('paiementModal');
            
            try {
                showNotification('Traitement du paiement en cours...', 'info');
                
                const paiementData = {
                    type_paiement: service,
                    montant: montant,
                    methode: method,
                    demande_id: demandeId
                };
                
                const result = await apiCall('paiements.php', 'POST', paiementData);
                
                showNotification(`Paiement confirm√© ! R√©f√©rence: ${result.data.reference_paiement}`, 'success');
                
                // Recharger les donn√©es
                if (currentProfile === 'citoyen') {
                    await loadCitoyenData();
                }
                
                // Simuler la g√©n√©ration du re√ßu
                setTimeout(() => {
                    showNotification('Re√ßu num√©rique envoy√© par SMS et email', 'info');
                }, 2000);
            } catch (error) {
                showNotification('Erreur lors du paiement', 'error');
            }
        }

        // Fonctions agents
        function traiterDemandes() {
            const modal = document.getElementById('traiterDemandesModal');
            modal.classList.remove('hidden');
            chargerDemandesAgent();
        }
        
        async function chargerDemandesAgent() {
            try {
                const result = await apiCall('demandes.php').catch(() => ({ data: [] }));
                const demandes = result.data || [];
                const demandesAgent = demandes.filter(d => d.agent_assign√©_id == currentUser.id || !d.agent_assign√©_id);
                
                const listContainer = document.getElementById('traiterDemandesList');
                if (!listContainer) return;
                
                listContainer.innerHTML = '';
                
                if (demandesAgent.length === 0) {
                    listContainer.innerHTML = '<p class="text-center text-gray-500 py-8">Aucune demande √† traiter</p>';
                    return;
                }
                
                demandesAgent.forEach(demande => {
                    const div = document.createElement('div');
                    div.className = 'p-4 border rounded-lg hover:bg-gray-50 transition-colors cursor-pointer';
                    
                    const dateCreation = new Date(demande.date_creation);
                    const dateFormatee = dateCreation.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const heureFormatee = dateCreation.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    
                    const statutClass = demande.statut === 'en_attente' ? 'bg-yellow-100 text-yellow-800' : 
                                       demande.statut === 'en_traitement' ? 'bg-blue-100 text-blue-800' : 
                                       demande.statut === 'dossier_incomplet' ? 'bg-red-100 text-red-800' :
                                       'bg-gray-100 text-gray-800';
                    const statutText = demande.statut === 'en_attente' ? 'En attente' : 
                                      demande.statut === 'en_traitement' ? 'En traitement' : 
                                      demande.statut === 'dossier_incomplet' ? 'Dossier incomplet' :
                                      demande.statut;
                    
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-semibold text-lg mb-1">${demande.service || demande.type || 'Demande'}</div>
                                <div class="text-sm text-gray-600 mb-1">
                                    <i class="fas fa-user mr-1"></i>${demande.utilisateur_nom || 'Utilisateur'}
                                </div>
                                <div class="text-sm text-gray-600 mb-1">
                                    <i class="fas fa-hashtag mr-1"></i>${demande.numero_dossier || 'N/A'}
                                </div>
                                <div class="text-xs text-gray-500">
                                    <i class="fas fa-clock mr-1"></i>${dateFormatee} √† ${heureFormatee}
                                </div>
                                ${demande.motif ? `<div class="text-sm text-gray-600 mt-2"><i class="fas fa-info-circle mr-1"></i>${demande.motif}</div>` : ''}
                            </div>
                            <div class="ml-4 flex flex-col items-end gap-2">
                                <span class="px-3 py-1 ${statutClass} rounded text-sm font-medium">${statutText}</span>
                                <button onclick="voirDetailsDemande(${demande.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm transition-colors">
                                    <i class="fas fa-eye mr-1"></i>Voir d√©tails
                                </button>
                            </div>
                        </div>
                    `;
                    listContainer.appendChild(div);
                });
            } catch (error) {
                console.error('Erreur chargement demandes:', error);
                showNotification('Erreur lors du chargement des demandes', 'error');
            }
        }
        
        async function voirDetailsDemande(demandeId) {
            try {
                const result = await apiCall('demandes.php').catch(() => ({ data: [] }));
                const demandes = result.data || [];
                const demande = demandes.find(d => d.id == demandeId);
                
                if (!demande) {
                    showNotification('Demande non trouv√©e', 'error');
                    return;
                }
                
                // Ouvrir la modale de d√©tails
                const modal = document.getElementById('detailsDemandeAgentModal');
                modal.classList.remove('hidden');
                
                // Remplir les informations
                document.getElementById('detailsDemandeId').textContent = demande.numero_dossier || 'N/A';
                document.getElementById('detailsDemandeService').textContent = demande.service || demande.type || 'N/A';
                document.getElementById('detailsDemandeUtilisateur').textContent = demande.utilisateur_nom || 'N/A';
                document.getElementById('detailsDemandeMotif').textContent = demande.motif || 'Non renseign√©';
                document.getElementById('detailsDemandeMontant').textContent = parseFloat(demande.montant || demande.cout || 0).toLocaleString() + ' FCFA';
                
                const dateCreation = new Date(demande.date_creation);
                document.getElementById('detailsDemandeDate').textContent = dateCreation.toLocaleDateString('fr-FR', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Afficher le statut
                const statutSelect = document.getElementById('detailsDemandeStatut');
                statutSelect.value = demande.statut || 'en_attente';
                
                // Stocker l'ID de la demande
                modal.dataset.demandeId = demandeId;
                
                // Charger les documents
                chargerDocumentsDemande(demande);
                
                // Charger les documents requis pour ce service
                chargerDocumentsRequis(demande.type, demande.service);
                
            } catch (error) {
                console.error('Erreur chargement d√©tails:', error);
                showNotification('Erreur lors du chargement des d√©tails', 'error');
            }
        }
        
        function chargerDocumentsDemande(demande) {
            const container = document.getElementById('detailsDemandeDocuments');
            container.innerHTML = '';
            
            let documents = [];
            if (demande.documents) {
                if (typeof demande.documents === 'string') {
                    try {
                        documents = JSON.parse(demande.documents);
                    } catch (e) {
                        documents = [];
                    }
                } else if (Array.isArray(demande.documents)) {
                    documents = demande.documents;
                }
            }
            
            if (documents.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">Aucun document fourni</p>';
                return;
            }
            
            documents.forEach((doc, index) => {
                const div = document.createElement('div');
                div.className = 'p-3 border rounded-lg bg-gray-50';
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="font-medium">${doc.nom || doc.document_name || 'Document ' + (index + 1)}</div>
                            ${doc.fichier ? `
                                <div class="mt-2">
                                    ${doc.fichier.startsWith('data:image') || doc.fichier.startsWith('/') || doc.fichier.startsWith('http') ? 
                                        `<img src="${doc.fichier}" alt="${doc.nom}" class="max-w-full h-auto rounded border" style="max-height: 200px;" onerror="this.style.display='none'">` :
                                        doc.fichier.length > 100 ? 
                                            `<a href="data:application/pdf;base64,${doc.fichier}" target="_blank" class="text-blue-600 hover:underline">
                                                <i class="fas fa-file-pdf mr-1"></i>Voir le document (PDF)
                                            </a>` :
                                            `<span class="text-gray-600">Fichier: ${doc.nom_fichier || 'document'}</span>`
                                    }
                                </div>
                            ` : ''}
                            ${doc.taille ? `<div class="text-xs text-gray-500 mt-1">Taille: ${(doc.taille / 1024).toFixed(2)} KB</div>` : ''}
                        </div>
                        <div class="ml-4">
                            <label class="flex items-center">
                                <input type="checkbox" class="mr-2 document-verifie" data-doc-index="${index}" ${doc.verifie ? 'checked' : ''}>
                                <span class="text-sm">V√©rifi√©</span>
                            </label>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        function chargerDocumentsRequis(type, service) {
            if (!type || !servicesAdmin[type]) return;
            
            const services = servicesAdmin[type].services || [];
            const serviceIndex = services.indexOf(service);
            if (serviceIndex === -1) return;
            
            const documentsRequis = servicesAdmin[type].documents || [];
            const docRequis = documentsRequis[serviceIndex];
            
            const container = document.getElementById('detailsDemandeDocumentsRequis');
            if (docRequis) {
                container.innerHTML = `
                    <div class="bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500">
                        <div class="font-semibold text-blue-800 mb-2">Documents requis:</div>
                        <div class="text-sm text-gray-700">${docRequis}</div>
                    </div>
                `;
            } else {
                container.innerHTML = '';
            }
        }
        
        async function validerDossierDemande() {
            const modal = document.getElementById('detailsDemandeAgentModal');
            const demandeId = modal.dataset.demandeId;
            const statut = document.getElementById('detailsDemandeStatut').value;
            const commentaire = document.getElementById('detailsDemandeCommentaire').value;
            
            if (!demandeId) {
                showNotification('Erreur: ID demande manquant', 'error');
                return;
            }
            
            try {
                const updateData = {
                    id: parseInt(demandeId),
                    statut: statut
                };
                
                if (commentaire) {
                    updateData.commentaire_agent = commentaire;
                }
                
                // V√©rifier les documents v√©rifi√©s
                const documentsVerifies = Array.from(document.querySelectorAll('.document-verifie:checked')).map(cb => parseInt(cb.dataset.docIndex));
                
                // Mettre √† jour la demande
                const result = await apiCall('demandes.php', 'PUT', updateData);
                
                if (result.success) {
                    if (statut === 'dossier_incomplet') {
                        showNotification('Dossier marqu√© comme incomplet. L\'utilisateur sera notifi√©.', 'warning');
                    } else if (statut === 'en_traitement') {
                        showNotification('Demande mise en traitement', 'success');
                    } else if (statut === 'valide') {
                        showNotification('Demande valid√©e avec succ√®s', 'success');
                    }
                    
                    closeModal('detailsDemandeAgentModal');
                    chargerDemandesAgent();
                    if (currentProfile === 'agent') {
                        loadAgentData();
                    }
                }
            } catch (error) {
                showNotification('Erreur lors de la mise √† jour: ' + error.message, 'error');
            }
        }
        
        async function validerDemande(id) {
            try {
                // id peut √™tre un ID num√©rique ou un num√©ro de dossier
                let demandeId = id;
                if (typeof id === 'string' && id.includes('DC')) {
                // Extraire l'ID num√©rique du num√©ro de dossier
                    demandeId = id.replace('DC2025-', '');
                }
                
                const result = await apiCall('demandes.php', 'PUT', {
                    id: demandeId,
                    statut: 'valide'
                });
                
                showNotification(`Demande ${id} valid√©e et sign√©e √©lectroniquement`, 'success');
                
                // Recharger les donn√©es
                if (currentProfile === 'agent') {
                    await loadAgentData();
                }
            } catch (error) {
                showNotification('Erreur lors de la validation', 'error');
            }
        }
        
        function missionsTerrain() {
            showNotification('3 missions actives - GPS activ√© pour navigation', 'info');
        }
        
        function scannerQR() {
            // Simuler un scan QR
            setTimeout(() => {
                showNotification('QR scann√©: Commer√ßant MBANG Pierre - Emplacement E-47 valide', 'success');
            }, 1500);
        }
        
        function redigerRapport() {
            showNotification('Template de rapport charg√© - Saisie vocale activ√©e', 'info');
        }
        
        async function demarrerMission(missionId) {
            try {
                // Mettre √† jour le statut de la mission
                const result = await apiCall('missions.php', 'PUT', {
                    id: missionId,
                    statut: 'en_cours'
                });
                
                if (result.success) {
                    showNotification('Mission d√©marr√©e - Navigation GPS activ√©e', 'success');
                    // Recharger les donn√©es de l'agent
                    await loadAgentData();
                }
            } catch (error) {
                console.error('Erreur d√©marrage mission:', error);
                showNotification('Erreur lors du d√©marrage de la mission', 'error');
            }
        }

        // Fonctions commer√ßants
        function renouvellerPatente() {
            showNotification('Calcul patente: 125,000 FCFA - √âch√©ance 30/03/2025', 'info');
            setTimeout(() => {
                if (confirm('Proc√©der au paiement de la patente ?')) {
                    effectuerPaiement('Patente Commerciale', 125000);
                }
            }, 2000);
        }
        
        function reserverEmplacement() {
            showNotification('Carte des march√©s charg√©e - 15 march√©s disponibles', 'info');
        }
        
        // Fonctions h√¥pital
        function declarerNaissance() {
            showNotification('Formulaire de d√©claration de naissance ouvert', 'info');
            // Ouvrir le formulaire de demande avec le service pr√©-s√©lectionn√©
            document.getElementById('demandeModal').classList.remove('hidden');
            document.getElementById('demandeType').value = 'hopital';
            document.getElementById('demandeType').dispatchEvent(new Event('change'));
            setTimeout(() => {
                document.getElementById('demandeService').value = '0'; // D√©claration de naissance
                document.getElementById('demandeService').dispatchEvent(new Event('change'));
            }, 100);
        }
        
        function declarerDeces() {
            showNotification('Formulaire de d√©claration de d√©c√®s ouvert', 'info');
            // Ouvrir le formulaire de demande avec le service pr√©-s√©lectionn√©
            document.getElementById('demandeModal').classList.remove('hidden');
            document.getElementById('demandeType').value = 'hopital';
            document.getElementById('demandeType').dispatchEvent(new Event('change'));
            setTimeout(() => {
                document.getElementById('demandeService').value = '1'; // D√©claration de d√©c√®s
                document.getElementById('demandeService').dispatchEvent(new Event('change'));
            }, 100);
        }
        
        function certificatNaissance() {
            showNotification('Formulaire de certificat m√©dical de naissance ouvert', 'info');
            document.getElementById('demandeModal').classList.remove('hidden');
            document.getElementById('demandeType').value = 'hopital';
            document.getElementById('demandeType').dispatchEvent(new Event('change'));
            setTimeout(() => {
                document.getElementById('demandeService').value = '3'; // Certificat m√©dical de naissance
                document.getElementById('demandeService').dispatchEvent(new Event('change'));
            }, 100);
        }
        
        function declarerMariage() {
            showNotification('Formulaire d\'acte de mariage ouvert', 'info');
            document.getElementById('demandeModal').classList.remove('hidden');
            document.getElementById('demandeType').value = 'hopital';
            document.getElementById('demandeType').dispatchEvent(new Event('change'));
            setTimeout(() => {
                document.getElementById('demandeService').value = '2'; // Acte de Mariage (C√©l√©bration)
                document.getElementById('demandeService').dispatchEvent(new Event('change'));
            }, 100);
        }
        
        function certificatDeces() {
            showNotification('Formulaire de certificat m√©dical de d√©c√®s ouvert', 'info');
            document.getElementById('demandeModal').classList.remove('hidden');
            document.getElementById('demandeType').value = 'hopital';
            document.getElementById('demandeType').dispatchEvent(new Event('change'));
            setTimeout(() => {
                document.getElementById('demandeService').value = '4'; // Certificat m√©dical de d√©c√®s
                document.getElementById('demandeService').dispatchEvent(new Event('change'));
            }, 100);
        }

        // Fonctions managers
        // Fonctions Manager - Assignation
        async function assignerDemandes() {
            const modal = document.getElementById('assignerDemandesModal');
            modal.classList.remove('hidden');
            await chargerDemandesNonAssignees();
        }
        
        async function chargerDemandesNonAssignees() {
            try {
                const result = await apiCall('demandes.php').catch(() => ({ data: [] }));
                const demandes = result.data || [];
                const demandesNonAssignees = demandes.filter(d => !d.agent_assign√©_id && d.statut === 'en_attente');
                
                // Mettre √† jour le badge
                document.getElementById('managerDemandesNonAssignees').textContent = demandesNonAssignees.length;
                
                const listContainer = document.getElementById('assignerDemandesList');
                if (!listContainer) return;
                
                listContainer.innerHTML = '';
                
                if (demandesNonAssignees.length === 0) {
                    listContainer.innerHTML = '<p class="text-center text-gray-500 py-8">Aucune demande en attente d\'assignation</p>';
                    return;
                }
                
                // Charger la liste des agents
                const agentsResult = await apiCall('users.php').catch(() => ({ data: [] }));
                const agents = (agentsResult.data || []).filter(u => u.role === 'agent' && u.statut === 'actif');
                
                demandesNonAssignees.forEach(demande => {
                    const div = document.createElement('div');
                    div.className = 'p-4 border rounded-lg bg-gray-50';
                    
                    const dateCreation = new Date(demande.date_creation);
                    const dateFormatee = dateCreation.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const heureFormatee = dateCreation.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-semibold text-lg mb-1">${demande.service || demande.type || 'Demande'}</div>
                                <div class="text-sm text-gray-600 mb-1">
                                    <i class="fas fa-user mr-1"></i>${demande.utilisateur_nom || 'Utilisateur'}
                                </div>
                                <div class="text-sm text-gray-600 mb-1">
                                    <i class="fas fa-hashtag mr-1"></i>${demande.numero_dossier || 'N/A'}
                                </div>
                                <div class="text-xs text-gray-500">
                                    <i class="fas fa-clock mr-1"></i>${dateFormatee} √† ${heureFormatee}
                                </div>
                                ${demande.motif ? `<div class="text-sm text-gray-600 mt-2"><i class="fas fa-info-circle mr-1"></i>${demande.motif}</div>` : ''}
                            </div>
                            <div class="ml-4 flex flex-col gap-2">
                                <select id="agentSelect_${demande.id}" class="border border-gray-300 rounded-lg p-2 text-sm">
                                    <option value="">Choisir un agent...</option>
                                    ${agents.map(agent => `<option value="${agent.id}">${agent.name || agent.nom}</option>`).join('')}
                                </select>
                                <button onclick="assignerDemandeAgent(${demande.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm transition-colors">
                                    <i class="fas fa-check mr-1"></i>Assigner
                                </button>
                            </div>
                        </div>
                    `;
                    listContainer.appendChild(div);
                });
            } catch (error) {
                console.error('Erreur chargement demandes:', error);
                showNotification('Erreur lors du chargement des demandes', 'error');
            }
        }
        
        async function assignerDemandeAgent(demandeId) {
            const select = document.getElementById(`agentSelect_${demandeId}`);
            const agentId = select.value;
            
            if (!agentId) {
                showNotification('Veuillez s√©lectionner un agent', 'warning');
                return;
            }
            
            try {
                const result = await apiCall('demandes.php', 'PUT', {
                    id: parseInt(demandeId),
                    agent_assign√©_id: parseInt(agentId),
                    statut: 'en_attente'
                });
                
                if (result.success) {
                    showNotification('Demande assign√©e avec succ√®s', 'success');
                    chargerDemandesNonAssignees();
                    loadManagerData(); // Recharger les stats
                }
            } catch (error) {
                showNotification('Erreur lors de l\'assignation: ' + error.message, 'error');
            }
        }
        
        async function assignerSignalements() {
            const modal = document.getElementById('assignerSignalementsModal');
            modal.classList.remove('hidden');
            await chargerSignalementsNonAssignes();
        }
        
        async function chargerSignalementsNonAssignes() {
            try {
                const result = await apiCall('signalements.php').catch(() => ({ data: [] }));
                const signalements = result.data || [];
                const signalementsNonAssignes = signalements.filter(s => !s.agent_assign√©_id && s.statut === 'en_attente');
                
                // Mettre √† jour le badge
                document.getElementById('managerSignalementsNonAssignes').textContent = signalementsNonAssignes.length;
                
                const listContainer = document.getElementById('assignerSignalementsList');
                if (!listContainer) return;
                
                listContainer.innerHTML = '';
                
                if (signalementsNonAssignes.length === 0) {
                    listContainer.innerHTML = '<p class="text-center text-gray-500 py-8">Aucun signalement en attente d\'assignation</p>';
                    return;
                }
                
                // Charger la liste des agents
                const agentsResult = await apiCall('users.php').catch(() => ({ data: [] }));
                const agents = (agentsResult.data || []).filter(u => u.role === 'agent' && u.statut === 'actif');
                
                signalementsNonAssignes.forEach(signalement => {
                    const div = document.createElement('div');
                    div.className = 'p-4 border rounded-lg bg-gray-50';
                    
                    const dateCreation = new Date(signalement.date_signalement || signalement.date_creation);
                    const dateFormatee = dateCreation.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const heureFormatee = dateCreation.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    
                    const idFormate = signalement.id_formate || 'SIG' + new Date(signalement.date_creation).getFullYear() + '-' + String(signalement.id).padStart(6, '0');
                    
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-semibold text-lg mb-1">${signalement.sous_type || signalement.type || 'Signalement'}</div>
                                <div class="text-sm text-gray-600 mb-1">
                                    <i class="fas fa-user mr-1"></i>${signalement.utilisateur_nom || 'Utilisateur'}
                                </div>
                                <div class="text-sm text-gray-600 mb-1">
                                    <i class="fas fa-hashtag mr-1"></i>${idFormate}
                                </div>
                                <div class="text-xs text-gray-500 mb-2">
                                    <i class="fas fa-clock mr-1"></i>${dateFormatee} √† ${heureFormatee}
                                </div>
                                <div class="text-sm text-gray-700">${signalement.description || ''}</div>
                                ${signalement.localisation ? `<div class="text-xs text-gray-500 mt-1"><i class="fas fa-map-marker-alt mr-1"></i>${signalement.localisation}</div>` : ''}
                            </div>
                            <div class="ml-4 flex flex-col gap-2">
                                <select id="agentSelectSig_${signalement.id}" class="border border-gray-300 rounded-lg p-2 text-sm">
                                    <option value="">Choisir un agent...</option>
                                    ${agents.map(agent => `<option value="${agent.id}">${agent.name || agent.nom}</option>`).join('')}
                                </select>
                                <button onclick="assignerSignalementAgent(${signalement.id})" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm transition-colors">
                                    <i class="fas fa-check mr-1"></i>Assigner
                                </button>
                            </div>
                        </div>
                    `;
                    listContainer.appendChild(div);
                });
            } catch (error) {
                console.error('Erreur chargement signalements:', error);
                showNotification('Erreur lors du chargement des signalements', 'error');
            }
        }
        
        async function assignerSignalementAgent(signalementId) {
            const select = document.getElementById(`agentSelectSig_${signalementId}`);
            const agentId = select.value;
            
            if (!agentId) {
                showNotification('Veuillez s√©lectionner un agent', 'warning');
                return;
            }
            
            try {
                const result = await apiCall('signalements.php', 'PUT', {
                    id: parseInt(signalementId),
                    agent_assign√©_id: parseInt(agentId),
                    statut: 'en_attente'
                });
                
                if (result.success) {
                    showNotification('Signalement assign√© avec succ√®s', 'success');
                    chargerSignalementsNonAssignes();
                    loadManagerData(); // Recharger les stats
                }
            } catch (error) {
                showNotification('Erreur lors de l\'assignation: ' + error.message, 'error');
            }
        }
        
        // Fonction Manager - Valider inscriptions agents
        async function validerInscriptionsAgents() {
            const modal = document.getElementById('validerInscriptionsAgentsModal');
            modal.classList.remove('hidden');
            await chargerAgentsEnAttente();
        }
        
        async function chargerAgentsEnAttente() {
            try {
                const result = await apiCall('users.php').catch(() => ({ data: [] }));
                const users = result.data || [];
                const agentsEnAttente = users.filter(u => u.role === 'agent' && u.statut === 'en_attente');
                
                // Mettre √† jour le badge
                const badge = document.getElementById('managerAgentsEnAttente');
                if (badge) badge.textContent = agentsEnAttente.length;
                
                const listContainer = document.getElementById('validerInscriptionsAgentsList');
                const alertBox = document.getElementById('managerAgentsAlert');
                const alertText = document.getElementById('managerAgentsAlertText');
                if (alertBox) {
                    if (agentsEnAttente.length > 0) {
                        alertBox.classList.remove('hidden');
                        if (alertText) alertText.textContent = `${agentsEnAttente.length} dossier(s) doivent √™tre valid√©s avant activation.`;
                    } else {
                        alertBox.classList.add('hidden');
                        if (alertText) alertText.textContent = 'Aucun dossier en attente.';
                    }
                }
                if (!listContainer) return;
                
                listContainer.innerHTML = '';
                
                if (agentsEnAttente.length === 0) {
                    listContainer.innerHTML = '<p class="text-center text-gray-500 py-8">Aucune demande d\'inscription d\'agent en attente</p>';
                    return;
                }
                
                agentsEnAttente.forEach(agent => {
                    const div = document.createElement('div');
                    div.className = 'p-4 border rounded-lg bg-gray-50';
                    
                    const dateCreation = agent.date_creation ? new Date(agent.date_creation) : new Date();
                    const dateFormatee = dateCreation.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const heureFormatee = dateCreation.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-semibold text-lg mb-1">${agent.name || agent.nom || 'Agent'}</div>
                                <div class="text-sm text-gray-600 mb-1">
                                    <i class="fas fa-phone mr-1"></i>${agent.telephone || 'N/A'}
                                </div>
                                ${agent.email ? `<div class="text-sm text-gray-600 mb-1">
                                    <i class="fas fa-envelope mr-1"></i>${agent.email}
                                </div>` : ''}
                                ${agent.location || agent.localisation ? `<div class="text-sm text-gray-600 mb-1">
                                    <i class="fas fa-map-marker-alt mr-1"></i>${agent.location || agent.localisation}
                                </div>` : ''}
                                <div class="text-xs text-gray-500">
                                    <i class="fas fa-clock mr-1"></i>Demande du ${dateFormatee} √† ${heureFormatee}
                                </div>
                            </div>
                            <div class="ml-4 flex flex-col gap-2">
                                <button onclick="validerAgent(${agent.id})" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm transition-colors">
                                    <i class="fas fa-check mr-1"></i>Valider
                                </button>
                                <button onclick="rejeterAgent(${agent.id})" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm transition-colors">
                                    <i class="fas fa-times mr-1"></i>Rejeter
                                </button>
                            </div>
                        </div>
                    `;
                    listContainer.appendChild(div);
                });
                
            } catch (error) {
                console.error('Erreur chargement agents:', error);
                showNotification('Erreur lors du chargement des demandes d\'inscription', 'error');
            }
        }
        
        async function validerAgent(agentId) {
            try {
                const result = await apiCall('users.php', 'PUT', {
                    id: parseInt(agentId),
                    statut: 'actif'
                });
                
                if (result.success) {
                    showNotification('Agent valid√© avec succ√®s. Il peut maintenant se connecter.', 'success');
                    chargerAgentsEnAttente();
                    loadManagerData(); // Recharger les stats
                }
            } catch (error) {
                showNotification('Erreur lors de la validation: ' + error.message, 'error');
            }
        }
        
        async function rejeterAgent(agentId) {
            const confirmation = confirm('√ätes-vous s√ªr de vouloir rejeter cette demande d\'inscription ? L\'agent ne pourra pas se connecter.');
            if (!confirmation) return;
            
            try {
                const result = await apiCall('users.php', 'PUT', {
                    id: parseInt(agentId),
                    statut: 'rejete'
                });
                
                if (result.success) {
                    showNotification('Demande d\'inscription rejet√©e', 'info');
                    chargerAgentsEnAttente();
                    loadManagerData(); // Recharger les stats
                }
            } catch (error) {
                showNotification('Erreur lors du rejet: ' + error.message, 'error');
            }
        }
        
        // Fonctions Manager - Ouvrir les modales
        function assignerTaches() {
            const modal = document.getElementById('assignerTachesModal');
            modal.classList.remove('hidden');
            chargerAgentsPourTaches();
        }
        
        function evaluationEquipe() {
            const modal = document.getElementById('evaluationEquipeModal');
            modal.classList.remove('hidden');
            chargerEvaluationEquipe();
        }
        
        function planificationEquipe() {
            const modal = document.getElementById('planificationEquipeModal');
            modal.classList.remove('hidden');
            // Initialiser avec la p√©riode actuelle
            const aujourdhui = new Date();
            const finMois = new Date(aujourdhui.getFullYear(), aujourdhui.getMonth() + 1, 0);
            document.getElementById('planningDateDebut').value = aujourdhui.toISOString().split('T')[0];
            document.getElementById('planningDateFin').value = finMois.toISOString().split('T')[0];
        }
        
        function genererRapport() {
            const modal = document.getElementById('genererRapportModal');
            modal.classList.remove('hidden');
            // Initialiser avec le mois actuel
            const aujourdhui = new Date();
            const debutMois = new Date(aujourdhui.getFullYear(), aujourdhui.getMonth(), 1);
            const finMois = new Date(aujourdhui.getFullYear(), aujourdhui.getMonth() + 1, 0);
            document.getElementById('rapportDateDebut').value = debutMois.toISOString().split('T')[0];
            document.getElementById('rapportDateFin').value = finMois.toISOString().split('T')[0];
        }
        
        function analysePerformance() {
            const modal = document.getElementById('analysePerformanceModal');
            modal.classList.remove('hidden');
            chargerAnalysePerformance();
        }
        
        function previsionsTendances() {
            const modal = document.getElementById('previsionsTendancesModal');
            modal.classList.remove('hidden');
            chargerPrevisions();
        }
        
        function gestionMarches() {
            const modal = document.getElementById('gestionMarchesModal');
            modal.classList.remove('hidden');
            chargerMarches();
        }
        
        function controleQualite() {
            const modal = document.getElementById('controleQualiteModal');
            modal.classList.remove('hidden');
            chargerControles();
        }
        
        function planificationTournees() {
            const modal = document.getElementById('planificationTourneesModal');
            modal.classList.remove('hidden');
            chargerTournees();
        }
        
        // Fonctions helper pour charger les donn√©es dans les modales
        async function chargerAgentsPourTaches() {
            try {
                const result = await apiCall('users.php').catch(() => ({ data: [] }));
                const agents = (result.data || []).filter(u => u.role === 'agent' && u.statut === 'actif');
                const select = document.getElementById('tacheAgentSelect');
                select.innerHTML = '<option value="">Choisir un agent...</option>';
                agents.forEach(agent => {
                    const option = document.createElement('option');
                    option.value = agent.id;
                    option.textContent = agent.name || agent.nom;
                    select.appendChild(option);
                });
                
                // Charger les t√¢ches r√©centes
                chargerTachesRecentes();
            } catch (error) {
                console.error('Erreur chargement agents:', error);
            }
        }
        
        async function chargerTachesRecentes() {
            try {
                const result = await apiCall('missions.php').catch(() => ({ data: [] }));
                const missions = result.data || [];
                const list = document.getElementById('tachesList');
                if (missions.length === 0) {
                    list.innerHTML = '<p class="text-center text-gray-500 py-4">Aucune t√¢che assign√©e</p>';
                    return;
                }
                list.innerHTML = missions.slice(0, 5).map(m => `
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="font-medium">${m.titre || 'Mission'}</div>
                        <div class="text-sm text-gray-600">Agent: ${m.agent_nom || 'N/A'}</div>
                        <div class="text-xs text-gray-500">${m.date_mission ? new Date(m.date_mission).toLocaleDateString() : ''}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Erreur chargement t√¢ches:', error);
            }
        }
        
        async function creerTache() {
            const agentId = document.getElementById('tacheAgentSelect').value;
            const titre = document.getElementById('tacheTitre').value;
            const description = document.getElementById('tacheDescription').value;
            const dateLimite = document.getElementById('tacheDateLimite').value;
            
            if (!agentId || !titre || !description) {
                showNotification('Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }
            
            try {
                const result = await apiCall('missions.php', 'POST', {
                    agent_id: parseInt(agentId),
                    titre: titre,
                    description: description,
                    date_mission: dateLimite || null,
                    statut: 'assignee'
                });
                
                showNotification('T√¢che assign√©e avec succ√®s', 'success');
                closeModal('assignerTachesModal');
                chargerTachesRecentes();
            } catch (error) {
                showNotification('Erreur lors de l\'assignation: ' + error.message, 'error');
            }
        }
        
        async function chargerEvaluationEquipe() {
            try {
                const [usersResult, missionsResult] = await Promise.all([
                    apiCall('users.php').catch(() => ({ data: [] })),
                    apiCall('missions.php').catch(() => ({ data: [] }))
                ]);
                
                const agents = (usersResult.data || []).filter(u => u.role === 'agent');
                const missions = missionsResult.data || [];
                
                document.getElementById('evalAgentsTotal').textContent = agents.length;
                
                const completees = missions.filter(m => m.statut === 'termine' || m.statut === 'complete').length;
                document.getElementById('evalMissionsCompletees').textContent = completees;
                
                const moyenne = agents.length > 0 ? Math.round((completees / agents.length) * 10) / 10 : 0;
                document.getElementById('evalMoyenne').textContent = moyenne;
                
                const list = document.getElementById('evaluationAgentsList');
                if (agents.length === 0) {
                    list.innerHTML = '<p class="text-center text-gray-500 py-4">Aucun agent</p>';
                    return;
                }
                
                list.innerHTML = agents.map(agent => {
                    const agentMissions = missions.filter(m => m.agent_id === agent.id);
                    const completees = agentMissions.filter(m => m.statut === 'termine' || m.statut === 'complete').length;
                    const note = agentMissions.length > 0 ? Math.round((completees / agentMissions.length) * 10) : 0;
                    
                    return `
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="font-medium">${agent.name || agent.nom}</div>
                                    <div class="text-sm text-gray-600">${agentMissions.length} missions</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-green-600">${note}/10</div>
                                    <div class="text-xs text-gray-500">${completees} compl√©t√©es</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Erreur chargement √©valuation:', error);
            }
        }
        
        function chargerPlanning() {
            const dateDebut = document.getElementById('planningDateDebut').value;
            const dateFin = document.getElementById('planningDateFin').value;
            
            if (!dateDebut || !dateFin) {
                showNotification('Veuillez s√©lectionner une p√©riode', 'warning');
                return;
            }
            
            const container = document.getElementById('planningCalendrier');
            container.innerHTML = '<p class="text-center text-gray-500 py-8">Chargement du planning...</p>';
            
            // Simuler le chargement (√† remplacer par un vrai appel API)
            setTimeout(() => {
                container.innerHTML = `
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="font-semibold mb-2">Planning du ${dateDebut} au ${dateFin}</div>
                        <p class="text-sm text-gray-600">Fonctionnalit√© en d√©veloppement</p>
                    </div>
                `;
            }, 1000);
        }
        
        function genererRapportPDF() {
            const type = document.getElementById('rapportType').value;
            const dateDebut = document.getElementById('rapportDateDebut').value;
            const dateFin = document.getElementById('rapportDateFin').value;
            const sections = Array.from(document.querySelectorAll('input[name="rapportSections"]:checked')).map(cb => cb.value);
            
            if (!dateDebut || !dateFin) {
                showNotification('Veuillez s√©lectionner une p√©riode', 'warning');
                return;
            }
            
            showNotification('G√©n√©ration du rapport en cours...', 'info');
            
            // Simuler la g√©n√©ration
            setTimeout(() => {
                showNotification(`Rapport ${type} g√©n√©r√© avec succ√®s (${sections.length} sections)`, 'success');
                closeModal('genererRapportModal');
            }, 2000);
        }
        
        async function chargerAnalysePerformance() {
            try {
                const [demandesResult, signalementsResult] = await Promise.all([
                    apiCall('demandes.php').catch(() => ({ data: [] })),
                    apiCall('signalements.php').catch(() => ({ data: [] }))
                ]);
                
                const demandes = demandesResult.data || [];
                const signalements = signalementsResult.data || [];
                
                const details = document.getElementById('performanceDetails');
                details.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="font-semibold text-blue-800">Demandes</div>
                            <div class="text-2xl font-bold text-blue-600 mt-2">${demandes.length}</div>
                            <div class="text-sm text-gray-600">Total trait√©es</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <div class="font-semibold text-green-800">Signalements</div>
                            <div class="text-2xl font-bold text-green-600 mt-2">${signalements.length}</div>
                            <div class="text-sm text-gray-600">Total re√ßus</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Erreur chargement performance:', error);
            }
        }
        
        function chargerPrevisions() {
            const list = document.getElementById('previsionsList');
            list.innerHTML = `
                <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                    <div class="font-semibold text-blue-800">Mars 2025</div>
                    <div class="text-sm text-gray-600 mt-1">Pic de demandes pr√©vu: +34%</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
                    <div class="font-semibold text-green-800">Avril 2025</div>
                    <div class="text-sm text-gray-600 mt-1">Stabilisation pr√©vue: +12%</div>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-500">
                    <div class="font-semibold text-yellow-800">Mai 2025</div>
                    <div class="text-sm text-gray-600 mt-1">Baisse saisonni√®re: -8%</div>
                </div>
            `;
        }
        
        async function chargerMarches() {
            try {
                // Utiliser les donn√©es d'emplacements si disponibles
                const result = await apiCall('emplacements.php').catch(() => ({ data: [] }));
                const emplacements = result.data || [];
                
                const total = emplacements.length;
                const occupes = emplacements.filter(e => e.statut === 'occupe' || e.statut === 'reserve').length;
                const taux = total > 0 ? Math.round((occupes / total) * 100) : 0;
                
                document.getElementById('marchesTotal').textContent = total;
                document.getElementById('marchesOccupation').textContent = taux + '%';
                document.getElementById('marchesRecettes').textContent = '0';
                
                const list = document.getElementById('marchesList');
                if (emplacements.length === 0) {
                    list.innerHTML = '<p class="text-center text-gray-500 py-4">Aucun march√© disponible</p>';
                    return;
                }
                
                list.innerHTML = emplacements.slice(0, 10).map(e => `
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="font-medium">${e.nom || 'March√©'}</div>
                        <div class="text-sm text-gray-600">Statut: ${e.statut || 'N/A'}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Erreur chargement march√©s:', error);
            }
        }
        
        function programmerControle() {
            showNotification('Fonctionnalit√© de programmation de contr√¥le en d√©veloppement', 'info');
        }
        
        function chargerControles() {
            const list = document.getElementById('controlesList');
            list.innerHTML = '<p class="text-center text-gray-500 py-4">Aucun contr√¥le programm√©</p>';
        }
        
        function chargerTournees() {
            const list = document.getElementById('tourneesList');
            list.innerHTML = `
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="font-medium mb-2">Tourn√©e Optimis√©e</div>
                    <div class="text-sm text-gray-600">15 march√©s - Distance totale: 45 km</div>
                    <div class="text-xs text-gray-500 mt-1">Temps estim√©: 3h 30min</div>
                </div>
            `;
        }

        // Fonctions super admin
        function creerUtilisateur() {
            const nom = prompt('Nom du nouvel utilisateur:');
            if (nom) {
                showNotification(`Utilisateur "${nom}" cr√©√© - SMS d'activation envoy√©`, 'success');
            }
        }
        
        function gererDroits() {
            showNotification('Matrice de permissions charg√©e - 25 droits configurables', 'info');
        }
        
        function auditConnexions() {
            showNotification('15,247 connexions cette semaine - 47 √©checs d√©tect√©s', 'info');
        }
        
        function configurerTarifs() {
            showNotification('47 services tarif√©s - Interface d\'√©dition charg√©e', 'info');
        }
        
        function parametresGeneraux() {
            showNotification('Param√®tres syst√®me charg√©s - D√©lais, notifications, s√©curit√©', 'info');
        }
        
        function integrationsAPI() {
            showNotification('8 APIs connect√©es - Statuts verts', 'success');
        }
        
        function roiDigitalisation() {
            showNotification('ROI calcul√©: 234M FCFA √©conomis√©s/an (+67% efficacit√©)', 'success');
        }
        
        function predictionsIA() {
            showNotification('IA: Mars +34% demandes, √ât√© -18%, Rentr√©e +45% permis', 'info');
        }
        
        function reportingExecutif() {
            showNotification('Rapport ex√©cutif g√©n√©r√© - Distribution automatique', 'success');
        }
        
        function sauvegardes() {
            showNotification('Derni√®re sauvegarde: 13/01/2025 02:15 (Succ√®s - 2.3 Go)', 'success');
        }
        
        function performance() {
            showNotification('Uptime: 99.97% - R√©ponse: 187ms - CPU: 34%', 'success');
        }
        
        function logs() {
            showNotification('15,247 actions trac√©es cette semaine', 'info');
        }
        
        function monitoring() {
            showNotification('Monitoring 24/7 actif - 3 alertes en cours', 'info');
        }

        // Chat IA
        function toggleChat() {
            const container = document.getElementById('chatContainer');
            const isVisible = container.style.display === 'flex';
            container.style.display = isVisible ? 'none' : 'flex';
        }
        
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Ajouter le message utilisateur
            addChatMessage(message, 'user');
            
            // G√©n√©rer la r√©ponse IA
            setTimeout(() => {
                const response = generateAIResponse(message);
                addChatMessage(response, 'ai');
            }, 1000);
            
            input.value = '';
        }
        
        function addChatMessage(message, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'mb-4';
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="bg-blue-100 text-blue-800 p-3 rounded-lg ml-8">
                        <strong>Vous:</strong> ${message}
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="bg-green-100 text-green-800 p-3 rounded-lg mr-8">
                        <strong>ASSISTANT ECITYZEN:</strong> ${message}
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function generateAIResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            for (const [keyword, response] of Object.entries(aiResponses)) {
                if (lowerMessage.includes(keyword)) {
                    return response;
                }
            }
            
            return aiResponses.default;
        }
        
        // Permettre l'envoi avec Entr√©e
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Fonctions utilitaires
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            
            // R√©initialiser les formulaires
            if (modalId === 'signalementModal') {
                document.getElementById('signalementForm').reset();
                document.getElementById('signalementSousType').innerHTML = '<option value="">Choisir d\'abord le type...</option>';
                // R√©initialiser la carte au centre du Gabon
                if (signalementMap && signalementMarker) {
                    signalementMarker.setLatLng(GABON_CENTER);
                    signalementMap.setView(GABON_CENTER, 7);
                    updateSignalementLocation(GABON_CENTER[0], GABON_CENTER[1]);
                }
            } else if (modalId === 'registerFormContainer') {
                // R√©initialiser la carte d'inscription si visible
                if (registerMap && registerMarker) {
                    registerMarker.setLatLng(GABON_CENTER);
                    registerMap.setView(GABON_CENTER, 7);
                    updateRegisterLocation(GABON_CENTER[0], GABON_CENTER[1]);
                }
            }
        }
        
        async function showMesDemandes() {
            try {
                const result = await apiCall('demandes.php');
                const demandes = result.data || [];
                
                // Mettre √† jour les statistiques
                const total = demandes.length;
                const validees = demandes.filter(d => d.statut === 'valide').length;
                const enCours = demandes.filter(d => d.statut === 'en_traitement').length;
                const actives = demandes.filter(d => d.statut !== 'valide' && d.statut !== 'rejete' && d.statut !== 'annule').length;
                
                document.getElementById('totalDemandes').textContent = total;
                document.getElementById('valideesDemandes').textContent = validees;
                document.getElementById('enCoursDemandes').textContent = enCours;
                
                // Afficher la liste des demandes
                const listContainer = document.getElementById('mesDemandesList');
                listContainer.innerHTML = '';
                
                if (demandes.length === 0) {
                    listContainer.innerHTML = '<p class="text-center text-gray-500 py-8">Aucune demande</p>';
                } else {
                    // Trier par date (plus r√©centes en premier)
                    const demandesTriees = demandes.sort((a, b) => {
                        const dateA = new Date(a.date_creation || 0);
                        const dateB = new Date(b.date_creation || 0);
                        return dateB - dateA;
                    });
                    
                    demandesTriees.forEach(demande => {
                        const dateCreation = new Date(demande.date_creation);
                        const dateFormatee = dateCreation.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                        const heureFormatee = dateCreation.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                        
                        const statutClass = demande.statut === 'valide' ? 'bg-green-100 text-green-800' : 
                                           demande.statut === 'en_traitement' ? 'bg-blue-100 text-blue-800' : 
                                           demande.statut === 'rejete' ? 'bg-red-100 text-red-800' :
                                           demande.statut === 'annule' ? 'bg-gray-100 text-gray-800' :
                                           'bg-yellow-100 text-yellow-800';
                        const statutText = demande.statut === 'valide' ? 'Valid√©' : 
                                          demande.statut === 'en_traitement' ? 'En traitement' : 
                                          demande.statut === 'rejete' ? 'Rejet√©' :
                                          demande.statut === 'annule' ? 'Annul√©' :
                                          'En attente';
                        
                        const div = document.createElement('div');
                        div.className = 'p-4 border rounded-lg hover:bg-gray-50 transition-colors';
                        div.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <h3 class="font-semibold text-lg">${demande.service || demande.type || 'Demande'}</h3>
                                        <span class="px-2 py-1 ${statutClass} rounded text-xs font-medium">${statutText}</span>
                                    </div>
                                    <div class="text-sm text-gray-600 space-y-1">
                                        <div><i class="fas fa-hashtag mr-2"></i>${demande.numero_dossier || 'N/A'}</div>
                                        <div><i class="fas fa-clock mr-2"></i>${dateFormatee} √† ${heureFormatee}</div>
                                        ${demande.motif ? `<div><i class="fas fa-info-circle mr-2"></i>${demande.motif}</div>` : ''}
                                        <div><i class="fas fa-money-bill mr-2"></i>${parseFloat(demande.cout || 0).toLocaleString()} FCFA</div>
                                        ${demande.agent_nom ? `<div><i class="fas fa-user-tie mr-2"></i>Agent: ${demande.agent_nom}</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                        listContainer.appendChild(div);
                    });
                }
                
                // Ouvrir la modale
                document.getElementById('mesDemandesModal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Erreur chargement demandes:', error);
                showNotification('Erreur lors du chargement des demandes', 'error');
            }
        }
        
        async function showPaiements() {
            try {
                const result = await apiCall('paiements.php');
                const paiements = result.data || [];
                
                // Filtrer les paiements confirm√©s
                const confirmes = paiements.filter(p => p.statut === 'confirme');
                const total = confirmes.reduce((sum, p) => sum + parseFloat(p.montant || 0), 0);
                
                // Mettre √† jour les statistiques
                document.getElementById('totalPaiements').textContent = confirmes.length;
                document.getElementById('montantTotalPaiements').textContent = total.toLocaleString();
                
                // Afficher la liste des paiements
                const listContainer = document.getElementById('mesPaiementsList');
                listContainer.innerHTML = '';
                
                if (confirmes.length === 0) {
                    listContainer.innerHTML = '<p class="text-center text-gray-500 py-8">Aucun paiement effectu√©</p>';
                } else {
                    // Trier par date (plus r√©cents en premier)
                    const paiementsTries = confirmes.sort((a, b) => {
                        const dateA = new Date(a.date_paiement || a.date_confirmation || 0);
                        const dateB = new Date(b.date_paiement || b.date_confirmation || 0);
                        return dateB - dateA;
                    });
                    
                    paiementsTries.forEach(paiement => {
                        const datePaiement = new Date(paiement.date_paiement || paiement.date_confirmation);
                        const dateFormatee = datePaiement.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                        const heureFormatee = datePaiement.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                        
                        const methodeIcons = {
                            'clickpay': 'fa-credit-card',
                            'airtel': 'fa-mobile-alt',
                            'moov': 'fa-mobile-alt',
                            'carte': 'fa-credit-card',
                            'especes': 'fa-money-bill'
                        };
                        const methodeColors = {
                            'clickpay': 'text-green-600',
                            'airtel': 'text-red-600',
                            'moov': 'text-blue-600',
                            'carte': 'text-purple-600',
                            'especes': 'text-green-600'
                        };
                        const methodeText = {
                            'clickpay': 'ClickPay',
                            'airtel': 'Airtel Money',
                            'moov': 'Moov Money',
                            'carte': 'Carte Bancaire',
                            'especes': 'Esp√®ces'
                        };
                        
                        const div = document.createElement('div');
                        div.className = 'p-4 border rounded-lg hover:bg-gray-50 transition-colors';
                        div.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <h3 class="font-semibold text-lg">${paiement.type_paiement || 'Paiement'}</h3>
                                        <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-medium">Confirm√©</span>
                                    </div>
                                    <div class="text-sm text-gray-600 space-y-1">
                                        <div><i class="fas ${methodeIcons[paiement.methode] || 'fa-money-bill'} ${methodeColors[paiement.methode] || 'text-gray-600'} mr-2"></i>${methodeText[paiement.methode] || paiement.methode}</div>
                                        <div><i class="fas fa-clock mr-2"></i>${dateFormatee} √† ${heureFormatee}</div>
                                        ${paiement.reference_paiement ? `<div><i class="fas fa-hashtag mr-2"></i>R√©f: ${paiement.reference_paiement}</div>` : ''}
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-green-600">${parseFloat(paiement.montant || 0).toLocaleString()}</div>
                                    <div class="text-sm text-gray-500">FCFA</div>
                                </div>
                            </div>
                        `;
                        listContainer.appendChild(div);
                    });
                }
                
                // Ouvrir la modale
                document.getElementById('mesPaiementsModal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Erreur chargement paiements:', error);
                showNotification('Erreur lors du chargement des paiements', 'error');
            }
        }

        // Graphiques
        function initManagerChart() {
            const ctx = document.getElementById('managerChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Jun'],
                    datasets: [{
                        label: 'Demandes trait√©es',
                        data: [723, 756, 847, 892, 934, 978],
                        borderColor: 'rgb(147, 51, 234)',
                        backgroundColor: 'rgba(147, 51, 234, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function initAdminChart() {
            const ctx = document.getElementById('adminChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Citoyens', 'Commer√ßants', 'Agents'],
                    datasets: [{
                        data: [973, 149, 125],
                        backgroundColor: [
                            'rgb(34, 197, 94)',
                            'rgb(251, 191, 36)', 
                            'rgb(59, 130, 246)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // ========== FONCTIONS POUR LES NOUVEAUX MODULES ==========
        
        // Budget Municipal
        async function showBudgetMunicipal() {
            document.getElementById('budgetModal').classList.remove('hidden');
            loadBudget();
        }
        
        async function loadBudget() {
            const exercice = document.getElementById('budgetExercice').value;
            const content = document.getElementById('budgetContent');
            
            try {
                const result = await apiCall(`budget.php?exercice=${exercice}`);
                const budget = result.data || {};
                
                if (!budget.postes || budget.postes.length === 0) {
                    content.innerHTML = '<div class="text-center py-8 text-gray-500">Aucun budget disponible pour cet exercice</div>';
                    return;
                }
                
                let html = `
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded">
                            <div class="text-2xl font-bold text-blue-600">${formatMoney(budget.total_budget || 0)}</div>
                            <div class="text-sm text-gray-600">Budget total</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded">
                            <div class="text-2xl font-bold text-green-600">${formatMoney(budget.total_depenses || 0)}</div>
                            <div class="text-sm text-gray-600">D√©penses engag√©es</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded">
                            <div class="text-2xl font-bold text-purple-600">${budget.taux_execution_global || 0}%</div>
                            <div class="text-sm text-gray-600">Taux d'ex√©cution</div>
                        </div>
                    </div>
                `;
                
                // Grouper par cat√©gorie
                const fonctionnement = budget.postes.filter(p => p.categorie === 'fonctionnement');
                const investissement = budget.postes.filter(p => p.categorie === 'investissement');
                
                if (fonctionnement.length > 0) {
                    html += '<h3 class="font-bold text-lg mb-3">Fonctionnement</h3>';
                    html += generateBudgetTable(fonctionnement);
                }
                
                if (investissement.length > 0) {
                    html += '<h3 class="font-bold text-lg mb-3 mt-6">Investissement</h3>';
                    html += generateBudgetTable(investissement);
                }
                
                content.innerHTML = html;
            } catch (error) {
                console.error('Erreur chargement budget:', error);
                content.innerHTML = '<div class="text-center py-8 text-red-500">Erreur lors du chargement du budget</div>';
            }
        }
        
        function generateBudgetTable(postes) {
            let html = '<div class="overflow-x-auto"><table class="w-full border-collapse"><thead><tr class="bg-gray-100"><th class="border p-2 text-left">Poste</th><th class="border p-2 text-right">Budget initial</th><th class="border p-2 text-right">D√©penses</th><th class="border p-2 text-right">Taux</th></tr></thead><tbody>';
            
            postes.forEach(poste => {
                const taux = poste.taux_execution || 0;
                const tauxClass = taux > 100 ? 'text-red-600' : taux > 80 ? 'text-orange-600' : 'text-green-600';
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="border p-2">${poste.poste_budgetaire}</td>
                        <td class="border p-2 text-right">${formatMoney(poste.budget_initial)}</td>
                        <td class="border p-2 text-right">${formatMoney(poste.depenses_engagees || 0)}</td>
                        <td class="border p-2 text-right ${tauxClass} font-semibold">${taux.toFixed(1)}%</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            return html;
        }
        
        // Travaux Publics
        let travauxMap = null;
        
        async function showTravauxPublics() {
            document.getElementById('travauxModal').classList.remove('hidden');
            setTimeout(() => {
                if (!travauxMap) {
                    travauxMap = L.map('travauxMap').setView(GABON_CENTER, 12);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap'
                    }).addTo(travauxMap);
                } else {
                    travauxMap.invalidateSize();
                }
                loadChantiers();
            }, 100);
        }
        
        async function loadChantiers() {
            const statut = document.getElementById('travauxStatut')?.value || '';
            const type = document.getElementById('travauxType')?.value || '';
            
            let url = 'chantiers.php';
            if (statut) url += `?statut=${statut}`;
            if (type) url += (statut ? '&' : '?') + `type=${type}`;
            
            try {
                const result = await apiCall(url);
                const chantiers = result.data || [];
                const listContainer = document.getElementById('chantiersList');
                
                if (chantiers.length === 0) {
                    listContainer.innerHTML = '<div class="text-center py-8 text-gray-500">Aucun chantier disponible</div>';
                    return;
                }
                
                // Nettoyer la carte
                if (travauxMap) {
                    travauxMap.eachLayer(layer => {
                        if (layer instanceof L.Marker) {
                            travauxMap.removeLayer(layer);
                        }
                    });
                }
                
                let html = '';
                chantiers.forEach(chantier => {
                    const statutClass = {
                        'a_venir': 'bg-gray-100 text-gray-800',
                        'en_cours': 'bg-blue-100 text-blue-800',
                        'suspendu': 'bg-orange-100 text-orange-800',
                        'termine': 'bg-green-100 text-green-800'
                    }[chantier.statut_chantier] || 'bg-gray-100';
                    
                    const statutText = {
                        'a_venir': '√Ä venir',
                        'en_cours': 'En cours',
                        'suspendu': 'Suspendu',
                        'termine': 'Termin√©'
                    }[chantier.statut_chantier] || chantier.statut_chantier;
                    
                    // Ajouter marqueur sur la carte
                    if (travauxMap && chantier.latitude && chantier.longitude) {
                        const marker = L.marker([chantier.latitude, chantier.longitude]).addTo(travauxMap);
                        marker.bindPopup(`<b>${chantier.nom_chantier}</b><br>${statutText}`);
                    }
                    
                    html += `
                        <div class="border rounded p-2.5 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-1.5">
                                <h4 class="font-semibold text-base">${chantier.nom_chantier}</h4>
                                <span class="px-2 py-0.5 ${statutClass} rounded text-xs">${statutText}</span>
                            </div>
                            <div class="text-xs text-gray-600 mb-1">
                                <i class="fas fa-tools mr-1"></i>${chantier.type_travaux}
                            </div>
                            <div class="text-xs text-gray-600 mb-1">
                                <i class="fas fa-calendar mr-1"></i>${new Date(chantier.date_debut).toLocaleDateString('fr-FR')} - ${new Date(chantier.date_fin_prevue).toLocaleDateString('fr-FR')}
                            </div>
                            ${chantier.description ? `<p class="text-xs text-gray-700 mb-1">${chantier.description}</p>` : ''}
                            ${chantier.impact_circulation !== 'aucun_impact' ? `<div class="text-xs text-orange-600"><i class="fas fa-exclamation-triangle mr-1"></i>Impact: ${chantier.impact_circulation.replace('_', ' ')}</div>` : ''}
                            ${chantier.itineraire_alternatif ? `<div class="text-xs text-blue-600 mt-1"><i class="fas fa-route mr-1"></i>Itin√©raire alternatif: ${chantier.itineraire_alternatif}</div>` : ''}
                        </div>
                    `;
                });
                
                listContainer.innerHTML = html;
                
                // Ajuster la vue de la carte si des chantiers sont visibles
                if (travauxMap && chantiers.length > 0 && chantiers[0].latitude) {
                    const bounds = chantiers
                        .filter(c => c.latitude && c.longitude)
                        .map(c => [c.latitude, c.longitude]);
                    if (bounds.length > 0) {
                        travauxMap.fitBounds(bounds);
                    }
                }
            } catch (error) {
                console.error('Erreur chargement chantiers:', error);
                document.getElementById('chantiersList').innerHTML = '<div class="text-center py-8 text-red-500">Erreur lors du chargement</div>';
            }
        }
        
        // Notifications
        async function showNotifications() {
            document.getElementById('notificationsModal').classList.remove('hidden');
            loadNotifications();
        }
        
        async function loadNotifications() {
            try {
                const result = await apiCall('notifications.php');
                const data = result.data || {};
                const notifications = data.notifications || [];
                const nonLues = data.non_lues || 0;
                
                const container = document.getElementById('notificationsList');
                
                if (notifications.length === 0) {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">Aucune notification</div>';
                    return;
                }
                
                let html = '';
                if (nonLues > 0) {
                    html += `<div class="bg-blue-100 text-blue-800 p-3 rounded mb-3">${nonLues} notification${nonLues > 1 ? 's' : ''} non lue${nonLues > 1 ? 's' : ''}</div>`;
                }
                
                notifications.forEach(notif => {
                    const isNonLue = !notif.statut_lecture || notif.statut_lecture === 'non_lu';
                    const categorieClass = {
                        'urgente': 'bg-red-100 text-red-800',
                        'importante': 'bg-orange-100 text-orange-800',
                        'informative': 'bg-blue-100 text-blue-800'
                    }[notif.categorie] || 'bg-gray-100';
                    
                    html += `
                        <div class="border rounded p-4 ${isNonLue ? 'bg-blue-50 border-blue-300' : ''} hover:shadow-md transition-shadow cursor-pointer" onclick="marquerNotificationLue(${notif.id})">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-semibold">${notif.titre}</h4>
                                <span class="px-2 py-1 ${categorieClass} rounded text-xs">${notif.categorie}</span>
                            </div>
                            <p class="text-sm text-gray-700 mb-2">${notif.message}</p>
                            <div class="text-xs text-gray-500">
                                <i class="fas fa-clock mr-1"></i>${new Date(notif.date_envoi).toLocaleString('fr-FR')}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Erreur chargement notifications:', error);
            }
        }
        
        async function marquerNotificationLue(id) {
            try {
                await apiCall('notifications.php', 'PUT', { notification_id: id });
                loadNotifications();
            } catch (error) {
                console.error('Erreur:', error);
            }
        }
        
        async function showPreferencesNotifications() {
            document.getElementById('preferencesNotificationsModal').classList.remove('hidden');
            
            try {
                const result = await apiCall('preferences_notifications.php');
                const prefs = result.data || {};
                
                // Remplir le formulaire
                Object.keys(prefs).forEach(key => {
                    const input = document.querySelector(`[name="${key}"]`);
                    if (input) {
                        if (input.type === 'checkbox') {
                            input.checked = prefs[key] == 1 || prefs[key] === true;
                        } else {
                            input.value = prefs[key] || '';
                        }
                    }
                });
            } catch (error) {
                console.error('Erreur chargement pr√©f√©rences:', error);
            }
        }
        
        document.getElementById('preferencesForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value === 'on' ? true : value;
            });
            
            try {
                const result = await apiCall('preferences_notifications.php', 'POST', data);
                
                if (result.success) {
                    showNotification('Pr√©f√©rences enregistr√©es', 'success');
                    closeModal('preferencesNotificationsModal');
                }
            } catch (error) {
                console.error('Erreur sauvegarde pr√©f√©rences:', error);
                showNotification('Erreur lors de l\'enregistrement', 'error');
            }
        });
        
        // Assistance
        async function showAssistance() {
            document.getElementById('assistanceModal').classList.remove('hidden');
            loadFAQ();
        }
        
        // Feedback
        function showFeedback() {
            document.getElementById('feedbackModal').classList.remove('hidden');
            
            // Initialiser les √©toiles
            const stars = document.querySelectorAll('#ratingStars .fa-star');
            let selectedRating = 0;
            
            stars.forEach((star, index) => {
                star.addEventListener('mouseenter', function() {
                    const rating = index + 1;
                    stars.forEach((s, i) => {
                        if (i < rating) {
                            s.classList.remove('text-gray-300');
                            s.classList.add('text-yellow-400');
                        } else {
                            s.classList.remove('text-yellow-400');
                            s.classList.add('text-gray-300');
                        }
                    });
                });
                
                star.addEventListener('click', function() {
                    selectedRating = index + 1;
                    document.getElementById('ratingValue').value = selectedRating;
                    stars.forEach((s, i) => {
                        if (i < selectedRating) {
                            s.classList.remove('text-gray-300');
                            s.classList.add('text-yellow-400');
                        } else {
                            s.classList.remove('text-yellow-400');
                            s.classList.add('text-gray-300');
                        }
                    });
                });
            });
            
            // R√©initialiser au survol de la zone
            document.getElementById('ratingStars').addEventListener('mouseleave', function() {
                if (selectedRating === 0) {
                    stars.forEach(s => {
                        s.classList.remove('text-yellow-400');
                        s.classList.add('text-gray-300');
                    });
                } else {
                    stars.forEach((s, i) => {
                        if (i < selectedRating) {
                            s.classList.remove('text-gray-300');
                            s.classList.add('text-yellow-400');
                        } else {
                            s.classList.remove('text-yellow-400');
                            s.classList.add('text-gray-300');
                        }
                    });
                }
            });
        }
        
        // Soumettre le feedback
        document.getElementById('feedbackForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const rating = document.getElementById('ratingValue').value;
            
            if (rating === '0' || rating === '') {
                showNotification('Veuillez donner une note', 'error');
                return;
            }
            
            try {
                const data = {
                    note: parseInt(rating),
                    type_service: formData.get('type_service'),
                    commentaire: formData.get('commentaire')
                };
                
                const result = await apiCall('feedback.php', 'POST', data);
                
                if (result.success) {
                    showNotification('Merci pour votre avis !', 'success');
                    closeModal('feedbackModal');
                    e.target.reset();
                    // R√©initialiser les √©toiles
                    document.querySelectorAll('#ratingStars .fa-star').forEach(s => {
                        s.classList.remove('text-yellow-400');
                        s.classList.add('text-gray-300');
                    });
                    document.getElementById('ratingValue').value = '0';
                }
            } catch (error) {
                console.error('Erreur envoi feedback:', error);
                showNotification('Erreur lors de l\'envoi du feedback', 'error');
            }
        });
        
        async function loadFAQ() {
            try {
                const result = await apiCall('assistance.php?type=faq');
                const faq = result.data || [];
                
                const container = document.getElementById('faqList');
                
                if (faq.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500">Aucune FAQ disponible</p>';
                    return;
                }
                
                let html = '';
                faq.forEach(item => {
                    html += `
                        <div class="border rounded p-2 mb-2">
                            <div class="font-semibold text-sm">${item.question}</div>
                            <div class="text-xs text-gray-600 mt-1">${item.reponse.substring(0, 100)}...</div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Erreur chargement FAQ:', error);
            }
        }
        
        document.getElementById('assistanceForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            
            try {
                const result = await apiCall('assistance.php', 'POST', {
                    type_message: 'chat',
                    sujet: formData.get('sujet'),
                    message: formData.get('message')
                });
                
                if (result.success) {
                    showNotification('Message envoy√©', 'success');
                    e.target.reset();
                }
            } catch (error) {
                console.error('Erreur envoi message:', error);
                showNotification('Erreur lors de l\'envoi', 'error');
            }
        });
        
        // Chef de Quartier
        async function loadChefQuartierData() {
            try {
                const result = await apiCall('chefs_quartier.php');
                const signalements = result.data || [];
                
                // Statistiques
                const total = signalements.length;
                const resolus = signalements.filter(s => s.statut_traitement === 'resolu').length;
                const enCours = signalements.filter(s => s.statut_traitement === 'en_cours').length;
                
                document.getElementById('chefSignalementsTotal').textContent = total;
                document.getElementById('chefSignalementsResolus').textContent = resolus;
                document.getElementById('chefSignalementsEnCours').textContent = enCours;
                
                // Liste
                updateChefSignalementsList(signalements);
            } catch (error) {
                console.error('Erreur chargement donn√©es chef quartier:', error);
            }
        }
        
        function updateChefSignalementsList(signalements) {
            const container = document.getElementById('chefSignalementsList');
            if (!container) return;
            
            if (signalements.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Aucun signalement</p>';
                return;
            }
            
            let html = '';
            signalements.forEach(sig => {
                const statutClass = {
                    'nouveau': 'bg-blue-100 text-blue-800',
                    'en_etude': 'bg-yellow-100 text-yellow-800',
                    'en_cours': 'bg-orange-100 text-orange-800',
                    'resolu': 'bg-green-100 text-green-800',
                    'archive': 'bg-gray-100 text-gray-800'
                }[sig.statut_traitement] || 'bg-gray-100';
                
                html += `
                    <div class="border rounded p-3 mb-3">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="font-semibold">${sig.nom_quartier}</div>
                                <div class="text-sm text-gray-600">${sig.type_signalement.replace('_', ' ')}</div>
                            </div>
                            <span class="px-2 py-1 ${statutClass} rounded text-xs">${sig.statut_traitement}</span>
                        </div>
                        <p class="text-sm text-gray-700 mb-2">${sig.description_detaillee}</p>
                        ${sig.retour_mairie ? `<div class="text-sm bg-gray-50 p-2 rounded mt-2"><strong>R√©ponse mairie:</strong> ${sig.retour_mairie}</div>` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function showNewSignalementChef() {
            // Cr√©er un modal pour nouveau signalement chef de quartier
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-2xl w-full">
                    <h2 class="text-xl font-bold mb-4">Nouveau Signalement</h2>
                    <form id="chefSignalementForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Quartier</label>
                            <input type="text" name="nom_quartier" required class="w-full border rounded p-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Type</label>
                            <select name="type_signalement" required class="w-full border rounded p-2">
                                <option value="besoin_infrastructure">Besoin infrastructure</option>
                                <option value="probleme_securite">Probl√®me s√©curit√©</option>
                                <option value="evenement_social">√âv√©nement social</option>
                                <option value="demande_collective">Demande collective</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Description</label>
                            <textarea name="description_detaillee" rows="4" required class="w-full border rounded p-2"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Urgence</label>
                            <select name="urgence" required class="w-full border rounded p-2">
                                <option value="basse">Basse</option>
                                <option value="moyenne">Moyenne</option>
                                <option value="haute">Haute</option>
                                <option value="critique">Critique</option>
                            </select>
                        </div>
                        <div class="flex gap-3">
                            <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white p-2 rounded">Annuler</button>
                            <button type="submit" class="flex-1 bg-blue-600 text-white p-2 rounded">Envoyer</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('chefSignalementForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                
                try {
                    const result = await apiCall('chefs_quartier.php', 'POST', Object.fromEntries(formData));
                    
                    if (result.success) {
                        showNotification('Signalement envoy√©', 'success');
                        modal.remove();
                        loadChefQuartierData();
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                    showNotification('Erreur lors de l\'envoi', 'error');
                }
            });
        }
        
        // Fonction utilitaire pour formater l'argent
        function formatMoney(amount) {
            if (!amount) return '0 FCFA';
            return new Intl.NumberFormat('fr-FR', { 
                style: 'currency', 
                currency: 'XAF',
                minimumFractionDigits: 0 
            }).format(amount).replace('XAF', 'FCFA');
        }
        

        // Initialisation
        // ========== NOUVELLES FONCTIONS POUR LES MODALS ==========
        
        // Modal Profil Utilisateur
        function showProfil() {
            const modal = document.getElementById('profilModal');
            modal.classList.remove('hidden');
            
            if (currentUser) {
                document.getElementById('profilNom').value = currentUser.name || '';
                document.getElementById('profilTelephone').value = currentUser.telephone || '';
                document.getElementById('profilEmail').value = currentUser.email || '';
                document.getElementById('profilLocalisation').value = currentUser.location || '';
            }
        }
        
        // Gestion du formulaire de profil
        document.getElementById('profilForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const nom = document.getElementById('profilNom').value.trim();
            const telephone = document.getElementById('profilTelephone').value.trim();
            const email = document.getElementById('profilEmail').value.trim();
            const localisation = document.getElementById('profilLocalisation').value.trim();
            const oldPassword = document.getElementById('profilPasswordOld').value;
            const newPassword = document.getElementById('profilPasswordNew').value;
            const confirmPassword = document.getElementById('profilPasswordConfirm').value;
            
            if (!nom || !telephone) {
                showNotification('Le nom et le t√©l√©phone sont obligatoires', 'error');
                return;
            }
            
            if (newPassword && newPassword.length < 6) {
                showNotification('Le nouveau mot de passe doit contenir au moins 6 caract√®res', 'error');
                return;
            }
            
            if (newPassword && newPassword !== confirmPassword) {
                showNotification('Les mots de passe ne correspondent pas', 'error');
                return;
            }
            
            try {
                const updateData = {
                    nom: nom,
                    telephone: telephone,
                    email: email || null,
                    localisation: localisation || null
                };
                
                if (oldPassword && newPassword) {
                    updateData.ancien_mot_de_passe = oldPassword;
                    updateData.nouveau_mot_de_passe = newPassword;
                }
                
                const result = await apiCall('users.php', 'PUT', updateData);
                
                if (result.success) {
                    currentUser = result.data;
                    updateUserInfo();
                    showNotification('Profil mis √† jour avec succ√®s', 'success');
                    closeModal('profilModal');
                    
                    // R√©initialiser les champs de mot de passe
                    document.getElementById('profilPasswordOld').value = '';
                    document.getElementById('profilPasswordNew').value = '';
                    document.getElementById('profilPasswordConfirm').value = '';
                }
            } catch (error) {
                showNotification('Erreur lors de la mise √† jour : ' + error.message, 'error');
            }
        });
        
        // Modal Statistiques D√©taill√©es
        async function showStatistiques() {
            const modal = document.getElementById('statistiquesModal');
            modal.classList.remove('hidden');
            
            try {
                const [demandesResult, signalementsResult] = await Promise.all([
                    apiCall('demandes.php'),
                    apiCall('signalements.php')
                ]);
                
                const demandes = demandesResult.data || [];
                const signalements = signalementsResult.data || [];
                
                // Calculer les statistiques
                const totalDemandes = demandes.length;
                const totalSignalements = signalements.length;
                const enCours = [...demandes, ...signalements].filter(d => d.statut === 'en_cours' || d.statut === 'en_attente').length;
                const resolus = [...demandes, ...signalements].filter(d => d.statut === 'valide' || d.statut === 'resolu').length;
                
                document.getElementById('statTotalDemandes').textContent = totalDemandes;
                document.getElementById('statTotalSignalements').textContent = totalSignalements;
                document.getElementById('statEnCours').textContent = enCours;
                document.getElementById('statResolus').textContent = resolus;
                
                // Cr√©er les graphiques
                createStatCharts(demandes, signalements);
            } catch (error) {
                console.error('Erreur chargement statistiques:', error);
                showNotification('Erreur lors du chargement des statistiques', 'error');
            }
        }
        
        function createStatCharts(demandes, signalements) {
            // Graphique par type
            const ctxType = document.getElementById('statChartType');
            if (ctxType) {
                const typeData = {};
                [...demandes, ...signalements].forEach(item => {
                    const type = item.type || item.categorie || 'Autre';
                    typeData[type] = (typeData[type] || 0) + 1;
                });
                
                new Chart(ctxType, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(typeData),
                        datasets: [{
                            data: Object.values(typeData),
                            backgroundColor: [
                                '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            // Graphique d'√©volution
            const ctxEvolution = document.getElementById('statChartEvolution');
            if (ctxEvolution) {
                const mois = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Ao√ª', 'Sep', 'Oct', 'Nov', 'D√©c'];
                const evolution = new Array(12).fill(0);
                
                [...demandes, ...signalements].forEach(item => {
                    const date = new Date(item.date_creation || item.date_signalement);
                    const moisIndex = date.getMonth();
                    evolution[moisIndex]++;
                });
                
                new Chart(ctxEvolution, {
                    type: 'line',
                    data: {
                        labels: mois,
                        datasets: [{
                            label: 'Nombre',
                            data: evolution,
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }
        
        // Modal Gestion Utilisateurs
        async function showGestionUtilisateurs() {
            const modal = document.getElementById('gestionUtilisateursModal');
            modal.classList.remove('hidden');
            await loadUtilisateurs();
        }
        
        async function loadUtilisateurs() {
            try {
                const result = await apiCall('users.php');
                const users = result.data || [];
                
                const container = document.getElementById('utilisateursList');
                const searchTerm = document.getElementById('searchUsers')?.value.toLowerCase() || '';
                const filterRole = document.getElementById('filterUsersRole')?.value || '';
                
                let filteredUsers = users.filter(user => {
                    const matchSearch = !searchTerm || 
                        (user.name && user.name.toLowerCase().includes(searchTerm)) ||
                        (user.telephone && user.telephone.includes(searchTerm));
                    const matchRole = !filterRole || user.role === filterRole;
                    return matchSearch && matchRole;
                });
                
                if (filteredUsers.length === 0) {
                    container.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">Aucun utilisateur trouv√©</td></tr>';
                    return;
                }
                
                let html = '';
                filteredUsers.forEach(user => {
                    const statutClass = user.statut === 'actif' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    html += `
                        <tr class="hover:bg-gray-50">
                            <td class="border p-3">${user.name || '-'}</td>
                            <td class="border p-3">${user.telephone || '-'}</td>
                            <td class="border p-3">
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">${user.role || '-'}</span>
                            </td>
                            <td class="border p-3">
                                <span class="px-2 py-1 ${statutClass} rounded text-xs">${user.statut || 'inactif'}</span>
                            </td>
                            <td class="border p-3">
                                <button onclick="editUser(${user.id})" class="text-blue-600 hover:text-blue-800 mr-2">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="toggleUserStatus(${user.id}, '${user.statut}')" class="text-${user.statut === 'actif' ? 'red' : 'green'}-600 hover:text-${user.statut === 'actif' ? 'red' : 'green'}-800">
                                    <i class="fas fa-${user.statut === 'actif' ? 'ban' : 'check'}"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Erreur chargement utilisateurs:', error);
                document.getElementById('utilisateursList').innerHTML = 
                    '<tr><td colspan="5" class="text-center py-8 text-red-500">Erreur lors du chargement</td></tr>';
            }
        }
        
        // Recherche et filtrage utilisateurs
        document.getElementById('searchUsers')?.addEventListener('input', loadUtilisateurs);
        document.getElementById('filterUsersRole')?.addEventListener('change', loadUtilisateurs);
        
        // Modal Suivi Demande
        async function showSuiviDemande(demandeId) {
            const modal = document.getElementById('suiviDemandeModal');
            modal.classList.remove('hidden');
            
            try {
                const result = await apiCall(`demandes.php?id=${demandeId}`);
                const demande = result.data;
                
                if (!demande) {
                    showNotification('Demande non trouv√©e', 'error');
                    return;
                }
                
                document.getElementById('suiviDemandeId').textContent = `#${demande.id}`;
                document.getElementById('suiviDemandeType').textContent = demande.type || '-';
                document.getElementById('suiviDemandeService').textContent = demande.service || '-';
                document.getElementById('suiviDemandeDate').textContent = new Date(demande.date_creation).toLocaleDateString('fr-FR');
                document.getElementById('suiviDemandeMontant').textContent = (demande.montant || 0).toLocaleString() + ' FCFA';
                
                const statutClass = {
                    'en_attente': 'bg-yellow-100 text-yellow-800',
                    'en_cours': 'bg-blue-100 text-blue-800',
                    'valide': 'bg-green-100 text-green-800',
                    'rejete': 'bg-red-100 text-red-800'
                }[demande.statut] || 'bg-gray-100 text-gray-800';
                
                document.getElementById('suiviDemandeStatut').textContent = demande.statut || '-';
                document.getElementById('suiviDemandeStatut').className = `px-3 py-1 rounded-full text-sm font-semibold ${statutClass}`;
                
                // Historique (simul√© - √† adapter selon votre structure)
                const historique = document.getElementById('suiviDemandeHistorique');
                historique.innerHTML = `
                    <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                        <div class="w-2 h-2 bg-green-500 rounded-full mt-2"></div>
                        <div class="flex-1">
                            <p class="font-semibold">Demande cr√©√©e</p>
                            <p class="text-sm text-gray-600">${new Date(demande.date_creation).toLocaleString('fr-FR')}</p>
                        </div>
                    </div>
                    ${demande.date_modification ? `
                    <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                        <div class="w-2 h-2 bg-blue-500 rounded-full mt-2"></div>
                        <div class="flex-1">
                            <p class="font-semibold">Statut modifi√©</p>
                            <p class="text-sm text-gray-600">${new Date(demande.date_modification).toLocaleString('fr-FR')}</p>
                        </div>
                    </div>
                    ` : ''}
                `;
            } catch (error) {
                console.error('Erreur chargement suivi:', error);
                showNotification('Erreur lors du chargement du suivi', 'error');
            }
        }
        
        // Modal Recherche Avanc√©e
        function showRecherche() {
            document.getElementById('rechercheModal').classList.remove('hidden');
        }
        
        async function executerRecherche() {
            const type = document.getElementById('rechercheType').value;
            const dateDebut = document.getElementById('rechercheDateDebut').value;
            const dateFin = document.getElementById('rechercheDateFin').value;
            const statut = document.getElementById('rechercheStatut').value;
            const motsCles = document.getElementById('rechercheMotsCles').value;
            
            try {
                let url = `${type}.php?`;
                const params = [];
                if (dateDebut) params.push(`date_debut=${dateDebut}`);
                if (dateFin) params.push(`date_fin=${dateFin}`);
                if (statut) params.push(`statut=${statut}`);
                if (motsCles) params.push(`search=${encodeURIComponent(motsCles)}`);
                
                url += params.join('&');
                
                const result = await apiCall(url);
                const data = result.data || [];
                
                const container = document.getElementById('rechercheResultatsList');
                const resultatsDiv = document.getElementById('rechercheResultats');
                
                if (data.length === 0) {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">Aucun r√©sultat trouv√©</div>';
                } else {
                    let html = '';
                    data.forEach(item => {
                        html += `
                            <div class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                                <h4 class="font-semibold">${item.type || item.categorie || 'Item'}</h4>
                                <p class="text-sm text-gray-600 mt-1">${item.description || item.motif || ''}</p>
                                <p class="text-xs text-gray-500 mt-2">${new Date(item.date_creation || item.date_signalement).toLocaleDateString('fr-FR')}</p>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                }
                
                resultatsDiv.classList.remove('hidden');
            } catch (error) {
                console.error('Erreur recherche:', error);
                showNotification('Erreur lors de la recherche', 'error');
            }
        }
        
        // ========== FIN NOUVELLES FONCTIONS ==========
        
        // Initialiser Supabase
        function initSupabase() {
            if (typeof supabase !== 'undefined') {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase initialis√©');
            } else {
                console.warn('Supabase JS non charg√©');
            }
        }
        
        // Fonction helper pour les appels Supabase
        async function supabaseCall(table, method = 'SELECT', data = null, filters = {}) {
            if (!supabaseClient) {
                initSupabase();
            }
            
            if (!supabaseClient) {
                throw new Error('Supabase non initialis√©');
            }
            
            try {
                let query = supabaseClient.from(table);
                
                // Appliquer les filtres
                for (const [key, value] of Object.entries(filters)) {
                    query = query.eq(key, value);
                }
                
                switch (method.toUpperCase()) {
                    case 'SELECT':
                    case 'GET':
                        const { data: result, error } = await query.select();
                        if (error) throw error;
                        return { success: true, data: result };
                        
                    case 'INSERT':
                    case 'POST':
                        const { data: insertData, error: insertError } = await supabaseClient
                            .from(table)
                            .insert(data)
                            .select();
                        if (insertError) throw insertError;
                        return { success: true, data: insertData };
                        
                    case 'UPDATE':
                    case 'PUT':
                    case 'PATCH':
                        let updateQuery = supabaseClient.from(table).update(data);
                        for (const [key, value] of Object.entries(filters)) {
                            updateQuery = updateQuery.eq(key, value);
                        }
                        const { data: updateData, error: updateError } = await updateQuery.select();
                        if (updateError) throw updateError;
                        return { success: true, data: updateData };
                        
                    case 'DELETE':
                        let deleteQuery = supabaseClient.from(table).delete();
                        for (const [key, value] of Object.entries(filters)) {
                            deleteQuery = deleteQuery.eq(key, value);
                        }
                        const { error: deleteError } = await deleteQuery;
                        if (deleteError) throw deleteError;
                        return { success: true, data: null };
                        
                    default:
                        throw new Error('M√©thode non support√©e: ' + method);
                }
            } catch (error) {
                console.error('Erreur Supabase:', error);
                return { success: false, error: error.message };
            }
        }
        
        // Fonction d'inscription avec Supabase
        async function registerWithSupabase(registerData) {
            if (!supabaseClient) {
                initSupabase();
            }
            
            if (!supabaseClient) {
                throw new Error('Supabase non initialis√©');
            }
            
            try {
                // V√©rifier si le t√©l√©phone existe d√©j√†
                const { data: existingUsers, error: checkError } = await supabaseClient
                    .from('utilisateurs')
                    .select('id')
                    .eq('telephone', registerData.telephone)
                    .limit(1);
                
                if (checkError) throw checkError;
                
                if (existingUsers && existingUsers.length > 0) {
                    throw new Error('Ce num√©ro de t√©l√©phone est d√©j√† utilis√©');
                }
                
                // Hasher le mot de passe (on doit le faire c√¥t√© serveur normalement, mais pour Supabase on peut utiliser une fonction Edge Function)
                // Pour l'instant, on va utiliser une approche diff√©rente - cr√©er l'utilisateur via l'API PHP si disponible
                // Sinon, on peut utiliser Supabase Auth ou cr√©er directement dans la table
                
                // G√©n√©rer un email factice
                const email = 'user_' + registerData.telephone.replace(/\D/g, '') + '@ecityzen.ga';
                
                // Pr√©parer les donn√©es utilisateur
                const userData = {
                    nom: registerData.nom,
                    email: email,
                    telephone: registerData.telephone,
                    role: registerData.role,
                    mot_de_passe: registerData.mot_de_passe, // Note: En production, hash c√¥t√© serveur
                    statut: 'actif'
                };
                
                if (registerData.localisation) userData.localisation = registerData.localisation;
                if (registerData.latitude) userData.latitude = parseFloat(registerData.latitude);
                if (registerData.longitude) userData.longitude = parseFloat(registerData.longitude);
                if (registerData.entreprise) userData.entreprise = registerData.entreprise;
                if (registerData.secteur) userData.secteur = registerData.secteur;
                
                // Ins√©rer l'utilisateur
                const { data: newUser, error: insertError } = await supabaseClient
                    .from('utilisateurs')
                    .insert(userData)
                    .select()
                    .single();
                
                if (insertError) {
                    throw new Error(insertError.message || 'Erreur lors de la cr√©ation du compte');
                }
                
                // Formater la r√©ponse comme l'API PHP
                return {
                    success: true,
                    data: {
                        id: newUser.id,
                        name: newUser.nom,
                        telephone: newUser.telephone,
                        email: newUser.email,
                        role: newUser.role,
                        location: newUser.localisation || null,
                        sector: newUser.secteur || null,
                        business: newUser.entreprise || null
                    },
                    message: 'Compte cr√©√© avec succ√®s'
                };
                
            } catch (error) {
                console.error('Erreur inscription Supabase:', error);
                throw error;
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('e-cityzen Gabon charg√© avec succ√®s');
            
            // Initialiser Supabase
            initSupabase();
            
            // V√©rifier si on est en mode file:// (pas de serveur web)
            if (window.location.protocol === 'file:') {
                const errorMsg = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; background: #ef4444; color: white; padding: 20px; z-index: 10000; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <h2 style="margin: 0 0 10px 0; font-size: 20px;">‚ö†Ô∏è Erreur de Configuration</h2>
                        <p style="margin: 0 0 15px 0; font-size: 16px;">
                            Vous devez acc√©der √† l'application via WAMP Server, pas directement depuis le fichier.
                        </p>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <p style="margin: 5px 0; font-weight: bold;">Instructions :</p>
                            <ol style="text-align: left; max-width: 600px; margin: 10px auto; padding-left: 20px;">
                                <li>Assurez-vous que WAMP est d√©marr√© (ic√¥ne verte dans la barre des t√¢ches)</li>
                                <li>Placez ce dossier dans <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px;">C:\\wamp64\\www\\Ecityzen\\</code></li>
                                <li>Acc√©dez √† l'application via : <a href="http://localhost/Ecityzen/ECITYZEN.html" style="color: #fbbf24; text-decoration: underline; font-weight: bold;">http://localhost/Ecityzen/ECITYZEN.html</a></li>
                            </ol>
                        </div>
                        <button onclick="window.location.href='http://localhost/Ecityzen/ECITYZEN.html'" style="background: white; color: #ef4444; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 14px; margin-top: 10px;">
                            Ouvrir via WAMP
                        </button>
                    </div>
                `;
                document.body.insertAdjacentHTML('afterbegin', errorMsg);
                return;
            }
            
            // V√©rifier la connexion API seulement si on est sur un serveur web
            // Test simple de connexion √† la base de donn√©es
            const testEndpoint = !API_BASE_URL 
                ? '/.netlify/functions/login'
                : `${API_BASE_URL}/login.php`;
            
            fetch(testEndpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ telephone: '+24100000000', mot_de_passe: 'test' })
            })
                .then(response => {
                    // Une r√©ponse 401 est normale (identifiants invalides) et signifie que l'API fonctionne
                    if (response.status === 401 || response.ok) {
                        console.log('API connect√©e');
                    } else {
                        console.warn('API r√©pond avec un code inattendu:', response.status);
                    }
                })
                .catch(error => {
                    // Ignorer les erreurs r√©seau silencieusement si l'API n'est pas disponible
                    // Ne pas afficher d'erreur pour les 401 qui sont normaux
                });
        });
    </script>
</body>
</html>
